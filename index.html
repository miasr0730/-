<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v2.8 - Total Integrated Alpha</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --success: #1e8e3e; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 100px; }
        .thumb-wrapper { position: relative; min-width: 90px; height: 90px; background: #fff; border-radius: 8px; border: 2px solid #dadce0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .del-btn { position: absolute; top: 2px; right: 2px; width: 20px; height: 20px; background: rgba(217, 48, 37, 0.9); color: white; border: none; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 25px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; background: #e8f0fe; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 18px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .analyze-btn:disabled { background: #ccc; cursor: not-allowed; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        #logArea { background: #202124; color: #34a853; font-family: 'Courier New', monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 180px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; border-left: 5px solid var(--primary); }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .summary-table th { background: #f8f9fa; color: #5f6368; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" style="width:100%; padding:12px; border:1px solid #dadce0; border-radius:8px; box-sizing:border-box;" placeholder="Gemini API Keyã‚’å…¥åŠ›">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢æ’®å½±ãƒ»è§£æ (è¤‡åˆãƒ»çµ±åˆãƒ¢ãƒ¼ãƒ‰)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“· å›³é¢ã‚’è¿½åŠ  (å¹³é¢ãƒ»ç«‹é¢ã‚’æ¨å¥¨)
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">çµ±åˆè§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ  çµ±åˆå±‹æ ¹æŠ•å½±å›³</h1>
    <div id="slopeInfo" class="status-badge" style="background:var(--success); color:white;"></div>
    <canvas id="masterCanvas"></canvas>
    <div id="summaryArea"></div>
</div>

<div class="card">
    <h1>ğŸ§  è§£æãƒ­ã‚¸ãƒƒã‚¯ãƒ»è¨ˆç®—ãƒ­ã‚°</h1>
    <div id="logArea">å›³é¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„...</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];

    // ç”»åƒè¿½åŠ å‡¦ç†ã®ä¿®æ­£
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (event) => {
                selectedFiles.push({ file, preview: event.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        e.target.value = ""; // ãƒªã‚»ãƒƒãƒˆ
    });

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            if (item.file.type.includes('image')) {
                div.innerHTML = `<img src="${item.preview}"><button class="del-btn" data-index="${i}">Ã—</button>`;
            } else {
                div.innerHTML = `<span>PDF Document</span><button class="del-btn" data-index="${i}">Ã—</button>`;
            }
            container.appendChild(div);
        });
    }

    // å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²
    document.getElementById('previewContainer').addEventListener('click', (e) => {
        if (e.target.classList.contains('del-btn')) {
            const idx = e.target.getAttribute('data-index');
            selectedFiles.splice(idx, 1);
            renderPreviews();
        }
    });

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('analyzeBtn');
        const logArea = document.getElementById('logArea');
        btn.disabled = true;
        logArea.innerText = "--- çµ±åˆè§£æã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹ ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-1.5-flash", 
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å»ºç¯‰å›³é¢ãƒ»è¤‡åˆå±‹æ ¹çµ±åˆè§£æãƒ—ãƒ­ãƒˆã‚³ãƒ« (v2.8)
## ãƒŸãƒƒã‚·ãƒ§ãƒ³:
å›³é¢å†…ã®å…¨å±‹æ ¹è¦ç´ ã‚’æŠ½å‡ºã—ã€ãã‚Œã‚‰ã‚’ä¸€ã¤ã®åº§æ¨™ç³»ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ—ãƒ©ãƒ³ï¼‰ã«çµ±åˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã›ã‚ˆã€‚

## å³å®ˆãƒ«ãƒ¼ãƒ«:
1. ã€å±…å®¤ç¢ºèªã€‘: å¤ªç·šã®å†…å´ã« LDK/æ´‹å®¤/å’Œå®¤/ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ/ã‚µãƒƒã‚· ç­‰ã®è¡¨è¨˜ãŒã‚ã‚‹ã‹ç¢ºèªã€‚ã“ã‚ŒãŒã‚ã‚‹å£ã¯ã€Œå±‹å†…ã€ã¨ã—ã€ãã®ä¸Šéƒ¨ã¯å±‹æ ¹ãŒå¿…è¦ãªã‚¨ãƒªã‚¢ã¨åˆ¤å®šã›ã‚ˆã€‚
2. ã€å‹¾é…è‡ªå‹•å–å¾—ã€‘: å›³é¢å†…ã®ã€Œå¯¸ã€ã¾ãŸã¯ã€Œ/10ã€è¡¨è¨˜ã€ã‚ã‚‹ã„ã¯ç«‹é¢å›³ã®å‹¾é…ã‚µã‚¤ãƒ³ã‹ã‚‰æ•°å€¤ã‚’èª­ã¿å–ã‚Œã€‚
3. ã€æµã‚Œæ–¹å‘ã®ç®—å‡ºã€‘: æ°´å¹³æŠ•å½±è·é›¢ã«å¯¾ã—ã€æ¤œå‡ºã—ãŸå‹¾é…ã®å€ç‡ã‚’ä¹—ã˜ã¦ã€Œå®Ÿå¯¸ã®æµã‚Œé•·ã•ã€ã‚’ç®—å‡ºã›ã‚ˆã€‚
4. ã€åº§æ¨™çµ±åˆã€‘: å»ºç‰©å…¨ä½“ã®åŒ—è¥¿ç«¯ã‚’(0,0)ã¨ã—ã€å„å±‹æ ¹ãƒ‘ãƒ¼ãƒ„ã®é…ç½®åº§æ¨™(pos_x, pos_y)ã‚’ç®—å‡ºã›ã‚ˆã€‚

## å‡ºåŠ›å½¢å¼(JSON):
{
  "detected_slope": "3.5å¯¸",
  "total_width_mm": å»ºç‰©å…¨ä½“ã®å¹…,
  "total_depth_mm": å»ºç‰©å…¨ä½“ã®å¥¥è¡Œ,
  "planes": [
    {
      "name": "ä¸»å±‹æ ¹ / ä¸‹å±‹ / ç„é–¢ãƒãƒ¼ãƒç­‰",
      "pos_x": 0, "pos_y": 0,
      "width_mm": 11475, "depth_mm": 7280,
      "shape": "å¯„æ£Ÿ/åˆ‡å¦»/ç‰‡æµã‚Œ",
      "flow_length_mm": æµã‚Œæ–¹å‘ã®å‚ç›´å®Ÿå¯¸,
      "ridge_mm": å¤§æ£Ÿé•·ã•,
      "reasoning": "å±…å®¤è¡¨è¨˜ç­‰ã«åŸºã¥ãåˆ¤å®šç†ç”±"
    }
  ],
  "calculation_log": "æ•°å€¤ã®æ‹¾ã„å‡ºã—ã¨åº§æ¨™æ±ºå®šã®ãƒ—ãƒ­ã‚»ã‚¹"
}`;

            const parts = await Promise.all(selectedFiles.map(async item => {
                const base64 = item.preview.split(',')[1];
                return { inlineData: { data: base64, mimeType: item.file.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            logArea.innerText = data.calculation_log;
            renderAll(data);
            document.getElementById('resultCard').style.display = 'block';

        } catch (e) { logArea.innerText += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`; }
        finally { btn.disabled = false; }
    };

    function renderAll(data) {
        document.getElementById('slopeInfo').innerText = `æ¤œçŸ¥å‹¾é…: ${data.detected_slope}`;
        const canvas = document.getElementById('masterCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 1000; canvas.height = 600;
        
        const pad = 60;
        const scale = Math.min((canvas.width - pad*2) / data.total_width_mm, (canvas.height - pad*2) / data.total_depth_mm);

        ctx.clearRect(0,0,1000,600);
        
        data.planes.forEach(p => {
            const x = pad + p.pos_x * scale;
            const y = pad + p.pos_y * scale;
            const w = p.width_mm * scale;
            const h = p.depth_mm * scale;

            // å¡—ã‚Šã¤ã¶ã—
            ctx.fillStyle = "rgba(26, 115, 232, 0.08)";
            ctx.fillRect(x, y, w, h);
            
            // å¤–æ 
            ctx.strokeStyle = "#1a73e8";
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);

            // ç°¡æ˜“ä¼å›³ãƒ©ã‚¤ãƒ³ï¼ˆå¯„æ£Ÿç­‰ã®æ§‹é€ ç·šï¼‰
            ctx.beginPath();
            ctx.lineWidth = 1.5;
            if(p.shape.includes("å¯„æ£Ÿ")) {
                const off = (w - (p.ridge_mm * scale)) / 2;
                ctx.moveTo(x, y); ctx.lineTo(x + off, y + h/2); ctx.lineTo(x, y + h);
                ctx.moveTo(x + w, y); ctx.lineTo(x + w - off, y + h/2); ctx.lineTo(x + w, y + h);
                ctx.moveTo(x + off, y + h/2); ctx.lineTo(x + w - off, y + h/2);
            } else if(p.shape.includes("åˆ‡å¦»")) {
                ctx.moveTo(x, y + h/2); ctx.lineTo(x + w, y + h/2);
            }
            ctx.stroke();

            // å¯¸æ³•ãƒ†ã‚­ã‚¹ãƒˆ
            ctx.fillStyle = "#1a73e8";
            ctx.font = "bold 14px sans-serif";
            ctx.fillText(`${p.name}: ${p.width_mm}Ã—${p.depth_mm}`, x, y - 10);
        });

        // ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ
        let html = `<table class="summary-table"><tr><th>æ§‹æˆéƒ¨ä½</th><th>æ±è¥¿(X)</th><th>å—åŒ—(Y)</th><th>æµã‚Œ(å‚ç›´)</th><th>å¤§æ£Ÿ</th></tr>`;
        data.planes.forEach(p => {
            html += `<tr><td>${p.name}</td><td>${p.width_mm}mm</td><td>${p.depth_mm}mm</td><td><strong>${p.flow_length_mm}mm</strong></td><td>${p.ridge_mm}mm</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('summaryArea').innerHTML = html;
    }
</script>
</body>
</html>
