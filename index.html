// ... (前略：HTML/CSS部分は同じです) ...

    async function runAI() {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) return alert("APIキーを入力してください");
        
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.style.color = "#c2410c"; // オレンジ
        status.innerHTML = `画像${allFiles.length}枚を統合して解析中... <span class='loading'></span>`;
        document.getElementById('result-area').style.display = 'none';

        try {
            // 画像のリサイズ処理（少し小さめにして転送を速くします）
            const imagePromises = allFiles.map(file => resizeImage(file, 1000)); 
            const base64Images = await Promise.all(imagePromises);
            
            const prompt = "（中略：プロンプト内容は以前と同じ）";

            const contentParts = [{ text: prompt }];
            base64Images.forEach(b64 => {
                contentParts.push({ inline_data: { mime_type: "image/jpeg", data: b64.split(',')[1] } });
            });

            // タイムアウト設定を追加（2分で打ち切り）
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 120000);

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${FIXED_MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] }),
                signal: controller.signal
            });

            clearTimeout(timeoutId);

            const data = await response.json();

            // --- エラー診断表示を追加 ---
            if (data.error) {
                if (data.error.message.includes("API key not valid")) {
                    throw new Error("APIキーが正しくありません。コピーミスがないか確認してください。");
                } else if (data.error.code === 429) {
                    throw new Error("リクエスト回数制限（無料枠）を超えました。少し待ってからお試しください。");
                } else {
                    throw new Error("Google APIエラー: " + data.error.message);
                }
            }
            
            if (!data.candidates || data.candidates.length === 0) {
                throw new Error("AIから回答が得られませんでした。画像の内容が判別できない可能性があります。");
            }

            const rawText = data.candidates[0].content.parts[0].text;
            // ... (後略：結果表示処理は同じ) ...

        } catch (e) {
            console.error(e);
            status.style.color = "red";
            if (e.name === 'AbortError') {
                status.innerHTML = `❌ タイムアウト：通信に時間がかかりすぎました。画像の枚数を減らすか、電波の良い場所で試してください。`;
            } else {
                status.innerHTML = `❌ エラー発生：${e.message}`;
            }
        }
    }
