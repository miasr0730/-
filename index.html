<div class="card">

    <label>🏠 屋根形状を選択:</label>

    <select id="roofType" class="select-style">

        <option value="寄棟">寄棟 (Hip)</option>

        <option value="切妻">切妻 (Gable)</option>

        <option value="片流れ">片流れ (Shed)</option>

        <option value="方形">方形 (Pyramid)</option>

        <option value="陸屋根">陸屋根 (Flat)</option>

        <option value="腰折">腰折 (Gambrel)</option>

        <option value="入母屋">入母屋 (Irimoya)</option>

        <option value="半切妻">半切妻 (Jerkinhead)</option>

        <option value="複合屋根" selected>複合屋根 (Complex)</option>

    </select>

</div>



<script>

// 形状別・追加制約 (v4.6)

const shapeConstraints = {

    "寄棟": "屋根面を4つ（台形2、三角2）に分離。中央の大棟と4隅の隅棟を定義せよ。",

    "切妻": "屋根面を2つの長方形に分離。妻側の『けらば出』を厳密に加算せよ。",

    "片流れ": "1つの長方形。最高部(水上)と最低部(水下)を特定せよ。",

    "方形": "4つの三角形が1点に集まる。隅棟4本の長さを均等に算出せよ。",

    "陸屋根": "水平面。パラペット内寸と、必要であれば排水勾配を考慮せよ。",

    "腰折": "1面の中で勾配が変化する。折れ点（境界線）の座標を特定せよ。",

    "入母屋": "上部を切妻、下部を寄棟状のスカートとして複合定義せよ。",

    "半切妻": "切妻の妻側上部を斜めに切り落とした（はしょった）形状を再現せよ。",

    "複合屋根": "段違いやL字形状を独立したN個の多角形として定義せよ。"

};



document.getElementById('analyzeBtn').onclick = async () => {

    const selectedRoofType = document.getElementById('roofType').value;

    

    const finalPrompt = `

# 屋根積算精密アルゴリズム v4.6 (厳格ロジック統合版)

あなたは屋根積算のエキスパートとして、以下のステップを**「順守」**せよ。



#### Step 0: 屋根が必要な「壁芯」の厳格特定 (最優先)

- 平面図の太線付近の注記（LDK/洋室/和室/収納/サッシ/開口部等）をスキャンせよ。

- **【屋内確定ルール】**：上記注記がある壁は「屋内」であり、屋根を載せるべき土台（壁芯）と見なす。

- **【ベランダ除外ルール】**：「ベランダ」「バルコニー」「吹き抜け」は、必ず立面図と照合せよ。屋根が被っていない（空が見える）場合は、屋根面積に含めてはならない。



#### Step 1: 寸法線の階層解析 (数値取得の厳格化)

- **【一番内側の数値ルール】**：平面図の枠外にある寸法線のうち、**「最も建物に近い（一番内側の）数値」**を壁芯寸法として採用せよ。

- **【合算禁止ルール】**：外側にある「合計値」や、別階（バルコニー突出部等）の数値を二重に足すミスを厳禁とする。

- 例: Y軸の内側が 1800, 1800, 900 なら、その合計 4500mm のみを使え。



#### Step 2: 軒の出の全周加算

- 立面図から「軒の出(eaves)」を特定（例: 275mm）。

- 屋根外寸 = Step1で特定した壁芯合計 + (軒の出 × 2)。



#### Step 3: 形状別・幾何計算

- 選択された形状: ${selectedRoofType}

- ${shapeConstraints[selectedRoofType]}

- 全ての辺に対し、「水平投影図(Plan)」と「勾配実寸(Actual)」を算出し、座標(vertices)を定義せよ。



出力形式(JSON):

{

  "detected_slope": 3.5,

  "planes": [

    {

      "name": "面名",

      "vertices": [{"x": 0, "y": 0}, ...],

      "edges": [{"from": 0, "to": 1, "label": "軒先", "len_plan": 5000, "len_actual": 5000}],

      "center_label": "流れ実寸: ○○mm"

    }

  ],

  "step_logs": "1. 内側寸法より壁芯4500を確認。 2. 軒の出275×2を加算し外寸5050を算出..."

}`;



    // --- 以下、座標描画エンジン(renderComplexRoof)へ続く ---

    // (描画ロジックは前回の座標ベースのものをそのまま使用)

};

</script>
