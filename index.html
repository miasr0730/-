<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v3.5 - 4-Plane Precision Overlay</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { position: relative; min-width: 80px; height: 80px; background: #eee; border-radius: 8px; border: 1px solid #dadce0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        .res-label { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--error); }
        #formulaText { font-size: 0.85rem; line-height: 1.6; background: #f1f3f4; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" style="width:100%; padding:12px; border:1px solid #dadce0; border-radius:8px; box-sizing:border-box;" placeholder="Gemini API Key">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢ç²¾å¯†è§£æ (v3.5 4é¢å€‹åˆ¥å¯¸æ³•ãƒ»å®Œå…¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">ç²¾å¯†è§£æãƒ»å…¨å‘¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š è§£æçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h1>
    <div>
        <span class="res-label bg-blue">ã€å¹³é¢æŠ•å½±å›³ã€‘æ°´å¹³å¯¸æ³• (èŠ¯èŠ¯ï¼‹è»’Ã—2)</span>
        <canvas id="planCanvas"></canvas>
    </div>
    <div>
        <span class="res-label bg-red" id="slopeLabel">ã€å®Ÿå¯¸æ³•å›³ã€‘å‹¾é…å€ç‡é©ç”¨</span>
        <canvas id="slopeCanvas"></canvas>
    </div>
    <div id="formulaText"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedFiles.push({ file, data: ev.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = "";
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.innerHTML = f.file.type.includes('image') ? `<img src="${f.data}">` : `ğŸ“„ PDF`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview", 
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å±‹æ ¹ç©ç®—ç²¾å¯†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (v3.5 è¨˜æ†¶å›ºå®šç‰ˆ)

#### Step 0: å±…å®¤åŸºæº–ã®å£ç‰¹å®š
- å¹³é¢å›³ã‹ã‚‰ã€Œå±…å®¤ï¼ˆLDKãƒ»æ´‹å®¤ç­‰ï¼‰ã€ã‚’å›²ã‚€ã€Œä¸»ãŸã‚‹å£èŠ¯ã€ã‚’ç‰¹å®šã›ã‚ˆã€‚
- ãƒãƒ«ã‚³ãƒ‹ãƒ¼ç­‰ã®çªå‡ºéƒ¨ã¯ã€ç«‹é¢å›³ã§å±‹æ ¹ãŒè¢«ã£ã¦ã„ãªã„é™ã‚Šé™¤å¤–ã›ã‚ˆã€‚

#### Step 1: æ•°å€¤ã®å³æ ¼æŠ½å‡º (ãƒ–ãƒ¬é˜²æ­¢ç­–)
- å¹³é¢å›³ã®å¯¸æ³•ç·šã®ã†ã¡ã€Œæœ€ã‚‚å†…å´ã®æ•°å€¤ã€ã‚’åˆè¨ˆã›ã‚ˆã€‚
- ä¾‹: Yè»¸ãŒ 1800+1800+900 ãªã‚‰ 4500mmã€‚å¤–å´ã®ç„¡é–¢ä¿‚ãªæ•°å€¤ã‚’è¶³ã•ãªã„ã“ã¨ã€‚

#### Step 2: è»’ã®å‡ºã®å…¨å‘¨åŠ ç®—
- ç«‹é¢å›³ã‹ã‚‰ã€Œè»’ã®å‡º(eaves)ã€ã‚’ç‰¹å®šï¼ˆä¾‹: 275mmï¼‰ã€‚
- å¤–å‘¨å¯¸æ³• = å£èŠ¯åˆè¨ˆ + (è»’ã®å‡º Ã— 2)ã€‚
- X(è»’å…ˆæ–¹å‘)ã¨Y(ã‘ã‚‰ã°æ–¹å‘)ã®ä¸¡æ–¹ã«é©ç”¨ã›ã‚ˆã€‚

#### Step 3: å±‹æ ¹é¢ã”ã¨ã®è¨ˆç®—
- å¯„æ£Ÿã®å ´åˆã€å±‹æ ¹é¢ã‚’4ã¤ï¼ˆå—åŒ—ã®å°å½¢ã€æ±è¥¿ã®ä¸‰è§’å½¢ï¼‰ã«åˆ†é›¢ã—ã€ãã‚Œãã‚Œã®å®Ÿå¯¸ã€Œæµã‚Œã€ã¨ã€Œéš…æ£Ÿã€ã‚’ç®—å‡ºã›ã‚ˆã€‚

å‡ºåŠ›å½¢å¼(JSON):
{
  "detected_slope": 3.5,
  "eaves_mm": 275,
  "slope_factor": 1.0595,
  "planes": [
    {
      "name": "ä¸»å±‹æ ¹",
      "width_mm": 11475, "depth_mm": 5050, "ridge_mm": 6425,
      "flow_plane_mm": 2525, 
      "flow_actual_mm": 2675, 
      "hip_actual_mm": 3678,
      "shape": "å¯„æ£Ÿ"
    }
  ],
  "step_logs": "4500(å£èŠ¯)+550(è»’Ã—2)=5050ã‚’ç¢ºèªã€‚å„é¢ã”ã¨ã®å®Ÿå¯¸ã‚’ç®—å‡ºã€‚"
}`;

            const parts = selectedFiles.map(f => ({
                inlineData: { data: f.data.split(',')[1], mimeType: f.file.type }
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('formulaText').innerText = `ã€AIè§£æãƒ­ã‚°ã€‘\n${data.step_logs}`;
            
            drawLayer(data, 'planCanvas', false);
            drawLayer(data, 'slopeCanvas', true);

        } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
        finally { btn.disabled = false; }
    };

    function drawLayer(data, canvasId, isActual) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        canvas.width = 1200; canvas.height = 800;
        
        const p = data.planes[0];
        const scale = Math.min(1000/p.width_mm, 550/p.depth_mm);
        const dw = p.width_mm * scale;
        const dh = p.depth_mm * scale;
        const ox = (1200-dw)/2;
        const oy = (800-dh)/2;
        const color = isActual ? "#d93025" : "#1a73e8";

        ctx.clearRect(0,0,1200,800);
        ctx.strokeStyle = color;
        ctx.lineWidth = 3;

        // 1. å¤–å‘¨ï¼ˆ4è¾ºï¼‰
        ctx.strokeRect(ox, oy, dw, dh);

        // 2. å¯„æ£Ÿæ§‹é€ ï¼ˆå¤§æ£Ÿãƒ»éš…æ£Ÿï¼‰
        const ridge_w = p.ridge_mm * scale;
        const offset = (dw - ridge_w) / 2;
        ctx.beginPath();
        ctx.moveTo(ox, oy); ctx.lineTo(ox + offset, oy + dh/2); // å·¦ä¸Šéš…æ£Ÿ
        ctx.moveTo(ox, oy + dh); ctx.lineTo(ox + offset, oy + dh/2); // å·¦ä¸‹éš…æ£Ÿ
        ctx.moveTo(ox + dw, oy); ctx.lineTo(ox + dw - offset, oy + dh/2); // å³ä¸Šéš…æ£Ÿ
        ctx.moveTo(ox + dw, oy + dh); ctx.lineTo(ox + dw - offset, oy + dh/2); // å³ä¸‹éš…æ£Ÿ
        ctx.moveTo(ox + offset, oy + dh/2); ctx.lineTo(ox + dw - offset, oy + dh/2); // å¤§æ£Ÿ
        ctx.stroke();

        // 3. è£œåŠ©ç‚¹ç·šï¼ˆå„é¢ã®ä¸­å¿ƒã¸ï¼‰
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(ox + dw/2, oy); ctx.lineTo(ox + dw/2, oy + dh); // å‚ç›´
        ctx.moveTo(ox, oy + dh/2); ctx.lineTo(ox + dw, oy + dh/2); // æ°´å¹³
        ctx.stroke();
        ctx.setLineDash([]);

        // 4. ãƒ©ãƒ™ãƒ«æç”»è¨­å®š
        ctx.fillStyle = color;
        ctx.font = "bold 16px sans-serif";
        ctx.textAlign = "center";

        // --- å¤–å‘¨å¯¸æ³• (è»’å…ˆãƒ»ã‘ã‚‰ã°) ---
        ctx.fillText(`è»’å…ˆ: ${p.width_mm}`, ox + dw/2, oy - 15); // ä¸Š
        ctx.fillText(`è»’å…ˆ: ${p.width_mm}`, ox + dw/2, oy + dh + 25); // ä¸‹
        
        ctx.save();
        ctx.translate(ox - 35, oy + dh/2);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(`ã‘ã‚‰ã°: ${p.depth_mm}`, 0, 0); // å·¦
        ctx.restore();

        ctx.save();
        ctx.translate(ox + dw + 35, oy + dh/2);
        ctx.rotate(Math.PI/2);
        ctx.fillText(`ã‘ã‚‰ã°: ${p.depth_mm}`, 0, 0); // å³
        ctx.restore();

        // --- å±‹æ ¹é¢ã”ã¨ã®å¯¸æ³• (4æ–¹å‘) ---
        const flowVal = isActual ? p.flow_actual_mm : p.flow_plane_mm;
        const suffix = isActual ? "å®Ÿå¯¸" : "å¹³é¢";
        
        // ä¸Šãƒ»ä¸‹é¢ï¼ˆå°å½¢éƒ¨åˆ†ã®æµã‚Œï¼‰
        ctx.fillText(`${suffix}: ${flowVal}`, ox + dw/2, oy + dh/4);
        ctx.fillText(`${suffix}: ${flowVal}`, ox + dw/2, oy + (dh*3)/4);

        // å·¦ãƒ»å³é¢ï¼ˆä¸‰è§’å½¢éƒ¨åˆ†ã®æµã‚Œï¼‰
        ctx.font = "14px sans-serif";
        ctx.fillText(`${suffix}: ${flowVal}`, ox + offset/2, oy + dh/2 - 10);
        ctx.fillText(`${suffix}: ${flowVal}`, ox + dw - offset/2, oy + dh/2 - 10);

        if (isActual) {
            // å¤§æ£Ÿå®Ÿå¯¸
            ctx.font = "bold 16px sans-serif";
            ctx.fillText(`å¤§æ£Ÿ: ${p.ridge_mm}`, ox + dw/2, oy + dh/2 - 10);
            
            // éš…æ£Ÿå®Ÿå¯¸ï¼ˆ4ç®‡æ‰€ï¼‰
            ctx.font = "14px sans-serif";
            const h = p.hip_actual_mm;
            ctx.fillText(h, ox + 30, oy + 30);
            ctx.fillText(h, ox + 30, oy + dh - 20);
            ctx.fillText(h, ox + dw - 30, oy + 30);
            ctx.fillText(h, ox + dw - 30, oy + dh - 20);
        }
    }
</script>
</body>
</html>
