<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>屋根積算 2.5 - Debug Mode</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f1f5f9; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #timer { font-family: monospace; color: #2563eb; font-weight: bold; margin: 10px 0; }
        #log { font-size: 12px; color: #64748b; background: #f8fafc; padding: 10px; border-radius: 5px; height: 100px; overflow-y: scroll; margin-bottom: 10px; }
        .btn { width: 100%; padding: 15px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: bold; }
        .loading { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body>

<div class="box">
    <h3>Gemini 2.5 Flash 高速解析</h3>
    <input type="password" id="apiKey" placeholder="APIキーを入力" style="width:100%; padding:10px; margin-bottom:10px;">
    
    <input type="file" id="fileInput" multiple accept="image/*" onchange="updateInfo()">
    <div id="fileCount">選択された画像: 0枚</div>
    
    <div id="timer">経過時間: 0.0s</div>
    <div id="log">ログ: 待機中...</div>
    
    <button id="btn" class="btn" onclick="startAnalysis()">解析開始</button>
</div>

<div id="result" style="margin-top:20px;"></div>

<script>
    let timerInterval;
    const model = "gemini-2.5-flash";

    function updateInfo() {
        const count = document.getElementById('fileInput').files.length;
        document.getElementById('fileCount').innerText = `選択された画像: ${count}枚`;
    }

    function addLog(msg) {
        const log = document.getElementById('log');
        log.innerHTML += `> ${msg}<br>`;
        log.scrollTop = log.scrollHeight;
    }

    async function startAnalysis() {
        const files = document.getElementById('fileInput').files;
        const key = document.getElementById('apiKey').value;
        if (!key || files.length === 0) return alert("キーと画像が必要です");

        const btn = document.getElementById('btn');
        btn.disabled = true;
        btn.classList.add('loading');
        
        // タイマー開始
        let seconds = 0;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            seconds += 0.1;
            document.getElementById('timer').innerText = `経過時間: ${seconds.toFixed(1)}s`;
        }, 100);

        addLog("画像圧縮開始...");
        try {
            const base64Images = await Promise.all(Array.from(files).map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (e) => {
                        const img = new Image();
                        img.src = e.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const maxWidth = 1000; // 確実に通すためさらに縮小
                            const scale = maxWidth / img.width;
                            canvas.width = maxWidth;
                            canvas.height = img.height * scale;
                            canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7).split(',')[1]);
                        };
                    };
                });
            }));

            addLog(`${model} へ送信中...`);
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "屋根積算。図面から[部位, 名称, 長さmm, 備考]のJSONのみ返せ。" },
                            ...base64Images.map(data => ({ inline_data: { mime_type: "image/jpeg", data } }))
                        ]
                    }]
                })
            });

            const data = await response.json();
            clearInterval(timerInterval);

            if (data.error) throw new Error(data.error.message);
            
            addLog("受信完了！");
            document.getElementById('result').innerText = data.candidates[0].content.parts[0].text;

        } catch (e) {
            clearInterval(timerInterval);
            addLog(`エラー発生: ${e.message}`);
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.classList.remove('loading');
        }
    }
</script>
</body>
</html>
