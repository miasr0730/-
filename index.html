<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v4.0 - Polygon Precision Overlay</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --success: #188038; --bg: #f8f9fa; }
        body { font-family: -apple-system, "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { position: relative; min-width: 80px; height: 80px; background: #eee; border-radius: 8px; border: 1px solid #dadce0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 18px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        .res-label { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--error); }
        #formulaText { font-size: 0.85rem; line-height: 1.6; background: #f1f3f4; padding: 15px; border-radius: 8px; border-left: 4px solid var(--primary); white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ API & åŸºæœ¬è¨­å®š</h1>
    <input type="password" id="apiKey" placeholder="Gemini API Key" style="margin-bottom:10px;">
    <div class="grid">
        <div>
            <label style="font-size:0.8rem; color:#666;">å±‹æ ¹å‹å¼</label>
            <select id="roofType">
                <option value="å¯„æ£Ÿ">å¯„æ£Ÿ (Hip)</option>
                <option value="åˆ‡å¦»">åˆ‡å¦» (Gable)</option>
                <option value="ç‰‡æµã‚Œ">ç‰‡æµã‚Œ (Shed)</option>
                <option value="é™¸å±‹æ ¹">é™¸å±‹æ ¹ (Flat)</option>
                <option value="è¤‡åˆå±‹æ ¹">è¤‡åˆå±‹æ ¹ (Complex)</option>
            </select>
        </div>
        <div>
            <label style="font-size:0.8rem; color:#666;">å±‹æ ¹é¢æ•° (æ‰‹å…¥åŠ›)</label>
            <input type="number" id="planeCount" value="4" min="1">
        </div>
    </div>
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢è§£æ (v4.0 åº§æ¨™ãƒ»å…¨è¾ºãƒ»é¢æ•°æŒ‡å®š)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“„ å›³é¢ãƒ»PDFã‚’è¿½åŠ 
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">ç²¾å¯†è§£æãƒ»ãƒãƒªã‚´ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š CADå…¥åŠ›ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤çµæœ</h1>
    <div>
        <span class="res-label bg-blue">ã€æ°´å¹³æŠ•å½±å›³ã€‘CADå…¥åŠ›åŸºæœ¬å¯¸æ³•</span>
        <canvas id="planCanvas"></canvas>
    </div>
    <div>
        <span class="res-label bg-red">ã€å®Ÿå¯¸å›³ã€‘å‹¾é…å€ç‡é©ç”¨ãƒ»é¢ç©ç¢ºèªç”¨</span>
        <canvas id="slopeCanvas"></canvas>
    </div>
    <div id="formulaText"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedFiles.push({ file, data: ev.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = "";
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.innerHTML = f.file.type.includes('image') ? `<img src="${f.data}">` : `ğŸ“„ PDF`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        const roofType = document.getElementById('roofType').value;
        const planeCount = document.getElementById('planeCount').value;

        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerText = "è§£æä¸­...ï¼ˆé¢æ§‹é€ ã‚’è¨ˆç®—ä¸­ï¼‰";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview", 
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å±‹æ ¹ç©ç®—ç²¾å¯†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  v4.0 (å¤šè§’å½¢ãƒ»å…¨è¾ºæ•°å€¤åŒ–)

## åˆ¶ç´„æ¡ä»¶
- å±‹æ ¹å‹å¼: ${roofType}
- å±‹æ ¹é¢æ•°: ${planeCount} é¢

#### Step 0: æ§‹é€ æŠŠæ¡ (å±…å®¤åŸºæº–)
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®å‹å¼ã¨é¢æ•°ã‚’å³å®ˆã—ã€å›³é¢ã‹ã‚‰ä¸»ãŸã‚‹å£èŠ¯ã‚’ç‰¹å®šã€‚
- Lå­—å‹ç­‰ã®è¤‡åˆå½¢çŠ¶ã¯ã€é‡ãªã‚Šã‚’é™¤å¤–ã—ã€ç‹¬ç«‹ã—ãŸ${planeCount}å€‹ã®å¤šè§’å½¢(é¢)ã¨ã—ã¦å®šç¾©ã€‚

#### Step 1: æ•°å€¤ã®å³æ ¼æŠ½å‡º (1mmå˜ä½)
- å„è¾ºã®ã€Œæ°´å¹³æŠ•å½±è·é›¢ã€ã‚’æŠ½å‡ºã€‚å†…å´ã®å¯¸æ³•ç·šã‚’å„ªå…ˆã€‚
- é–‰ã˜ãŸå¤šè§’å½¢ã¨ã—ã¦çŸ›ç›¾ãŒãªã„ã‚ˆã†æ¤œç®—ã›ã‚ˆã€‚

#### Step 2: è»’ãƒ»ã‘ã‚‰ã°å‡ºã®åŠ ç®—
- ç«‹é¢å›³ã‚ˆã‚Šè»’ã®å‡º(eaves)ãƒ»ã‘ã‚‰ã°å‡º(gable)ã‚’ç‰¹å®šã€‚
- è¾ºã®å±æ€§(è»’å…ˆ/ã‘ã‚‰ã°)ã«å¿œã˜ã¦æ­£ç¢ºã«åŠ ç®—ã—ã€æœ€çµ‚å±‹æ ¹å¤–å‘¨ãƒ©ã‚¤ãƒ³ã‚’ç®—å‡ºã€‚

#### Step 3: è¾ºã”ã¨ã®å®Ÿå¯¸ç®—å‡º
- å„è¾ºã‚’ [è»’å…ˆ(eave), ã‘ã‚‰ã°(gable), å¤§æ£Ÿ(ridge), éš…æ£Ÿ(hip), è°·æ£Ÿ(valley)] ã«åˆ†é¡ã€‚
- å‹¾é…ã«åŸºã¥ãã€æ°´å¹³ãªè¾ºã¯1.0å€ã€æµã‚Œæ–¹å‘ã¯å‹¾é…å€ç‡ã€éš…ãƒ»è°·ã¯éš…å€ç‡ã‚’é©ç”¨ã€‚

å‡ºåŠ›å½¢å¼(JSON):
{
  "slope": 3.5,
  "slope_factor": 1.0595,
  "planes": [
    {
      "id": 1,
      "vertices": [{"x": 0, "y": 0}, {"x": 5000, "y": 0}, ...],
      "edges": [
        {"from": 0, "to": 1, "type": "eave", "len_plan": 5000, "len_actual": 5000}
      ]
    }
  ],
  "step_logs": "è§£æãƒ—ãƒ­ã‚»ã‚¹ã®è¦ç´„ã€‚ãªãœã“ã®æ•°å€¤ã«ãªã£ãŸã‹ã€‚"
}`;

            const parts = selectedFiles.map(f => ({
                inlineData: { data: f.data.split(',')[1], mimeType: f.file.type }
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('formulaText').innerText = `ã€AIè§£æãƒ­ã‚°ã€‘\n${data.step_logs}`;
            
            drawPolygon(data, 'planCanvas', false);
            drawPolygon(data, 'slopeCanvas', true);

        } catch (e) { 
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message); 
            console.error(e);
        } finally { 
            btn.disabled = false; 
            btn.innerText = "ç²¾å¯†è§£æãƒ»ãƒãƒªã‚´ãƒ³ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å®Ÿè¡Œ";
        }
    };

    function drawPolygon(data, canvasId, isActual) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        canvas.width = 1200; canvas.height = 850;
        ctx.clearRect(0,0,1200,850);

        // 1. å…¨é ‚ç‚¹ã‹ã‚‰ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’è¨ˆç®—ã—ã¦ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
        let allX = [], allY = [];
        data.planes.forEach(p => p.vertices.forEach(v => { allX.push(v.x); allY.push(v.y); }));
        const minX = Math.min(...allX), maxX = Math.max(...allX);
        const minY = Math.min(...allY), maxY = Math.max(...allY);
        const roofW = maxX - minX, roofH = maxY - minY;
        const scale = Math.min(1000/roofW, 650/roofH);
        const offsetX = (1200 - roofW * scale) / 2 - minX * scale;
        const offsetY = (850 - roofH * scale) / 2 - minY * scale;

        const color = isActual ? "#d93025" : "#1a73e8";

        // 2. é¢ï¼ˆãƒãƒªã‚´ãƒ³ï¼‰ã®æç”»
        data.planes.forEach(plane => {
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            plane.vertices.forEach((v, i) => {
                const px = v.x * scale + offsetX;
                const py = v.y * scale + offsetY;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            });
            ctx.closePath();
            ctx.stroke();

            // 3. è¾ºã®ãƒ©ãƒ™ãƒ«æç”»
            ctx.font = "bold 14px sans-serif";
            ctx.fillStyle = color;
            plane.edges.forEach(edge => {
                const v1 = plane.vertices[edge.from];
                const v2 = plane.vertices[edge.to] || plane.vertices[0];
                
                // è¾ºã®ä¸­ç‚¹ã‚’è¨ˆç®—
                const mx = ((v1.x + v2.x) / 2) * scale + offsetX;
                const my = ((v1.y + v2.y) / 2) * scale + offsetY;

                const val = isActual ? edge.len_actual : edge.len_plan;
                const label = `${edge.type.toUpperCase()}: ${val}`;

                // èƒŒæ™¯ç™½æŠœãã§æ–‡å­—ã‚’è¦‹ã‚„ã™ã
                const txtW = ctx.measureText(label).width;
                ctx.fillStyle = "rgba(255,255,255,0.8)";
                ctx.fillRect(mx - txtW/2 - 2, my - 10, txtW + 4, 18);
                
                ctx.fillStyle = color;
                ctx.textAlign = "center";
                ctx.fillText(label, mx, my + 4);
            });
        });
    }
</script>
</body>
</html>
