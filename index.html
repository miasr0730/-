<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI - å–¶æ¥­é€Ÿå ±ç‰ˆï¼ˆç²¾å¯†ãƒ­ã‚¸ãƒƒã‚¯ï¼‰</title>
    <style>
        :root { --primary: #0284c7; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; color: #334155; }
        .container { background: white; padding: 20 :root { --primary: #0284c7; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; color: #334155; }
        .container { background: white; padding: 20px; border-radius: 16px; max-width: 600px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .api-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 0.8rem; box-sizing: border-box; }
        .upload-area { border: 2px dashed #0284c7; padding: 15px; text-align: center; border-radius: 10px; background: #fff; cursor: pointer; margin-bottom: 10px; }
        #thumb-list { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 10px; }
        .thumb-wrapper { position: relative; flex: 0 0 60px; height: 60px; border: 1px solid #ccc; border-radius: 4px; }
        .thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; border: none; font-size: 12px; }
        .btn { width: 100%; padding: 15px; background: #0284c7; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        #result-area { margin-top: 20px; display: none; }
        
        /* ã€é‡è¦ã€‘SVGç”»åƒã®å¤§ãã•ã‚’ã‚¹ãƒãƒ›ç”»é¢å†…ã«å›ºå®šã™ã‚‹ä¿®æ­£ */
        .svg-viewer { 
            background: #1e293b; 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .svg-viewer svg { 
            max-width: 100%; 
            height: auto; 
            max-height: 450px; /* ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„é«˜ã•ã«åˆ¶é™ */
        }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #e2e8f0; padding: 8px; text-align: left; font-size: 0.8rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; font-weight: bold; }
        .debug-info { font-size: 0.75rem; color: #64748b; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <input type="password" id="apiKey" class="api-input" placeholder="Gemini API Key">

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“· å›³é¢ã‚’è¿½åŠ ï¼ˆå…¨æ–¹ä½ã®ç«‹é¢å›³ãƒ»å„éšå¹³é¢å›³ï¼‰</strong>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="addFiles(this)">
    </div>

    <div id="thumb-list"></div>

    <button id="runBtn" class="btn" onclick="startAnalysis()">è§£æå®Ÿè¡Œï¼ˆç²¾å¯†ãƒ¢ãƒ¼ãƒ‰ï¼‰</button>
    
    <div id="status" style="display:none; text-align:center; padding:10px;"></div>

    <div id="result-area">
        <div class="svg-viewer" id="svg-output"></div>
        
        <table>
            <thead><tr><th>ç©ç®—é …ç›®</th><th>æ•°å€¤ / åˆ¤å®š</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="debug-info">
            <details>
                <summary>ğŸ” AIã®åˆ¤æ–­æ ¹æ‹ ï¼ˆç«‹é¢ãƒ»å¹³é¢ã®çªãåˆã‚ã›ãƒ­ã‚°ï¼‰</summary>
                <div id="logic-output" style="white-space: pre-wrap; margin-top:10px;"></div>
            </details>
        </div>
    </div>
</div>

<script>
    let fileStack = [];

    function addFiles(input) {
        Array.from(input.files).forEach(file => {
            fileStack.push(file);
            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div');
                div.className = 'thumb-wrapper';
                div.innerHTML = `<img src="${e.target.result}" class="thumb"><button class="del-btn" onclick="removeFile(this)">Ã—</button>`;
                document.getElementById('thumb-list').appendChild(div);
            };
            reader.readAsDataURL(file);
        });
        updateUI();
        input.value = "";
    }

    function removeFile(btn) {
        const wrapper = btn.parentElement;
        const index = Array.from(document.getElementById('thumb-list').children).indexOf(wrapper);
        fileStack.splice(index, 1);
        wrapper.remove();
        updateUI();
    }

    function updateUI() {
        document.getElementById('runBtn').innerText = `è§£æå®Ÿè¡Œï¼ˆ${fileStack.length}æšï¼‰`;
    }

    async function startAnalysis() {
        const key = document.getElementById('apiKey').value;
        if(!key || fileStack.length === 0) return alert("ç”»åƒã¨ã‚­ãƒ¼ãŒå¿…è¦ã§ã™");

        const status = document.getElementById('status');
        status.style.display = "block";
        status.innerText = "â³ å›³é¢ã‚’çªãåˆã‚ã›ä¸­...";

        try {
            const b64Images = await Promise.all(fileStack.map(file => toBase64(file)));

            const prompt = `ã‚ãªãŸã¯é«˜åº¦ãªå»ºç¯‰ç©ç®—å£«ã§ã™ã€‚æä¾›ã•ã‚ŒãŸå…¨ã¦ã®å›³é¢ã‚’ä»¥ä¸‹ã®ã€ç²¾å¯†ç…§åˆãƒ­ã‚¸ãƒƒã‚¯ã€‘ã§è§£æã—ã€å–¶æ¥­è³‡æ–™ç”¨ã®çµæœã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

### 1. ä¸‰æ¬¡å…ƒçš„ãªæ§‹é€ æŠŠæ¡
- **ç«‹é¢å›³ã‹ã‚‰ã®é€†å¼•ã**: ã¾ãšç«‹é¢å›³ï¼ˆæ±è¥¿å—åŒ—ï¼‰ã‚’è¦‹ã¦ã€å±‹æ ¹ãŒã©ã®é«˜ã•ï¼ˆéšï¼‰ã«å­˜åœ¨ã™ã‚‹ã‹ã‚’è¦–è¦šçš„ã«ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
- **å¹³é¢å›³ã¨ã®çªãåˆã‚ã›**: ç«‹é¢å›³ã§è¦‹ã¤ã‘ãŸå±‹æ ¹ã®æ¥ç‚¹ãŒã€å¹³é¢å›³ä¸Šã®ã©ã®å¤–å£ãƒ©ã‚¤ãƒ³ï¼ˆå¤–é¢ï¼‰ã«å¯¾å¿œã™ã‚‹ã‹ã‚’å‚ç›´æŠ•å½±ã—ã¦ç‰¹å®šã—ã¦ãã ã•ã„ã€‚
- **éšå±¤ã®è‡ªå·±åˆ¤å®š**: ã€Œå¤§å±‹æ ¹ã€ãŒè¼‰ã£ã¦ã„ã‚‹éšã®å¹³é¢å›³ã‚’ãƒ¡ã‚¤ãƒ³ã®å¯¸æ³•åŸºæº–ã¨ã—ã€ã‚‚ã—ã€Œä¸‹å±‹ã€ãŒã‚ã‚Œã°1éšå¹³é¢å›³ã®å¼µã‚Šå‡ºã—éƒ¨åˆ†ã‚’åŸºæº–ã¨ã—ã¦ãã ã•ã„ã€‚

### 2. ãƒãƒ«ã‚³ãƒ‹ãƒ¼ã¨å±‹æ ¹ã®å³å¯†ãªåŒºåˆ¥
- å¹³é¢å›³ã«å¼µã‚Šå‡ºã—ãŒã‚ã£ã¦ã‚‚ã€ç«‹é¢å›³ã§ãã“ã«å±‹æ ¹ãŒæã‹ã‚Œã¦ã„ãªã„ï¼ˆãƒãƒ«ã‚³ãƒ‹ãƒ¼ç­‰ã®åºŠã®ã¿ï¼‰å ´åˆã¯ã€å±‹æ ¹ç©ç®—ã®ãƒ©ã‚¤ãƒ³ã‹ã‚‰é™¤å¤–ã™ã‚‹ã“ã¨ã€‚
- é€†ã«ã€ãƒãƒ¼ãƒãªã©ã®æŸ±ã§æ”¯ãˆã‚‰ã‚ŒãŸå±‹æ ¹ãŒã‚ã‚‹å ´åˆã¯ã€ç«‹é¢å›³ã®æƒ…å ±ã‚’å„ªå…ˆã—ã¦å±‹æ ¹é¢ç©ã«å«ã‚ã‚‹ã“ã¨ã€‚

### 3. å‡ºåŠ›æŒ‡ç¤º
- å±‹æ ¹ä¼å›³ï¼ˆSVGå½¢å¼ã€èƒŒæ™¯é€æ˜ãƒ»ç·šã¯ç™½ï¼‰ã‚’ä½œæˆã€‚ã‚¹ãƒãƒ›ç”»é¢ã§è¦‹ã‚„ã™ã„ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã§æç”»ã™ã‚‹ã“ã¨ã€‚
- ç©ç®—é …ç›®ï¼ˆå½¢çŠ¶ã€å‹¾é…ã€è»’ã®å‡ºã€å»ºç‰©æœ€å¤§å¤–å¯¸ã€é¢ç©ç­‰ï¼‰ã‚’æŠ½å‡ºã€‚
- è§£æãƒ­ã‚°ã«ã¯ã€ã©ã®ç«‹é¢å›³ã¨ã©ã®å¹³é¢å›³ã‚’æ¯”è¼ƒã—ã¦çµè«–ã‚’å‡ºã—ãŸã‹ç°¡æ½”ã«è¨˜ã™ã“ã¨ã€‚

æœ€å¾Œã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§ç· ã‚ã¦ãã ã•ã„ã€‚
%%%JSON_START%%% {"items": [{"name": "é …ç›®", "value": "æ•°å€¤"}]} %%%JSON_END%%%`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, ...b64Images.map(data => ({ inline_data: { mime_type: "image/jpeg", data } }))] }]
                })
            });

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('logic-output').innerText = text.split('%%%')[0];
            const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/);
            if(svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];
            const jsonMatch = text.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);
            if(jsonMatch) {
                const json = JSON.parse(jsonMatch[1]);
                document.getElementById('table-body').innerHTML = json.items.map(it => `<tr><td>${it.name}</td><td>${it.value}</td></tr>`).join('');
            }
            status.style.display = "none";
        } catch (e) {
            status.innerText = "âŒ è§£æã‚¨ãƒ©ãƒ¼";
        }
    }

    function toBase64(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, 1600 / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
            };
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>
