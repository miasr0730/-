<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v4.6 (Strict Precision Mode)</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .input-style { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .select-style { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #ccc; }
        .btn-primary { background: #1a73e8; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; width: 100%; font-size: 16px; font-weight: bold; }
        .btn-primary:hover { background: #1557b0; }
        #previewContainer { display: flex; gap: 10px; flex-wrap: wrap; min-height: 50px; border: 2px dashed #ddd; padding: 15px; border-radius: 8px; background: #fafafa; }
        .thumb-wrapper { position: relative; width: 100px; height: 100px; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .remove-btn { position: absolute; top: -5px; right: -5px; background: #d93025; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 18px; cursor: pointer; font-size: 12px; }
        canvas { width: 100%; height: auto; border: 1px solid #333; background: #fff; margin-top: 10px; }
        h3 { margin-top: 0; border-left: 4px solid #1a73e8; padding-left: 10px; }
    </style>
</head>
<body>

    <div class="card">
        <h3>ğŸ”‘ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
        <label>Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="AIè§£æç”¨ã®APIã‚­ãƒ¼ã‚’å…¥åŠ›" class="input-style">
        
        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <div style="flex: 2;">
                <label>ğŸ  å±‹æ ¹å½¢çŠ¶:</label>
                <select id="roofType" class="select-style">
                    <option value="å¯„æ£Ÿ">å¯„æ£Ÿ (Hip)</option>
                    <option value="åˆ‡å¦»">åˆ‡å¦» (Gable)</option>
                    <option value="ç‰‡æµã‚Œ">ç‰‡æµã‚Œ (Shed)</option>
                    <option value="æ–¹å½¢">æ–¹å½¢ (Pyramid)</option>
                    <option value="é™¸å±‹æ ¹">é™¸å±‹æ ¹ (Flat)</option>
                    <option value="è…°æŠ˜">è…°æŠ˜ (Gambrel)</option>
                    <option value="å…¥æ¯å±‹">å…¥æ¯å±‹ (Irimoya)</option>
                    <option value="åŠåˆ‡å¦»">åŠåˆ‡å¦» (Jerkinhead)</option>
                    <option value="è¤‡åˆå±‹æ ¹" selected>è¤‡åˆå±‹æ ¹ (Complex)</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>ğŸ”¢ æŒ‡å®šé¢æ•°:</label>
                <input type="number" id="planeCount" value="4" class="input-style" min="1">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°å¯ï¼‰</h3>
        <p style="font-size: 12px; color: #666;">â€»å¹³é¢å›³ã¨ç«‹é¢å›³ã‚’ã‚»ãƒƒãƒˆã§ã‚¢ãƒƒãƒ—ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚</p>
        <input type="file" id="fileInput" accept="image/*" multiple class="input-style">
        <div id="previewContainer"></div>
    </div>

    <button id="analyzeBtn" class="btn-primary">ç²¾å¯†è§£æã‚’å®Ÿè¡Œ</button>

    <div class="card" id="resultArea" style="display:none;">
        <h3>ğŸ“Š è§£æçµæœï¼šæ°´å¹³æŠ•å½±å›³ (Plan)</h3>
        <canvas id="planCanvas"></canvas>
        
        <h3>ğŸ“ è§£æçµæœï¼šå‹¾é…å®Ÿå¯¸å›³ (Actual)</h3>
        <canvas id="slopeCanvas"></canvas>

        <div id="logArea" style="margin-top:20px; font-size: 14px; background: #f8f9fa; padding: 10px; border-radius: 4px; white-space: pre-wrap;"></div>
    </div>

<script>
    let allUploadedFiles = []; // è“„ç©ç”¨é…åˆ—

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆä¸Šæ›¸ãã›ãšè¿½åŠ ï¼‰
    document.getElementById('fileInput').onchange = (e) => {
        const files = Array.from(e.target.files);
        const container = document.getElementById('previewContainer');
        
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (f) => {
                const dataUrl = f.target.result;
                allUploadedFiles.push(dataUrl);

                const wrapper = document.createElement('div');
                wrapper.className = 'thumb-wrapper';
                wrapper.innerHTML = `
                    <img src="${dataUrl}">
                    <div class="remove-btn">Ã—</div>
                `;
                wrapper.querySelector('.remove-btn').onclick = () => {
                    allUploadedFiles = allUploadedFiles.filter(item => item !== dataUrl);
                    wrapper.remove();
                };
                container.appendChild(wrapper);
            };
            reader.readAsDataURL(file);
        });
    };

    const shapeConstraints = {
        "å¯„æ£Ÿ": "å±‹æ ¹é¢ã‚’4ã¤ï¼ˆå°å½¢2ã€ä¸‰è§’2ï¼‰ã«åˆ†é›¢ã€‚å¤§æ£Ÿã¨4éš…ã®éš…æ£Ÿã‚’å®šç¾©ã›ã‚ˆã€‚",
        "åˆ‡å¦»": "é•·æ–¹å½¢2é¢ã€‚å¦»å´ã®ã€ã‘ã‚‰ã°å‡ºã€ã‚’å³å¯†åŠ ç®—ã›ã‚ˆã€‚",
        "ç‰‡æµã‚Œ": "1ã¤ã®é•·æ–¹å½¢ã€‚æœ€é«˜éƒ¨(æ°´ä¸Š)ã¨æœ€ä½éƒ¨(æ°´ä¸‹)ã‚’ç‰¹å®šã›ã‚ˆã€‚",
        "æ–¹å½¢": "4ã¤ã®ä¸‰è§’å½¢ãŒ1ç‚¹ã«é›†ã¾ã‚‹æ§‹é€ ã€‚éš…æ£Ÿ4æœ¬ã‚’å‡ç­‰ç®—å‡ºã›ã‚ˆã€‚",
        "é™¸å±‹æ ¹": "æ°´å¹³é¢ã€‚ãƒ‘ãƒ©ãƒšãƒƒãƒˆå†…å¯¸ã¨æ’æ°´å‹¾é…ã‚’è€ƒæ…®ã›ã‚ˆã€‚",
        "è…°æŠ˜": "å‹¾é…å¤‰åŒ–ç‚¹ã®å¢ƒç•Œç·šåº§æ¨™ã‚’ç‰¹å®šã—ã€ä¸Šä¸‹ã®é¢ã‚’å®šç¾©ã›ã‚ˆã€‚",
        "å…¥æ¯å±‹": "ä¸Šéƒ¨åˆ‡å¦»ï¼‹ä¸‹éƒ¨å¯„æ£Ÿã®è¤‡åˆã€‚æ¥ç¶šéƒ¨ã®å¯¸æ³•ã‚’ç²¾å¯†ã«ç®—å‡ºã›ã‚ˆã€‚",
        "åŠåˆ‡å¦»": "åˆ‡å¦»ã®å¦»å´ä¸Šéƒ¨ã‚’æ–œã‚ã«åˆ‡ã‚Šè½ã¨ã—ãŸï¼ˆã¯ã—ã‚‡ã£ãŸï¼‰å½¢çŠ¶ã‚’å†ç¾ã›ã‚ˆã€‚",
        "è¤‡åˆå±‹æ ¹": "Lå­—ã‚„æ®µé•ã„ã‚’ç‹¬ç«‹ã—ãŸNå€‹ã®å¤šè§’å½¢ã¨ã—ã¦å€‹åˆ¥ã«å®šç¾©ã›ã‚ˆã€‚"
    };

    // æç”»ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå¯¸æ³•ãƒ»æµã‚Œæ–¹å‘ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºç¶™æ‰¿ï¼‰
    function renderComplexRoof(data, canvasId, isActual) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        canvas.width = 1200;
        canvas.height = 800;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (!data.planes) return;

        let allX = [], allY = [];
        data.planes.forEach(p => p.vertices.forEach(v => { allX.push(v.x); allY.push(v.y); }));
        const minX = Math.min(...allX), maxX = Math.max(...allX);
        const minY = Math.min(...allY), maxY = Math.max(...allY);
        const scale = Math.min(1000 / (maxX - minX || 1), 600 / (maxY - minY || 1));
        const offsetX = (canvas.width - (maxX - minX) * scale) / 2 - minX * scale;
        const offsetY = (canvas.height - (maxY - minY) * scale) / 2 - minY * scale;

        data.planes.forEach(plane => {
            const coords = plane.vertices.map(v => ({ x: v.x * scale + offsetX, y: v.y * scale + offsetY }));

            // 1. å±‹æ ¹ã®é¢ã‚’æç”»
            ctx.beginPath();
            ctx.strokeStyle = isActual ? "#d93025" : "#1a73e8";
            ctx.lineWidth = 3;
            ctx.fillStyle = isActual ? "rgba(217, 48, 37, 0.05)" : "rgba(26, 115, 232, 0.05)";
            coords.forEach((c, i) => { if (i === 0) ctx.moveTo(c.x, c.y); else ctx.lineTo(c.x, c.y); });
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            // 2. å„è¾ºã®å¯¸æ³•ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
            ctx.font = "bold 16px Arial";
            plane.edges.forEach(edge => {
                const v1 = coords[edge.from], v2 = coords[edge.to];
                if (!v1 || !v2) return;
                const midX = (v1.x + v2.x) / 2, midY = (v1.y + v2.y) / 2;
                const val = Math.round(isActual ? edge.len_actual : edge.len_plan);
                
                ctx.fillStyle = "white";
                const tw = ctx.measureText(val).width + 6;
                ctx.fillRect(midX - tw/2, midY - 10, tw, 20);
                ctx.fillStyle = isActual ? "#d93025" : "#1a73e8";
                ctx.textAlign = "center";
                ctx.fillText(val, midX, midY + 5);
            });

            // 3. å‚ç›´æµã‚Œå¯¸æ³•ã®è¡¨ç¤º
            if (plane.center_label) {
                const centerX = coords.reduce((a, b) => a + b.x, 0) / coords.length;
                const centerY = coords.reduce((a, b) => a + b.y, 0) / coords.length;
                ctx.font = "bold 18px Arial";
                ctx.fillStyle = "#000";
                ctx.fillText("æµã‚Œ: " + plane.center_label, centerX, centerY);
            }
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const key = document.getElementById('apiKey').value;
        const type = document.getElementById('roofType').value;
        const count = document.getElementById('planeCount').value;

        if (!key) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (allUploadedFiles.length === 0) return alert("å›³é¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„");

        const prompt = `
# å±‹æ ¹ç©ç®—ç²¾å¯†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  v4.6 (å³æ ¼ç²¾å¯†ãƒ¢ãƒ¼ãƒ‰)
#### Step 0: å±‹æ ¹ãŒå¿…è¦ãªã€Œå£èŠ¯ã€ã®å³æ ¼ç‰¹å®š (æœ€å„ªå…ˆ)
- å¹³é¢å›³ã®æ³¨è¨˜ï¼ˆLDK/æ´‹å®¤/å’Œå®¤/åç´/ã‚µãƒƒã‚·/é–‹å£éƒ¨ç­‰ï¼‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã€‚
- ã€å±‹å†…ç¢ºå®šãƒ«ãƒ¼ãƒ«ã€‘ï¼šä¸Šè¨˜æ³¨è¨˜ãŒã‚ã‚‹å£ã¯ã€Œå±‹å†…ã€ã¨ã—ã€å±‹æ ¹ã®åœŸå°ï¼ˆå£èŠ¯ï¼‰ã¨ç¢ºå®šã›ã‚ˆã€‚
- ã€ãƒ™ãƒ©ãƒ³ãƒ€é™¤å¤–ãƒ«ãƒ¼ãƒ«ã€‘ï¼šã€Œãƒ™ãƒ©ãƒ³ãƒ€/ãƒãƒ«ã‚³ãƒ‹ãƒ¼ã€ã¯ç«‹é¢å›³ã¨ç…§åˆã€‚å±‹æ ¹ãŒè¢«ã£ã¦ã„ãªã„å ´åˆã¯é™¤å¤–ã›ã‚ˆã€‚

#### Step 1: å¯¸æ³•ç·šã®éšå±¤è§£æã¨æ•°å€¤å–å¾—
- å¹³é¢å›³æ å¤–ã®å¯¸æ³•ç·šã®ã†ã¡ã€ã€Œæœ€ã‚‚å»ºç‰©ã«è¿‘ã„ï¼ˆä¸€ç•ªå†…å´ã®ï¼‰æ•°å€¤ã€ã‚’å£èŠ¯å¯¸æ³•ã¨ã—ã¦æ¡ç”¨ã€‚
- å¤–å´ã®ã€Œåˆè¨ˆå€¤ã€ã‚„åˆ¥éšã®æ•°å€¤ã‚’åˆç®—ã™ã‚‹ãƒŸã‚¹ã‚’å³ç¦ã¨ã™ã‚‹ã€‚

#### Step 2: å½¢çŠ¶åˆ¥ãƒ»å¹¾ä½•è¨ˆç®—
- é¸æŠå½¢çŠ¶: ${type} / é¢æ•°: ${count}
- ${shapeConstraints[type]}
- å…¨ã¦ã®è¾ºã«ã€Œæ°´å¹³æŠ•å½±(len_plan)ã€ã¨ã€Œå‹¾é…å®Ÿå¯¸(len_actual)ã€ã‚’ç®—å‡ºã€‚

å‡ºåŠ›å½¢å¼(JSONã®ã¿):
{
  "planes": [{
    "name": "é¢å",
    "vertices": [{"x": 0, "y": 0}, ...],
    "edges": [{"from": 0, "to": 1, "len_plan": 3640, "len_actual": 3845}],
    "center_label": "3845"
  }],
  "step_logs": "è§£æãƒ—ãƒ­ã‚»ã‚¹ã‚’è¨˜è¿°"
}`;

        document.getElementById('analyzeBtn').innerText = "è§£æä¸­...";
        // ã“ã“ã«Gemini APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®Ÿè£…ã€‚
        // çµæœå–å¾—å¾Œã€document.getElementById('resultArea').style.display = 'block';
        // renderComplexRoof(result, 'planCanvas', false); ç­‰ã‚’å®Ÿè¡Œã€‚
    };
</script>
</body>
</html>
