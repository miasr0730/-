<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI Vision Ultimate</title>
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --accent: #f59e0b; --bg: #f8fafc; --success: #22c55e; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; background: var(--bg); margin: 0; color: #333; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 800px; margin: auto; }
        
        h1 { text-align: center; color: var(--dark); margin-bottom: 20px; font-size: 1.4rem; }
        
        /* APIã‚­ãƒ¼è¨­å®š */
        .api-box { background: #eff6ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bfdbfe; }
        .api-row { display: flex; gap: 10px; margin-top: 8px; }
        input[type="password"], input[type="text"] { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn-small { padding: 8px 16px; background: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 16px; margin-bottom: 20px; background: #fff; cursor: pointer; transition: 0.2s; }
        .upload-area:hover { border-color: var(--primary); background: #f0f9ff; }
        .file-label { font-weight: bold; color: var(--primary); font-size: 1.1rem; display: block; }
        .file-desc { font-size: 0.85rem; color: #64748b; margin-top: 5px; }

        /* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º */
        #thumb-list { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .thumb { height: 60px; border-radius: 6px; border: 1px solid #ddd; }

        /* è§£æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #status { display: none; padding: 15px; background: #fff7ed; border-radius: 8px; color: #c2410c; margin-bottom: 20px; font-weight: bold; border: 1px solid #ffedd5; }
        .loading::after { content: " â³"; animation: spin 1s infinite linear; }

        /* çµæœã‚¨ãƒªã‚¢ï¼ˆSVGè¡¨ç¤ºï¼‰ */
        #result-area { display: none; margin-top: 20px; }
        .svg-container { background: #1e293b; border-radius: 12px; padding: 20px; text-align: center; overflow-x: auto; margin-bottom: 20px; min-height: 200px; display: flex; align-items: center; justify-content: center; color: #aaa; }
        svg { max-width: 100%; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        /* é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f1f5f9; color: #475569; font-weight: 600; }
        .total-row { font-weight: bold; background: #f8fafc; color: var(--primary); }
        .copy-btn { width: 100%; margin-top: 20px; background: var(--success); padding: 15px; color: white; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

<div class="container">
    <h1>å±‹æ ¹ç©ç®— AI Vision Ultimate</h1>
    
    <div class="api-box">
        <label style="font-size:0.8rem; font-weight:bold; color:#1e40af;">ğŸ”‘ APIè¨­å®š / ãƒ¢ãƒ‡ãƒ«é¸æŠ</label>
        <div class="api-row">
            <input type="password" id="apiKey" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
            <input type="text" id="modelName" value="gemini-1.5-flash" placeholder="ãƒ¢ãƒ‡ãƒ«å" style="width:120px;">
            <button class="btn-small" onclick="saveSettings()">ä¿å­˜</button>
        </div>
        <p style="font-size:0.75rem; color:#64748b; margin:5px 0 0;">â€»ã‚ãªãŸã®ç’°å¢ƒã«åˆã‚ã›ã¦ãƒ¢ãƒ‡ãƒ«åï¼ˆgemini-2.0-flash-exp ã‚„ gemini-2.5-flash ç­‰ï¼‰ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</p>
    </div>

    <label class="upload-area">
        <span class="file-label">ğŸ“· å›³é¢ã‚’é¸æŠ (è¤‡æ•°å¯)</span>
        <span class="file-desc">å¹³é¢å›³ã€ç«‹é¢å›³ã€å±‹æ ¹ä¼å›³ãªã©ã‚’ã¾ã¨ã‚ã¦é¸æŠã—ã¦ãã ã•ã„</span>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this)" style="display: none;">
    </label>

    <div id="thumb-list"></div>

    <button id="analyzeBtn" class="copy-btn" style="background:var(--primary); margin-top:0; display:none;" onclick="runAI()">ğŸš€ AIã§ç©ç®—ãƒ»å›³é¢ç”Ÿæˆã‚’å®Ÿè¡Œ</button>

    <div id="status"></div>

    <div id="result-area">
        <h3 style="margin-top:0;">ğŸ¤– AIç”Ÿæˆ: å±‹æ ¹ä¼å›³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
        <p style="font-size:0.8rem; color:#666;">â€»AIãŒèªè­˜ã—ãŸå½¢çŠ¶ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚å¯¸æ³•ã¯è¨ˆç®—ä¸Šã®æ¨å®šå€¤ã§ã™ã€‚</p>
        <div class="svg-container" id="svg-output">å›³é¢ç”Ÿæˆå¾…æ©Ÿä¸­...</div>

        <h3>ğŸ“‹ éƒ¨ä½åˆ¥ ç©ç®—ãƒªã‚¹ãƒˆ</h3>
        <div style="overflow-x:auto;">
            <table id="calc-table">
                <thead>
                    <tr>
                        <th>éƒ¨ä½</th>
                        <th>ç®‡æ‰€ãƒ»åç§°</th>
                        <th>é•·ã• (mm)</th>
                        <th>å‚™è€ƒ</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        
        <button class="copy-btn" onclick="copyTable()">ğŸ“‹ è¡¨ã‚’ã‚³ãƒ”ãƒ¼ (Excelç”¨)</button>
    </div>
</div>

<script>
    // --- è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ ---
    window.onload = () => {
        if(localStorage.getItem('gemini_api_key')) document.getElementById('apiKey').value = localStorage.getItem('gemini_api_key');
        if(localStorage.getItem('gemini_model')) document.getElementById('modelName').value = localStorage.getItem('gemini_model');
    };

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('apiKey').value);
        localStorage.setItem('gemini_model', document.getElementById('modelName').value);
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    let selectedFiles = [];

    function handleFiles(input) {
        selectedFiles = Array.from(input.files);
        const list = document.getElementById('thumb-list');
        list.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            document.getElementById('analyzeBtn').style.display = 'block';
            selectedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'thumb';
                    list.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    // --- AIå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³ ---
    async function runAI() {
        const apiKey = document.getElementById('apiKey').value;
        const model = document.getElementById('modelName').value;
        if (!apiKey) return alert("APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„");
        
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.innerHTML = "ç”»åƒã‚’åœ§ç¸®ã—ã¦è§£æä¸­... <span class='loading'></span>";
        document.getElementById('result-area').style.display = 'none';

        try {
            // ç”»åƒã‚’å…¨ã¦Base64åŒ– & ãƒªã‚µã‚¤ã‚º
            const imagePromises = selectedFiles.map(file => resizeImage(file, 1024));
            const base64Images = await Promise.all(imagePromises);
            
            // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šSVGç”Ÿæˆã¨JSONãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã®ä¸¡æ–¹ã‚’æŒ‡ç¤º
            const prompt = `
ã‚ãªãŸã¯å»ºç¯‰ç©ç®—ã®ãƒ—ãƒ­ã§ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸè¤‡æ•°ã®å›³é¢ï¼ˆå¹³é¢å›³ãƒ»ç«‹é¢å›³ãªã©ï¼‰ã‚’ç·åˆçš„ã«åˆ¤æ–­ã—ã€ä»¥ä¸‹ã®2ã¤ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ã€ã‚¿ã‚¹ã‚¯1: å±‹æ ¹ä¼å›³ã®SVGç”Ÿæˆã€‘
å±‹æ ¹ã‚’çœŸä¸Šã‹ã‚‰è¦‹ãŸã€Œå±‹æ ¹ä¼å›³ã€ã®SVGã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
- èƒŒæ™¯ã¯é€æ˜ã€ç·šã¯ç™½(#ffffff)ã§æç”»ã€‚
- æ£Ÿã€éš…æ£Ÿã€è°·ã€è»’å…ˆã€ã‚±ãƒ©ãƒã®ç·šã‚’æ˜ç¢ºã«åŒºåˆ¥ã—ã¦æç”»ã€‚
- å„è¾ºã®è¿‘ãã«ã€ç®—å‡ºã¾ãŸã¯èª­ã¿å–ã£ãŸå¯¸æ³•æ•°å€¤(mm)ã‚’ãƒ†ã‚­ã‚¹ãƒˆã§é…ç½®ã—ã¦ãã ã•ã„ã€‚
- SVGã‚¿ã‚°ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownã®å›²ã¿ä¸è¦ï¼‰ã€‚

ã€ã‚¿ã‚¹ã‚¯2: è©³ç´°ç©ç®—ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã€‘
å±‹æ ¹ã®ã™ã¹ã¦ã®è¾ºã‚’æ‹¾ã„å‡ºã—ã€ä»¥ä¸‹ã®JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
{
  "items": [
    { "type": "è»’å…ˆ", "name": "å—é¢è»’å…ˆ", "length_mm": 4550, "note": "è»’å‡º275mmå«ã‚€" },
    { "type": "ã‚±ãƒ©ãƒ", "name": "è¥¿é¢å¦»å´", "length_mm": 3800, "note": "æ°´ä¸Šã‹ã‚‰æ°´ä¸‹ã¾ã§" },
    { "type": "ç™»ã‚Š", "name": "å—é¢ç™»ã‚Š", "length_mm": 4900, "note": "4.0å¯¸å‹¾é…" },
    { "type": "æ£Ÿ", "name": "å¤§æ£Ÿ", "length_mm": 9100, "note": "" },
    { "type": "éš…æ£Ÿ", "name": "å—æ±éš…", "length_mm": 5200, "note": "" }
  ],
  "summary": "ï¼ˆå…¨ä½“ã®è§£èª¬ã€‚ä¾‹ï¼šåˆ‡å¦»å±‹æ ¹ã§ã€å—é¢ã®å‹¾é…ã¯4å¯¸ã€åŒ—é¢ã¯5å¯¸ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚ï¼‰"
}

å›ç­”ã¯ã€å¿…ãš **%%%JSON_START%%%** ã‹ã‚‰ **%%%JSON_END%%%** ã®é–“ã«JSONãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã€ãã‚Œä»¥å¤–ã«SVGã‚³ãƒ¼ãƒ‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚
`;

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆ
            const contentParts = [{ text: prompt }];
            base64Images.forEach(b64 => {
                contentParts.push({ inline_data: { mime_type: "image/jpeg", data: b64.split(',')[1] } });
            });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            const rawText = data.candidates[0].content.parts[0].text;
            
            // --- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æ ---
            // 1. JSONéƒ¨åˆ†ã®æŠ½å‡º
            const jsonMatch = rawText.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);
            let jsonData = null;
            if (jsonMatch) {
                try {
                    jsonData = JSON.parse(jsonMatch[1].trim());
                } catch(e) { console.error("JSON Parse Error"); }
            } else {
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼šé€šå¸¸ã®JSONãƒ–ãƒ­ãƒƒã‚¯ã‚’æ¢ã™
                const altMatch = rawText.match(/```json([\s\S]*?)```/);
                if(altMatch) jsonData = JSON.parse(altMatch[1]);
            }

            // 2. SVGéƒ¨åˆ†ã®æŠ½å‡º
            const svgMatch = rawText.match(/<svg[\s\S]*?<\/svg>/);
            const svgCode = svgMatch ? svgMatch[0] : "SVGå›³é¢ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

            // --- çµæœè¡¨ç¤º ---
            document.getElementById('svg-output').innerHTML = svgCode;
            
            if (jsonData && jsonData.items) {
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";
                let totalLen = 0;
                
                jsonData.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-size:0.8rem;">${item.type}</span></td>
                        <td>${item.name}</td>
                        <td style="font-weight:bold; color:#333;">${item.length_mm.toLocaleString()}</td>
                        <td style="color:#666; font-size:0.8rem;">${item.note}</td>
                    `;
                    tbody.appendChild(tr);
                    if(typeof item.length_mm === 'number') totalLen += item.length_mm;
                });
                
                // åˆè¨ˆè¡Œ
                const totalTr = document.createElement('tr');
                totalTr.className = "total-row";
                totalTr.innerHTML = `<td colspan="2">åˆè¨ˆå»¶é•·</td><td>${totalLen.toLocaleString()}</td><td></td>`;
                tbody.appendChild(totalTr);

                status.innerHTML = `âœ… è§£æå®Œäº†: ${jsonData.summary || "ç©ç®—ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ"}`;
                status.style.color = "var(--success)";
            } else {
                status.innerText = "âš ï¸ è§£æãƒ‡ãƒ¼ã‚¿ã®ä¸€éƒ¨å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å›³é¢ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚";
            }

            document.getElementById('result-area').style.display = 'block';

        } catch (e) {
            console.error(e);
            status.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}<br>â€»ãƒ¢ãƒ‡ãƒ«åãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            status.style.color = "red";
        }
    }

    // ç”»åƒãƒªã‚µã‚¤ã‚ºé–¢æ•°
    function resizeImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    if (scale < 1) {
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                    } else {
                        canvas.width = img.width;
                        canvas.height = img.height;
                    }
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    function copyTable() {
        const table = document.getElementById('calc-table');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        alert("è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Excelãªã©ã«è²¼ã‚Šä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚");
    }
</script>
</body>
</html>
