<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI Vision Ultimate</title>
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --accent: #f59e0b; --bg: #f8fafc; --success: #22c55e; --danger: #ef4444; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 15px; background: var(--bg); margin: 0; color: #333; }
        .container { background: white; padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 800px; margin: auto; }
        
        h1 { text-align: center; color: var(--dark); margin-bottom: 20px; font-size: 1.3rem; }
        
        /* APIã‚­ãƒ¼è¨­å®š */
        .api-box { background: #eff6ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bfdbfe; }
        .api-row { display: flex; gap: 8px; margin-top: 5px; }
        input[type="password"] { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn-small { padding: 8px 16px; background: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .upload-btn { 
            background: white; border: 2px dashed #cbd5e1; padding: 20px; 
            text-align: center; border-radius: 16px; cursor: pointer; display: block; 
            transition: 0.2s; margin-bottom: 15px;
        }
        .upload-btn:active { background: #f0f9ff; border-color: var(--primary); transform: scale(0.98); }
        .icon-cam { font-size: 2rem; display: block; margin-bottom: 5px; }
        .text-main { font-weight: bold; color: var(--primary); display: block; }
        .text-sub { font-size: 0.8rem; color: #64748b; }

        /* ã‚µãƒ ãƒã‚¤ãƒ«ãƒªã‚¹ãƒˆ */
        #thumb-list { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); 
            gap: 10px; margin-bottom: 20px; 
        }
        .thumb-item { position: relative; border-radius: 8px; overflow: hidden; aspect-ratio: 1; border: 1px solid #ddd; }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        .remove-btn { 
            position: absolute; top: 0; right: 0; background: rgba(255,0,0,0.8); color: white; 
            width: 24px; height: 24px; border: none; cursor: pointer; font-weight: bold;
            border-bottom-left-radius: 6px; display: flex; align-items: center; justify-content: center;
        }

        /* è§£æå®Ÿè¡Œãƒœã‚¿ãƒ³ */
        .action-btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .primary-btn { background: var(--primary); color: white; }
        .disabled-btn { background: #cbd5e1; color: #64748b; cursor: not-allowed; box-shadow: none; }
        
        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ & çµæœ */
        #status { display: none; margin-top:20px; padding: 15px; background: #fff7ed; border-radius: 8px; color: #c2410c; font-weight: bold; text-align: center; }
        .loading::after { content: " â³"; animation: spin 1s infinite linear; }

        #result-area { display: none; margin-top: 20px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .svg-container { background: #1e293b; border-radius: 12px; padding: 10px; text-align: center; overflow-x: auto; margin-bottom: 20px; min-height:150px; display: flex; align-items: center; justify-content: center; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f1f5f9; }
        .total-row { font-weight: bold; background: #f8fafc; color: var(--primary); }
        .copy-btn { background: var(--success); color: white; margin-top: 15px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>å±‹æ ¹ç©ç®— AI Vision Ultimate</h1>
    
    <div class="api-box">
        <label style="font-size:0.8rem; font-weight:bold; color:#1e40af;">ğŸ”‘ APIã‚­ãƒ¼è¨­å®š</label>
        <div class="api-row">
            <input type="password" id="apiKey" placeholder="AI Studioã®ã‚­ãƒ¼ã‚’è²¼ä»˜">
            <button class="btn-small" onclick="saveSettings()">ä¿å­˜</button>
        </div>
    </div>

    <label class="upload-btn">
        <span class="icon-cam">ğŸ“·</span>
        <span class="text-main">å†™çœŸã‚’è¿½åŠ  / æ’®å½±</span>
        <span class="text-sub">ã‚¿ãƒƒãƒ—ã—ã¦é€£ç¶šæ’®å½±ã§ãã¾ã™</span>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="addFiles(this)" style="display: none;">
    </label>

    <div id="thumb-list"></div>

    <button id="analyzeBtn" class="action-btn disabled-btn" onclick="runAI()" disabled>
        ğŸš€ AIè§£æã‚’å®Ÿè¡Œ (0æš)
    </button>

    <div id="status"></div>

    <div id="result-area">
        <h3>ğŸ“ AIç”Ÿæˆ: å±‹æ ¹ä¼å›³</h3>
        <div class="svg-container" id="svg-output"></div>

        <h3>ğŸ“‹ ç©ç®—ãƒªã‚¹ãƒˆ</h3>
        <div style="overflow-x:auto;">
            <table id="calc-table">
                <thead>
                    <tr><th>éƒ¨ä½</th><th>åç§°ãƒ»å ´æ‰€</th><th>é•·ã• (mm)</th><th>å‚™è€ƒ</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        <button class="action-btn copy-btn" onclick="copyTable()">ğŸ“‹ è¡¨ã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
</div>

<script>
    const FIXED_MODEL = "gemini-2.5-flash"; 
    let allFiles = []; // ã“ã“ã«æ’®å½±ã—ãŸå…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è²¯ã‚ã‚‹

    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;
    };

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('apiKey').value);
        alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ å‡¦ç†ï¼ˆã“ã“ãŒé‡è¦ï¼‰ ---
    function addFiles(input) {
        const newFiles = Array.from(input.files);
        if (newFiles.length === 0) return;

        // æ—¢å­˜ãƒªã‚¹ãƒˆã«è¿½åŠ 
        allFiles = allFiles.concat(newFiles);
        
        // ç”»é¢æ›´æ–°
        updateThumbnails();

        // é‡è¦ï¼šinputã®ä¸­èº«ã‚’ãƒªã‚»ãƒƒãƒˆã—ãªã„ã¨ã€åŒã˜å†™çœŸã‚’é€£ç¶šã§é¸ã‚“ã æ™‚ã«åå¿œã—ãªã„
        input.value = ''; 
    }

    // --- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤ºã¨å‰Šé™¤æ©Ÿèƒ½ ---
    function updateThumbnails() {
        const list = document.getElementById('thumb-list');
        const btn = document.getElementById('analyzeBtn');
        list.innerHTML = '';

        allFiles.forEach((file, index) => {
            const div = document.createElement('div');
            div.className = 'thumb-item';
            
            const img = document.createElement('img');
            img.className = 'thumb-img';
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(file);

            // å‰Šé™¤ãƒœã‚¿ãƒ³
            const delBtn = document.createElement('button');
            delBtn.className = 'remove-btn';
            delBtn.innerHTML = 'Ã—';
            delBtn.onclick = () => removeFile(index);

            div.appendChild(img);
            div.appendChild(delBtn);
            list.appendChild(div);
        });

        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        if (allFiles.length > 0) {
            btn.classList.remove('disabled-btn');
            btn.classList.add('primary-btn');
            btn.disabled = false;
            btn.innerText = `ğŸš€ AIè§£æã‚’å®Ÿè¡Œ (${allFiles.length}æš)`;
        } else {
            btn.classList.add('disabled-btn');
            btn.classList.remove('primary-btn');
            btn.disabled = true;
            btn.innerText = `ğŸš€ AIè§£æã‚’å®Ÿè¡Œ (0æš)`;
        }
    }

    function removeFile(index) {
        allFiles.splice(index, 1);
        updateThumbnails();
    }

    // --- AIè§£æå®Ÿè¡Œ ---
    async function runAI() {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.innerHTML = `ç”»åƒ${allFiles.length}æšã‚’çµ±åˆã—ã¦è§£æä¸­... <span class='loading'></span>`;
        document.getElementById('result-area').style.display = 'none';

        try {
            // æºœã¾ã£ãŸç”»åƒã‚’å…¨ã¦ãƒªã‚µã‚¤ã‚ºã—ã¦å¤‰æ›
            const imagePromises = allFiles.map(file => resizeImage(file, 1200));
            const base64Images = await Promise.all(imagePromises);
            
            const prompt = `
ã‚ãªãŸã¯å»ºç¯‰ç©ç®—ã®ãƒ—ãƒ­ã§ã™ã€‚æ·»ä»˜ã•ã‚ŒãŸè¤‡æ•°ã®ç”»åƒï¼ˆå¹³é¢å›³ãƒ»ç«‹é¢å›³ãƒ»ä¼å›³ã®æ–­ç‰‡ãªã©ï¼‰ã‚’ã™ã¹ã¦çµ±åˆã—ã€ã²ã¨ã¤ã®æ•´åˆæ€§ã®å–ã‚ŒãŸå±‹æ ¹ãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦è§£æã—ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›è¦ä»¶ã€‘
1. å±‹æ ¹ä¼å›³ã®SVGã‚³ãƒ¼ãƒ‰ï¼ˆèƒŒæ™¯é€æ˜ã€ç·šã¯ç™½ã€å„è¾ºã«å¯¸æ³•å€¤ã‚’è¨˜è¼‰ï¼‰
2. ä»¥ä¸‹ã®JSONãƒ‡ãƒ¼ã‚¿ï¼ˆã™ã¹ã¦ã®è¾ºã‚’ç¶²ç¾…ã™ã‚‹ã“ã¨ï¼‰
   %%%JSON_START%%%
   {
     "items": [
       { "type": "è»’å…ˆ", "name": "å—é¢", "length_mm": 4550, "note": "æ°´å¹³" },
       { "type": "ç™»ã‚Š", "name": "å—é¢", "length_mm": 4900, "note": "å‹¾é…4å¯¸" }
     ],
     "summary": "å±‹æ ¹å½¢çŠ¶ã®åˆ¤å®šç†ç”±"
   }
   %%%JSON_END%%%
`;

            const contentParts = [{ text: prompt }];
            base64Images.forEach(b64 => {
                contentParts.push({ inline_data: { mime_type: "image/jpeg", data: b64.split(',')[1] } });
            });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${FIXED_MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const rawText = data.candidates[0].content.parts[0].text;
            const svgMatch = rawText.match(/<svg[\s\S]*?<\/svg>/);
            const jsonMatch = rawText.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);

            if (svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];
            
            if (jsonMatch) {
                const jsonData = JSON.parse(jsonMatch[1].trim());
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";
                let total = 0;
                
                jsonData.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td><b>${item.type}</b></td><td>${item.name}</td><td>${item.length_mm.toLocaleString()}</td><td style="font-size:0.8rem">${item.note}</td>`;
                    tbody.appendChild(tr);
                    total += item.length_mm;
                });
                
                const totalTr = document.createElement('tr');
                totalTr.className = "total-row";
                totalTr.innerHTML = `<td colspan="2">åˆè¨ˆ</td><td>${total.toLocaleString()} mm</td><td></td>`;
                tbody.appendChild(totalTr);

                status.innerHTML = `âœ… è§£æå®Œäº†: ${jsonData.summary}`;
                status.style.color = "var(--success)";
                document.getElementById('result-area').style.display = 'block';
            }

        } catch (e) {
            status.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
            status.style.color = "red";
        }
    }

    function resizeImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = maxWidth / img.width;
                    canvas.width = (scale < 1) ? maxWidth : img.width;
                    canvas.height = (scale < 1) ? img.height * scale : img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    function copyTable() {
        const table = document.getElementById('calc-table');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }
</script>
</body>
</html>
