<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v5.1 - Gemini 3 Fixed</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --success: #188038; --bg: #f8f9fa; }
        body { font-family: -apple-system, "Segoe UI", sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 0.9rem; }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { position: relative; min-width: 80px; height: 80px; background: #eee; border-radius: 8px; border: 1px solid #dadce0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 18px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        .res-label { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--error); }
        #logArea { font-size: 0.8rem; background: #333; color: #fff; padding: 10px; border-radius: 8px; max-height: 200px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; display: none; }
        .error-msg { color: var(--error); font-weight: bold; padding: 10px; border: 1px solid var(--error); border-radius: 8px; background: #ffebeb; display: none; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h1>
    <input type="password" id="apiKey" placeholder="Gemini API Key ã‚’å…¥åŠ›" style="margin-bottom:10px;">
    <div class="grid">
        <div>
            <label style="font-size:0.8rem; color:#666;">å±‹æ ¹å‹å¼</label>
            <select id="roofType">
                <option value="å¯„æ£Ÿ">å¯„æ£Ÿ (Hip)</option>
                <option value="åˆ‡å¦»">åˆ‡å¦» (Gable)</option>
                <option value="è¤‡åˆå±‹æ ¹">è¤‡åˆå±‹æ ¹ (Complex)</option>
                <option value="ç‰‡æµã‚Œ">ç‰‡æµã‚Œ (Shed)</option>
            </select>
        </div>
        <div>
            <label style="font-size:0.8rem; color:#666;">å±‹æ ¹é¢æ•°</label>
            <input type="number" id="planeCount" value="4" min="1">
        </div>
    </div>
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (v5.1 Gemini-3 Fixed)</h1>
    <div class="error-msg" id="errorMsg"></div>
    <div id="previewContainer"></div>
    <label style="display:block; text-align:center; padding:20px; border:2px dashed #ccc; border-radius:10px; cursor:pointer; color:#666; margin-bottom:10px;">
        ï¼‹ ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒãƒ»PDFã‚’è¿½åŠ 
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">ç²¾å¯†è§£æãƒ»å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š è§£æçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h1>
    <div>
        <span class="res-label bg-blue">ã€å¹³é¢å›³ã€‘æ°´å¹³å¯¸æ³• ï¼‹ æµã‚Œ(å¹³é¢)</span>
        <canvas id="planCanvas"></canvas>
    </div>
    <div>
        <span class="res-label bg-red">ã€å®Ÿå¯¸å›³ã€‘å‹¾é…å®Ÿå¯¸ ï¼‹ æµã‚Œ(å®Ÿå¯¸)</span>
        <canvas id="slopeCanvas"></canvas>
    </div>
    <div id="logArea"></div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedFiles.push({ file, data: ev.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = "";
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.innerHTML = f.file.type.includes('image') ? `<img src="${f.data}">` : `ğŸ“„ PDF`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        const roofType = document.getElementById('roofType').value;
        const planeCount = document.getElementById('planeCount').value;
        const errorMsg = document.getElementById('errorMsg');
        const logArea = document.getElementById('logArea');
        
        errorMsg.style.display = 'none';
        logArea.style.display = 'none';

        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerText = "è§£æä¸­... (Gemini-3 Preview)";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            
            // â–¼â–¼â–¼ ã“ã“ã‚’ gemini-3-flash-preview ã«å›ºå®š â–¼â–¼â–¼
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview", 
                generationConfig: { responseMimeType: "application/json" }
            });

            // ---------------------------------------------------------
            // 1. åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯: å‹å¼ã«å¿œã˜ãŸæŒ‡ç¤ºã®ç”Ÿæˆ
            // ---------------------------------------------------------
            let specificConstraint = "";
            if (roofType === "è¤‡åˆå±‹æ ¹") {
                specificConstraint = `
- **ãƒ¢ãƒ¼ãƒ‰: è¤‡åˆå±‹æ ¹ãƒ»æ®µé•ã„è§£æ**
- ç«‹é¢å›³(Elevation)ã‚’æ­£ã¨ã—ã€æ®µå·®ãŒã‚ã‚‹å ´åˆã¯åˆ¥ã€…ã®é¢ã¨ã—ã¦åº§æ¨™ã‚’å®šç¾©ã›ã‚ˆã€‚
- å¹³é¢å›³ã®ã‚°ãƒªãƒƒãƒ‰ç·š(910, 455ç­‰)ã¯ç„¡è¦–ã—ã€å®Ÿåœ¨ã™ã‚‹ã€Œå±‹æ ¹ã®å¤–å½¢ç·šã€ã®ã¿ã‚’æ‹¾ãˆã€‚
- ä»˜å¸¯éƒ¨ï¼ˆãƒãƒ¼ãƒã€ãƒãƒ«ã‚³ãƒ‹ãƒ¼ï¼‰ã‚’é™¤å¤–ã—ãŸã€ãƒ¡ã‚¤ãƒ³ã®${planeCount}é¢ã®ã¿ã‚’å‡ºåŠ›ã›ã‚ˆã€‚`;
            } else if (roofType === "å¯„æ£Ÿ") {
                specificConstraint = `
- **ãƒ¢ãƒ¼ãƒ‰: å¯„æ£Ÿè§£æ**
- å±‹æ ¹é¢ã‚’4ã¤ï¼ˆå—åŒ—ã®å°å½¢ã€æ±è¥¿ã®ä¸‰è§’å½¢ï¼‰ã«åˆ†é›¢ã—ã€ãã‚Œãã‚Œã®å®Ÿå¯¸ã€Œæµã‚Œã€ã¨ã€Œéš…æ£Ÿã€ã‚’ç®—å‡ºã›ã‚ˆã€‚`;
            } else {
                specificConstraint = `
- **ãƒ¢ãƒ¼ãƒ‰: ${roofType}è§£æ**
- å±‹æ ¹é¢ã‚’${planeCount}é¢ã¨ã—ã¦å®šç¾©ã—ã€å¦»å´ã®ã‘ã‚‰ã°å‡ºã‚’æ­£ç¢ºã«åŠ ç®—ã›ã‚ˆã€‚`;
            }

            // ---------------------------------------------------------
            // 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæ§‹ç¯‰ï¼ˆStep0-3å®Œå…¨ç¶­æŒ + åˆ†å²æ³¨å…¥ï¼‰
            // ---------------------------------------------------------
            const prompt = `
ã‚ãªãŸã¯å±‹æ ¹ç©ç®—ã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Ÿè¡Œã›ã‚ˆã€‚

#### Step 0: å±‹æ ¹ãŒå¿…è¦ãªå£ã®ç‰¹å®š (æœ€é‡è¦)
1. å¹³é¢å›³ã®å¤ªç·šãƒ©ã‚¤ãƒ³ä»˜è¿‘ã«ã€ŒLDK/æ´‹å®¤/å’Œå®¤/ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ/ã‚µãƒƒã‚·/é–‹å£éƒ¨ã€ç­‰ã®æ³¨è¨˜ãŒã‚ã‚‹ã‹ç¢ºèªã›ã‚ˆã€‚ã“ã‚ŒãŒã‚ã‚‹å£ã¯ã€Œå±‹å†…ï¼ˆå±‹æ ¹ã®åœŸå°ï¼‰ã€ã¨ç¢ºå®šã›ã‚ˆã€‚
2. ã€Œãƒ™ãƒ©ãƒ³ãƒ€ã€ã€Œãƒãƒ«ã‚³ãƒ‹ãƒ¼ã€ç­‰ã¯ã€å¿…ãšç«‹é¢å›³ï¼ˆæ±ãƒ»è¥¿ãƒ»å—ãƒ»åŒ—ï¼‰ã¨ç…§åˆã—ã€ä¸»å±‹æ ¹ãŒè¢«ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã›ã‚ˆã€‚ç©ºãŒè¦‹ãˆã‚‹å ´åˆã¯é™¤å¤–ã›ã‚ˆã€‚

#### Step 1: å‹¾é…ã®è‡ªå‹•æ¤œå‡º
- å›³é¢ã‹ã‚‰ã€Œâ—‹å¯¸ã€ã€Œâ—‹/10ã€ã€Œâ—‹.00ã€ã¨ã„ã†å‹¾é…è¡¨è¨˜ã‚’æ¢ã›ã€‚

#### Step 2: è¤‡åˆæ§‹é€ ã®çµ±åˆã¨æ•°å€¤æ­»å®ˆ
- å»ºç‰©å…¨ä½“ã®å·¦ä¸Šã‚’åŸç‚¹(0,0)ã¨ã—ã€å„ãƒ‘ãƒ¼ãƒ„ï¼ˆä¸»å±‹æ ¹ã€ãƒãƒ¼ãƒã€ä¸‹å±‹ï¼‰ã‚’é…ç½®ã›ã‚ˆã€‚
- ã€çµ¶å¯¾ãƒ«ãƒ¼ãƒ«ã€‘ãƒ”ã‚¯ã‚»ãƒ«æ¯”ç‡ã§ã®æ¨å®šã‚’ç¦æ­¢ã™ã‚‹ã€‚å›³é¢ä¸Šã®Yè»¸å¯¸æ³•ãƒ†ã‚­ã‚¹ãƒˆã‚’æœ€å„ªå…ˆã§èª­ã¿å–ã‚Œã€‚
- ç«‹é¢å›³ã‹ã‚‰ã€Œè»’ã®å‡º(eaves)ã€ã®æ•°å€¤ã‚’æ¢ã—ã€æ±è¥¿(X)ãƒ»å—åŒ—(Y)ãã‚Œãã‚Œã«(è»’ã®å‡ºÃ—2)ã‚’åŠ ç®—ã›ã‚ˆã€‚
  - è¨ˆç®—ä¾‹: å¤–å¯¸ = å£èŠ¯åˆè¨ˆ + (è»’ã®å‡º Ã— 2)

#### Step 3: å±‹æ ¹é¢ã”ã¨ã®è¨ˆç®— (${roofType} æŒ‡å®š)
${specificConstraint}
- å…¨ã¦ã®è¾ºã«å¯¾ã—ã€ã€Œæ°´å¹³æŠ•å½±å›³(Plan)ã€ã¨ã€Œå‹¾é…å®Ÿå¯¸(Actual)ã€ã®ä¸¡æ–¹ã‚’ç®—å‡ºã—ã€åº§æ¨™ãƒ‡ãƒ¼ã‚¿ã¨å…±ã«è¿”ã›ã€‚
- å„é¢ã®ä¸­å¤®ä»˜è¿‘ã‚’é€šã‚‹ã€Œæµã‚Œå¯¸æ³•(flow)ã€ã®å§‹ç‚¹ãƒ»çµ‚ç‚¹ãƒ»è·é›¢ã‚’ç®—å‡ºã›ã‚ˆã€‚

å‡ºåŠ›å½¢å¼(JSON):
{
  "slope": 6.0,
  "step_logs": "è§£ææ€è€ƒãƒ—ãƒ­ã‚»ã‚¹",
  "planes": [
    {
      "id": 1, 
      "vertices": [{"x":0,"y":0}, ...],
      "edges": [{"from":0,"to":1,"type":"eave","len_plan":1000,"len_actual":1000}],
      "flow": {"start":{"x":10,"y":10},"end":{"x":10,"y":50},"len_plan":4000,"len_actual":4500}
    }
  ]
}`;

            const parts = selectedFiles.map(f => ({
                inlineData: { data: f.data.split(',')[1], mimeType: f.file.type }
            }));

            // APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            const result = await model.generateContent([prompt, ...parts]);
            const responseText = result.response.text();

            // ---------------------------------------------------------
            // 3. ãƒ•ãƒªãƒ¼ã‚ºé˜²æ­¢: JSONãƒ‘ãƒ¼ã‚¹ã®å®‰å…¨æ€§å‘ä¸Š
            // ---------------------------------------------------------
            let data;
            try {
                // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜å· ```json ... ``` ãŒã‚ã‚‹å ´åˆã«é™¤å»
                const cleanJson = responseText.replace(/```json|```/g, '').trim();
                data = JSON.parse(cleanJson);
            } catch (jsonErr) {
                console.error("JSON Parse Error:", responseText);
                throw new Error("AIã®è¿”ç­”ãŒæ­£ã—ã„JSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
            }

            document.getElementById('resultCard').style.display = 'block';
            logArea.style.display = 'block';
            logArea.innerText = `ã€è§£æãƒ­ã‚°ã€‘\n${data.step_logs}\n\n(å‹¾é…: ${data.slope}å¯¸)`;

            // æç”»å‡¦ç† (ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã“ã“ã§æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«try-catchã§å›²ã‚€)
            try {
                drawPolygon(data, 'planCanvas', false);
                drawPolygon(data, 'slopeCanvas', true);
            } catch (drawErr) {
                console.error("Drawing Error:", drawErr);
                alert("æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€è§£æãƒ‡ãƒ¼ã‚¿ã¯ãƒ­ã‚°ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚");
            }

        } catch (e) {
            errorMsg.innerText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message;
            errorMsg.style.display = 'block';
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "ç²¾å¯†è§£æãƒ»å®Ÿè¡Œ";
        }
    };

    function drawPolygon(data, canvasId, isActual) {
        const canvas = document.getElementById(canvasId);
        if (!data.planes || data.planes.length === 0) return; // ãƒ‡ãƒ¼ã‚¿ãªã—ãªã‚‰çµ‚äº†

        const ctx = canvas.getContext('2d');
        canvas.width = 1200; canvas.height = 900;
        ctx.clearRect(0,0,1200,900);

        // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—
        let allX = [], allY = [];
        data.planes.forEach(p => {
            if(p.vertices) p.vertices.forEach(v => { allX.push(v.x); allY.push(v.y); });
        });
        
        // é ‚ç‚¹ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®å®‰å…¨ç­–
        if (allX.length === 0) {
            ctx.fillText("åº§æ¨™ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ", 50, 50);
            return;
        }

        const minX = Math.min(...allX), maxX = Math.max(...allX);
        const minY = Math.min(...allY), maxY = Math.max(...allY);
        const roofW = maxX - minX, roofH = maxY - minY;
        const scale = Math.min(1000/roofW, 700/roofH);
        const offsetX = (1200 - roofW * scale) / 2 - minX * scale;
        const offsetY = (900 - roofH * scale) / 2 - minY * scale;

        const color = isActual ? "#d93025" : "#1a73e8";

        data.planes.forEach(plane => {
            if (!plane.vertices) return;

            // 1. ãƒãƒªã‚´ãƒ³æç”»
            ctx.beginPath();
            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            plane.vertices.forEach((v, i) => {
                const px = v.x * scale + offsetX;
                const py = v.y * scale + offsetY;
                if (i === 0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
            });
            ctx.closePath();
            ctx.stroke();

            // 2. è¾ºãƒ©ãƒ™ãƒ«
            if (plane.edges) {
                ctx.font = "bold 13px sans-serif";
                plane.edges.forEach(edge => {
                    const v1 = plane.vertices[edge.from];
                    const v2 = plane.vertices[edge.to] || plane.vertices[0];
                    if (!v1 || !v2) return; // é ‚ç‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚¨ãƒ©ãƒ¼å›é¿

                    const mx = ((v1.x + v2.x) / 2) * scale + offsetX;
                    const my = ((v1.y + v2.y) / 2) * scale + offsetY;
                    const val = isActual ? edge.len_actual : edge.len_plan;
                    const label = `${edge.type ? edge.type.toUpperCase() : ''}: ${val}`;
                    
                    drawTextLabel(ctx, label, mx, my, color);
                });
            }

            // 3. æµã‚Œå¯¸æ³• (å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿)
            if (plane.flow && plane.flow.start && plane.flow.end) {
                const fs = plane.flow.start, fe = plane.flow.end;
                const sx = fs.x * scale + offsetX, sy = fs.y * scale + offsetY;
                const ex = fe.x * scale + offsetX, ey = fe.y * scale + offsetY;

                ctx.save();
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(sx, sy);
                ctx.lineTo(ex, ey);
                ctx.strokeStyle = color;
                ctx.stroke();
                ctx.restore();

                const flowVal = isActual ? plane.flow.len_actual : plane.flow.len_plan;
                drawTextLabel(ctx, `æµã‚Œ: ${flowVal}`, (sx+ex)/2, (sy+ey)/2, color, true);
            }
        });
    }

    function drawTextLabel(ctx, text, x, y, color, isHighlight = false) {
        ctx.font = isHighlight ? "bold 15px sans-serif" : "12px sans-serif";
        const tw = ctx.measureText(text).width;
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        ctx.fillRect(x - tw/2 - 4, y - 10, tw + 8, 20);
        ctx.fillStyle = color;
        ctx.textAlign = "center";
        ctx.fillText(text, x, y + 5);
    }
</script>
</body>
</html>
