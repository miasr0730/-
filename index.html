<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v1.6 - Master Logic</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å‰Šé™¤æ©Ÿèƒ½ */
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { 
            position: relative; min-width: 80px; height: 80px; 
            background: #eee; border-radius: 8px; border: 1px solid #dadce0;
            display: flex; align-items: center; justify-content: center; font-size: 0.7rem;
        }
        .del-btn {
            position: absolute; top: -5px; right: -5px; width: 22px; height: 22px;
            background: var(--error); color: white; border-radius: 50%; border: none; 
            cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center;
        }

        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .analyze-btn:disabled { background: #ccc; }

        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px; }
        .res-label { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--error); }
        
        #logArea { background: #202124; color: #34a853; font-family: monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 120px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
        .alert { background: #fce8e6; color: var(--error); padding: 15px; border-radius: 8px; border: 1px solid #f9d2ce; margin-bottom: 15px; display: none; font-weight: bold; }
    </style>
</head>
<body>

<div id="errorAlert" class="alert"></div>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" style="width:100%; padding:12px; border:1px solid #dadce0; border-radius:8px; box-sizing:border-box;" placeholder="Gemini API Key">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢è§£æ (PDF/ç”»åƒ)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
        <input type="file" id="fileInput" accept="image/*,application/pdf" style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">å³æ ¼è§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š è§£æçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h1>
    <div>
        <span class="res-label bg-blue">ã€å¹³é¢æŠ•å½±å›³ã€‘æ°´å¹³å¯¸æ³•</span>
        <canvas id="planCanvas"></canvas>
    </div>
    <div>
        <span class="res-label bg-red">ã€å®Ÿå¯¸æ³•å›³ã€‘3.5å¯¸å‹¾é…é©ç”¨å¾Œ</span>
        <canvas id="slopeCanvas"></canvas>
    </div>
    <div id="formulaText" style="font-size:0.85rem; line-height:1.6; background:#e8f0fe; padding:15px; border-radius:8px;"></div>
</div>

<div class="card">
    <h1>ğŸ§  æ€è€ƒãƒ­ã‚° (ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ Step 0-4)</h1>
    <div id="logArea">å¾…æ©Ÿä¸­...</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const logArea = document.getElementById('logArea');
    const fileInput = document.getElementById('fileInput');

    // å‰Šé™¤æ©Ÿèƒ½
    window.removeFile = (idx) => {
        selectedFiles.splice(idx, 1);
        renderPreviews();
    };

    // ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹ï¼ˆã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆãƒ»ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
    async function preprocessImage(file) {
        if (file.type === 'application/pdf') return file;
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width; canvas.height = img.height;
                ctx.filter = 'contrast(1.4) grayscale(1)'; 
                ctx.drawImage(img, 0, 0);
                canvas.toBlob(blob => resolve(new File([blob], file.name, {type:'image/jpeg'})), 'image/jpeg', 0.9);
            };
            img.src = URL.createObjectURL(file);
        });
    }

    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        logArea.innerText = "æœ€é©åŒ–ä¸­...";
        const processed = await preprocessImage(file);
        selectedFiles.push(processed);
        renderPreviews();
        fileInput.value = ""; // ãƒªã‚»ãƒƒãƒˆ
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.innerHTML = `${f.type.includes('pdf') ? 'ğŸ“„ PDF' : 'ğŸ–¼ IMG'}<button class="del-btn" onclick="removeFile(${i})">Ã—</button>`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ãŒå¿…è¦ã§ã™");
        
        const btn = document.getElementById('analyzeBtn');
        const alertBox = document.getElementById('errorAlert');
        btn.disabled = true; alertBox.style.display = 'none';
        logArea.innerText = "--- è§£æé–‹å§‹ (gemini-3-flash-preview) ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview",
                generationConfig: { responseMimeType: "application/json" }
            });

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æŒ‡å®šã®å³æ ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’çµ±åˆ
            const prompt = `
# å»ºç¯‰å›³é¢è§£æãƒ»å±‹æ ¹å¯¸æ³•æŠ½å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (v1.6)
ã‚ãªãŸã¯å±‹æ ¹å¯¸æ³•è§£æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å³æ ¼ã«å®Ÿè¡Œã—ã€æ­£ç¢ºãªå¯¸æ³•ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚

#### Step 0: ç·šç¨®ãƒ»æ§‹é€ ã®è§£æï¼ˆè¦–è¦šçš„ä»®èª¬ï¼‰
1. å¹³é¢å›³ã«ãŠã„ã¦ã€æœ€ã‚‚å¤ªã„å®Ÿç·šã§å›²ã¾ã‚ŒãŸé–‰é–é ˜åŸŸã‚’ã€Œå±‹å†…æœ¬ä½“ï¼ˆå±‹æ ¹ã®åœŸå°ï¼‰ã€ã¨ã—ã€ãã®å¤–å´ã«ã‚ã‚‹ç´°ã„å®Ÿç·šã‚„äºŒé‡ç·šï¼ˆãƒ™ãƒ©ãƒ³ãƒ€ç­‰ï¼‰ã‚’ã€Œå¤–éƒ¨è¨­å‚™ã€ã¨ã—ã¦åˆ†é›¢ã›ã‚ˆã€‚
2. å—åŒ—è»¸ï¼ˆYè»¸ï¼‰ã¨æ±è¥¿è»¸ï¼ˆXè»¸ï¼‰ã®ã€Œå±‹æ ¹ãŒè¼‰ã‚‹ã¹ãä¸»è»¸ã€ã¨ãªã‚‹å¤ªã„å®Ÿç·šã‚’ç‰¹å®šã›ã‚ˆã€‚

#### Step 1: ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã«ã‚ˆã‚‹ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯
1. å¤ªç·šãƒ©ã‚¤ãƒ³ä¸Šã«ã€ŒLDK/æ´‹å®¤/ã‚µãƒƒã‚·ã€ç­‰ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€Œå±‹æ ¹ãŒå¿…è¦ãªå£ã€ã¨ç¢ºå®šã›ã‚ˆã€‚

#### Step 2: ç«‹é¢å›³ã«ã‚ˆã‚‹ã€Œå±‹æ ¹ã®æœ‰ç„¡ã€æœ€çµ‚å¯©åˆ¤
1. å¹³é¢å›³ã®ã€Œå¤–éƒ¨è¨­å‚™ï¼ˆãƒ™ãƒ©ãƒ³ãƒ€ç­‰ï¼‰ã€ã«ã¤ã„ã¦ã€å¿…ãšç«‹é¢å›³ã¨ç…§åˆã›ã‚ˆã€‚
2. ç«‹é¢å›³ã§ãƒ™ãƒ©ãƒ³ãƒ€ã®ä¸Šã«ã€Œä¸»å±‹æ ¹ã€ãŒè¢«ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã›ã‚ˆã€‚ç©ºãŒè¦‹ãˆã‚‹å ´åˆã¯åˆç®—ã‹ã‚‰é™¤å¤–ã›ã‚ˆã€‚

#### Step 3: å³é¸ã•ã‚ŒãŸæ•°å€¤ã®æŠ½å‡ºï¼ˆãƒ”ãƒƒãƒåˆç®—ï¼‰
1. ã‚¹ãƒ†ãƒƒãƒ—2ã§ç¢ºå®šã—ãŸå£èŠ¯ãƒ©ã‚¤ãƒ³ã®ã€å€‹åˆ¥ãƒ”ãƒƒãƒå¯¸æ³•ã€‘ã‚’å…¨ã¦åˆ—æŒ™ã›ã‚ˆã€‚
2. å…¨ä½“ã®åˆè¨ˆå¯¸æ³•ç·šã«ãƒ™ãƒ©ãƒ³ãƒ€ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ä½¿ç”¨ç¦æ­¢ã€‚å¿…ãšå†…å´ã®æ•°å€¤ã‚’è¶³ã™ã“ã¨ã€‚

#### Step 4: æœ€çµ‚è¨ˆç®—
1. [å¤–å¯¸ç®—å‡º]: (ãƒ”ãƒƒãƒåˆè¨ˆ) + (è»’ã®å‡º Ã— 2)
2. ç”»åƒãŒä¸é®®æ˜ã§èª­ã‚ãªã„å ´åˆã®ã¿ error_code: "BLURRY" ã‚’è¿”ã›ã€‚

å½¢å¼(JSON):
{
  "error_code": null,
  "width_mm": æ•°å€¤,
  "height_mm": æ•°å€¤,
  "ridge_mm": å¤§æ£Ÿé•·ã•,
  "eaves_mm": è»’ã®å‡º,
  "step_logs": "Step3ãƒ»4ã®è¨ˆç®—éç¨‹ã‚’è©³ç´°ã«è¨˜è¿°ã›ã‚ˆï¼ˆä¾‹: Xè»¸ 2025+900+4050+...ï¼‰"
}`;

            const parts = await Promise.all(selectedFiles.map(async f => {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(f);
                });
                return { inlineData: { data: base64, mimeType: f.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            if (data.error_code === "BLURRY") {
                alertBox.innerText = "âš ï¸ å›³é¢ãŒä¸é®®æ˜ã§ã™ã€‚ã‚‚ã†ä¸€åº¦æ˜ã‚‹ã„å ´æ‰€ã§æ’®ã£ã¦ãã ã•ã„ã€‚";
                alertBox.style.display = 'block'; return;
            }

            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('formulaText').innerHTML = `<b>è¨ˆç®—ãƒ—ãƒ­ã‚»ã‚¹:</b><br>${data.step_logs}<br><b>è»’ã®å‡º:</b> ${data.eaves_mm}mm`;
            
            renderRoofAll(data.width_mm, data.height_mm, data.ridge_mm);
            logArea.innerText += "\nè§£æå®Œäº†ã€‚";

        } catch (e) { logArea.innerText += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`; }
        finally { btn.disabled = false; }
    };

    function renderRoofAll(w, h, ridge) {
        drawRoof('planCanvas', w, h, ridge, false);
        drawRoof('slopeCanvas', w, h, ridge, true);
    }

    function drawRoof(id, w, h, ridge, isActual) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 400;
        const scale = Math.min(600/w, 280/h);
        const dw = w * scale; const dh = h * scale;
        const dridge = ridge * scale;
        const ox = (800-dw)/2; const oy = (400-dh)/2;
        const offset = (dw - dridge)/2;

        ctx.clearRect(0,0,800,400);
        ctx.strokeStyle = isActual ? "#d93025" : "#1a73e8"; ctx.lineWidth = 3;
        ctx.strokeRect(ox, oy, dw, dh);

        ctx.beginPath();
        ctx.moveTo(ox, oy); ctx.lineTo(ox + offset, oy + dh/2);
        ctx.moveTo(ox, oy + dh); ctx.lineTo(ox + offset, oy + dh/2);
        ctx.moveTo(ox + dw, oy); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.moveTo(ox + dw, oy + dh); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.moveTo(ox + offset, oy + dh/2); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.stroke();

        ctx.fillStyle = ctx.strokeStyle; ctx.font = "bold 15px sans-serif"; ctx.textAlign = "center";
        const f_slope = isActual ? 1.0595 : 1.0; 
        const f_hip = isActual ? 1.4569/1.4142 : 1.0; 

        ctx.fillText(`æ±è¥¿(X): ${w}mm`, 400, oy - 15);
        ctx.fillText(`å—åŒ—(Y): ${h}mm`, ox - 40, oy + dh/2);
        ctx.fillText(`${ridge}mm (å¤§æ£Ÿ)`, 400, oy + dh/2 - 10);
        ctx.fillText(`${Math.round(h/2 * f_slope)}mm (å¹³å´å®Ÿå¯¸)`, 400, oy + dh/4);
        const hip_h = Math.sqrt(Math.pow((w-ridge)/2, 2) + Math.pow(h/2, 2));
        ctx.fillText(`${Math.round(hip_h * f_h)}mm (éš…å®Ÿå¯¸)`, ox + offset/2, oy + dh/4);
    }
</script>
</body>
</html>
