<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI 2.5 - Multi-Image</title>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f1f5f9; }
        .box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }
        .api-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .upload-area { border: 2px dashed #2563eb; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; margin-bottom: 15px; }
        #thumb-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 5px; border: 1px solid #ccc; }
        .btn { width: 100%; padding: 18px; background: #2563eb; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        #status { margin-top: 15px; font-weight: bold; text-align: center; color: #1e40af; }
        #timer { font-family: monospace; text-align: center; margin-bottom: 10px; }
        #result-area { margin-top: 20px; white-space: pre-wrap; background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #ddd; display: none; }
    </style>
</head>
<body>

<div class="box">
    <h2 style="text-align:center; font-size:1.2rem;">Gemini 2.5 Flash çµ±åˆè§£æ</h2>
    <input type="password" id="apiKey" class="api-input" placeholder="Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›">
    
    <label class="upload-area">
        <strong>ğŸ“· å›³é¢ã‚’è¤‡æ•°æš æ’®å½±/é¸æŠ</strong>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this)" style="display: none;">
    </label>

    <div id="thumb-list"></div>
    <div id="timer">å¾…æ©Ÿä¸­</div>

    <button id="runBtn" class="btn" onclick="runAnalysis()">ğŸš€ 3æšã‚’çµ±åˆã—ã¦è§£æé–‹å§‹</button>
    <div id="status"></div>
</div>

<div id="result-area"></div>

<script>
    let selectedFiles = [];
    let timerInterval;

    window.onload = () => {
        const saved = localStorage.getItem('gemini_api_key_25');
        if(saved) document.getElementById('apiKey').value = saved;
    };

    function handleFiles(input) {
        const files = Array.from(input.files);
        selectedFiles = selectedFiles.concat(files);
        renderThumbs();
    }

    function renderThumbs() {
        const list = document.getElementById('thumb-list');
        list.innerHTML = '';
        selectedFiles.forEach(file => {
            const img = document.createElement('img');
            img.className = 'thumb';
            const reader = new FileReader();
            reader.onload = e => img.src = e.target.result;
            reader.readAsDataURL(file);
            list.appendChild(img);
        });
        document.getElementById('runBtn').innerText = `ğŸš€ ${selectedFiles.length}æšã‚’çµ±åˆã—ã¦è§£æé–‹å§‹`;
    }

    async function runAnalysis() {
        const key = document.getElementById('apiKey').value;
        if (!key || selectedFiles.length === 0) return alert("ã‚­ãƒ¼ã¨ç”»åƒãŒå¿…è¦ã§ã™");
        localStorage.setItem('gemini_api_key_25', key);

        const status = document.getElementById('status');
        const runBtn = document.getElementById('runBtn');
        runBtn.disabled = true;
        status.innerText = "è§£æä¸­... (30ç§’ã€œ60ç§’ç¨‹åº¦)";
        
        let sec = 0;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => { sec += 0.1; document.getElementById('timer').innerText = `çµŒéæ™‚é–“: ${sec.toFixed(1)}ç§’`; }, 100);

        try {
            // ç”»åƒã‚’1200pxã«ãƒªã‚µã‚¤ã‚ºã—ã¦ãƒ‡ãƒ¼ã‚¿é‡ã‚’æœ€é©åŒ–
            const base64Images = await Promise.all(selectedFiles.map(file => resizeImg(file)));
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: "ã“ã‚Œã‚‰ã®å›³é¢ï¼ˆç«‹é¢å›³ãƒ»å¹³é¢å›³ï¼‰ã‚’å…¨ã¦èª­ã¿å–ã‚Šã€å±‹æ ¹å‹¾é…ã€è»’ã®å‡ºã€å„éƒ¨ä½ã®é•·ã•ã‚’ç©ç®—ã—ã¦ãã ã•ã„ã€‚çµæœã¯è¡¨å½¢å¼ã§ã€‚å‡ºåŠ›ã¯æ—¥æœ¬èªã§ã€‚" },
                            ...base64Images.map(b64 => ({ inline_data: { mime_type: "image/jpeg", data: b64 } }))
                        ]
                    }]
                })
            });

            const data = await response.json();
            clearInterval(timerInterval);
            
            if (data.error) throw new Error(data.error.message);

            const resultText = data.candidates[0].content.parts[0].text;
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('result-area').innerText = resultText;
            status.innerText = "âœ… è§£æå®Œäº†";

        } catch (e) {
            clearInterval(timerInterval);
            status.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
            console.error(e);
        } finally {
            runBtn.disabled = false;
        }
    }

    function resizeImg(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 1200;
                    const scale = Math.min(1, max / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
            };
        });
    }
</script>
</body>
</html>
