<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v3.0 - Ultimate Strict Mode</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; --success: #1e8e3e; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { position: relative; min-width: 80px; height: 80px; background: #eee; border-radius: 8px; border: 1px solid #dadce0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; }
        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .analyze-btn:disabled { background: #ccc; }
        .res-label { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-bottom: 5px; color: white; font-weight: bold; }
        .bg-blue { background: var(--primary); }
        .bg-red { background: var(--error); }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; }
        #logArea { background: #202124; color: #34a853; font-family: monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
        #formulaText { font-size: 0.85rem; line-height: 1.6; background: #e8f0fe; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid var(--primary); }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" style="width:100%; padding:12px; border:1px solid #dadce0; border-radius:8px; box-sizing:border-box;" placeholder="Gemini API Key">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢é¸æŠãƒ»æ’®å½± (è¤‡åˆãƒ»çµ±åˆè§£æ)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ  (ç”»åƒ/PDF)
        <input type="file" id="fileInput" accept="image/*,application/pdf" multiple style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">å³æ ¼çµ±åˆè§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š è§£æçµæœã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤</h1>
    <div>
        <span class="res-label bg-blue">ã€å¹³é¢æŠ•å½±å›³ã€‘æ°´å¹³å¯¸æ³• (èŠ¯èŠ¯ï¼‹è»’Ã—2)</span>
        <canvas id="planCanvas"></canvas>
    </div>
    <div>
        <span class="res-label bg-red" id="slopeLabel">ã€å®Ÿå¯¸æ³•å›³ã€‘å‹¾é…å€ç‡é©ç”¨</span>
        <canvas id="slopeCanvas"></canvas>
    </div>
    <div id="formulaText"></div>
</div>

<div class="card">
    <h1>ğŸ§  æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ãƒ»è¨ˆç®—ãƒ­ã‚°</h1>
    <div id="logArea">å¾…æ©Ÿä¸­...</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const logArea = document.getElementById('logArea');
    const fileInput = document.getElementById('fileInput');

    fileInput.onchange = (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                selectedFiles.push({ file, data: ev.target.result });
                renderPreviews();
            };
            reader.readAsDataURL(file);
        });
        fileInput.value = "";
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            div.innerHTML = f.file.type.includes('image') ? `<img src="${f.data}">` : `ğŸ“„ PDF`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’ã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„");
        
        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        logArea.innerText = "--- å³æ ¼è§£æã‚·ãƒ¼ã‚±ãƒ³ã‚¹é–‹å§‹ ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview", 
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å»ºç¯‰å›³é¢è§£æãƒ»å±‹æ ¹çµ±åˆå¯¸æ³•æŠ½å‡º (v3.0 å³æ ¼ãƒ¢ãƒ¼ãƒ‰)
ã‚ãªãŸã¯å±‹æ ¹å¯¸æ³•è§£æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®æ‰‹é †ã‚’å®Œé‚ã—ã€è¤‡åˆçš„ãªå±‹æ ¹æ§‹é€ ã‚’ä¸€ã¤ã®åº§æ¨™ç³»ã§å‡ºåŠ›ã›ã‚ˆã€‚

#### Step 0: å±‹æ ¹ãŒå¿…è¦ãªå£ã®ç‰¹å®š (æœ€é‡è¦)
- å¹³é¢å›³ã®å¤ªç·šãƒ©ã‚¤ãƒ³ä»˜è¿‘ã«ã€ŒLDK/æ´‹å®¤/å’Œå®¤/ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ/ã‚µãƒƒã‚·/é–‹å£éƒ¨ã€ç­‰ã®æ³¨è¨˜ãŒã‚ã‚‹ã‹ç¢ºèªã›ã‚ˆã€‚
- ã“ã‚Œã‚‰ãŒã‚ã‚‹ç®‡æ‰€ã¯ã€Œå±‹å†…ã€ã§ã‚ã‚Šã€å¿…ãšãã®ä¸Šéƒ¨ã«å±‹æ ¹ã‚’é…ç½®ã™ã‚‹ã“ã¨ã€‚
- ã€Œãƒ™ãƒ©ãƒ³ãƒ€ã€ã€Œãƒãƒ«ã‚³ãƒ‹ãƒ¼ã€ç­‰ã¯ã€ç«‹é¢å›³ã§ä¸»å±‹æ ¹ãŒè¢«ã£ã¦ã„ã‚‹ã‹å³å¯†ã«ç¢ºèªã›ã‚ˆã€‚

#### Step 1: å‹¾é…ã®è‡ªå‹•æ¤œå‡º
- å›³é¢ã‹ã‚‰ã€Œâ—‹å¯¸ã€ã€Œâ—‹/10ã€ã¨ã„ã†å‹¾é…è¡¨è¨˜ã‚’æ¢ã›ã€‚è¦‹å½“ãŸã‚‰ãªã„å ´åˆã¯3.5å¯¸ã¨ä»®å®šã›ã‚ˆã€‚

#### Step 2: è¤‡åˆæ§‹é€ ã®åˆ†è§£ã¨é…ç½®
- å»ºç‰©å…¨ä½“ã®å·¦ä¸Šã‚’åŸç‚¹(0,0)ã¨ã—ã€å„å±‹æ ¹ãƒ‘ãƒ¼ãƒ„ï¼ˆä¸»å±‹æ ¹ã€ä¸‹å±‹ã€ãƒãƒ¼ãƒç­‰ï¼‰ã®åº§æ¨™(pos_x, pos_y)ã¨å¯¸æ³•ã‚’ç‰¹å®šã›ã‚ˆã€‚

å½¢å¼(JSON):
{
  "detected_slope": 3.5,
  "slope_factor": 1.0595,
  "total_width_mm": å»ºç‰©å…¨ä½“ã®æœ€å¤§å¹…,
  "total_depth_mm": å»ºç‰©å…¨ä½“ã®æœ€å¤§å¥¥è¡Œ,
  "planes": [
    {
      "name": "ä¸»å±‹æ ¹",
      "pos_x": 0, "pos_y": 0,
      "width_mm": 11475, "depth_mm": 7280,
      "ridge_mm": 4195,
      "shape": "å¯„æ£Ÿ/åˆ‡å¦»/ç‰‡æµã‚Œ",
      "flow_length_mm": å‹¾é…é©ç”¨å¾Œã®æµã‚Œé•·ã•,
      "reasoning": "LDKç­‰ã®æ³¨è¨˜ã«åŸºã¥ãåˆ¤å®šç†ç”±"
    }
  ],
  "step_logs": "è¨ˆç®—ã®æ ¹æ‹ ï¼ˆä¾‹: Xè»¸ 2025+900+...ï¼‰"
}`;

            const parts = selectedFiles.map(f => ({
                inlineData: { data: f.data.split(',')[1], mimeType: f.file.type }
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('slopeLabel').innerText = `ã€å®Ÿå¯¸æ³•å›³ã€‘${data.detected_slope}å¯¸å‹¾é…é©ç”¨`;
            document.getElementById('formulaText').innerHTML = `<b>AIã®è¨ˆç®—ãƒ­ã‚°:</b><br>${data.step_logs.replace(/\n/g, '<br>')}`;
            
            renderRoof(data, 'planCanvas', false);
            renderRoof(data, 'slopeCanvas', true);
            logArea.innerText += "\nè§£æå®Œäº†ã€‚";

        } catch (e) { logArea.innerText += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`; }
        finally { btn.disabled = false; }
    };

    function renderRoof(data, canvasId, isActual) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas.getContext('2d');
        canvas.width = 1000; canvas.height = 500;
        
        const pad = 60;
        const scale = Math.min((canvas.width - pad*2) / data.total_width_mm, (canvas.height - pad*2) / data.total_depth_mm);
        const factor = isActual ? data.slope_factor : 1.0;
        const hip_factor = isActual ? Math.sqrt(Math.pow(data.slope_factor, 2) + 1) / Math.sqrt(2) : 1.0;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        data.planes.forEach(p => {
            const x = pad + p.pos_x * scale;
            const y = pad + p.pos_y * scale;
            const w = p.width_mm * scale;
            const h = p.depth_mm * scale;

            ctx.strokeStyle = isActual ? "#d93025" : "#1a73e8";
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);

            // æ§‹é€ ç·š
            ctx.beginPath();
            if(p.shape.includes("å¯„æ£Ÿ")) {
                const off = (w - (p.ridge_mm * scale)) / 2;
                ctx.moveTo(x, y); ctx.lineTo(x + off, y + h/2); ctx.lineTo(x, y + h);
                ctx.moveTo(x + w, y); ctx.lineTo(x + w - off, y + h/2); ctx.lineTo(x + w, y + h);
                ctx.moveTo(x + off, y + h/2); ctx.lineTo(x + w - off, y + h/2);
            } else if(p.shape.includes("åˆ‡å¦»")) {
                ctx.moveTo(x, y + h/2); ctx.lineTo(x + w, y + h/2);
            }
            ctx.stroke();

            // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å¯¸æ³•è¡¨ç¤º
            ctx.fillStyle = ctx.strokeStyle;
            ctx.font = "bold 13px sans-serif";
            ctx.textAlign = "center";
            
            // X/Yå¯¸æ³•
            ctx.fillText(`${p.name} X: ${p.width_mm}`, x + w/2, y - 10);
            ctx.save();
            ctx.translate(x - 10, y + h/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText(`Y: ${p.depth_mm}`, 0, 0);
            ctx.restore();

            // æµã‚Œ/å¤§æ£Ÿ/éš…ã®å®Ÿå¯¸è¡¨ç¤º
            if(isActual) {
                ctx.fillText(`æµã‚Œ: ${Math.round(p.flow_length_mm)}mm`, x + w/2, y + h/4);
                if(p.ridge_mm > 0) ctx.fillText(`å¤§æ£Ÿ: ${p.ridge_mm}mm`, x + w/2, y + h/2 - 5);
            }
        });
    }
</script>
</body>
</html>
