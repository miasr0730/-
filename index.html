<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å±‹æ ¹ç©ç®— AI - è¤‡æ•°ç”»åƒå¯¾å¿œç‰ˆ</title>
    <style>
        :root { --primary: #0284c7; --bg: #f8fafc; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; color: #334155; }
        .container { background: white; padding: 30px; border-radius: 24px; max-width: 900px; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .upload-area { border: 2px dashed #cbd5e1; padding: 40px; text-align: center; border-radius: 16px; cursor: pointer; background: #fff; transition: 0.3s; }
        .upload-area:hover { border-color: var(--primary); background: #f0f9ff; }
        #thumb-list { display: flex; gap: 10px; margin: 15px 0; overflow-x: auto; padding: 10px; }
        .thumb { height: 100px; border-radius: 8px; border: 2px solid #e2e8f0; }
        .btn { width: 100%; padding: 20px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.2rem; cursor: pointer; margin-top: 10px; }
        .btn:disabled { background: #94a3b8; }
        #status { margin-top: 20px; text-align: center; font-weight: bold; color: var(--primary); min-height: 1.5em; }
        .logic-card { background: #f1f5f9; border-left: 5px solid var(--primary); padding: 20px; margin: 20px 0; border-radius: 8px; white-space: pre-wrap; font-size: 0.95rem; }
        .svg-viewer { background: #1e293b; border-radius: 16px; padding: 30px; text-align: center; margin: 20px 0; overflow: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; border-bottom: 1px solid #e2e8f0; text-align: left; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center;">å±‹æ ¹ç©ç®— AI <span style="color:var(--primary);">Multi-Vision</span></h2>
    
    <input type="password" id="apiKey" style="width:100%; padding:12px; margin-bottom:20px; border:1px solid #ddd; border-radius:8px;" placeholder="Gemini API Keyã‚’å…¥åŠ›">

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“‚ å›³é¢ã‚’è¤‡æ•°æšé¸æŠï¼ˆç«‹é¢å›³ãƒ»å„éšå¹³é¢å›³ï¼‰</strong>
        <p style="font-size:0.85rem; color:#64748b;">ã‚¹ãƒãƒ›ã®å ´åˆã¯ã€Œå†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€ã‹ã‚‰è¤‡æ•°æšé¸æŠã—ã¦ãã ã•ã„</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFileSelect(this)">
    </div>

    <div id="thumb-list"></div>

    <button id="runBtn" class="btn" onclick="executeAI()">å…¨ã¦ã®å›³é¢ã‚’è§£æã—ã¦ç©ç®—</button>
    <div id="status"></div>

    <div id="result-area" style="display:none;">
        <h4>ğŸ§ è§£æã®åˆ¤æ–­æ ¹æ‹ </h4>
        <div class="logic-card" id="logic-output"></div>
        <h4>ğŸ“ ç”Ÿæˆã•ã‚ŒãŸå±‹æ ¹ä¼å›³</h4>
        <div class="svg-viewer" id="svg-output"></div>
        <table>
            <thead><tr><th>éƒ¨ä½</th><th>ç®—å‡ºå¯¸æ³•</th><th>åˆ¤å®šæ ¹æ‹ </th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    let selectedFiles = [];

    function handleFileSelect(input) {
        const list = document.getElementById('thumb-list');
        list.innerHTML = '';
        selectedFiles = Array.from(input.files);

        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'thumb';
                list.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('status').innerText = selectedFiles.length + "æšã®å›³é¢ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚";
    }

    async function executeAI() {
        const key = document.getElementById('apiKey').value;
        if(!key || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ç”»åƒãŒå¿…è¦ã§ã™ã€‚");

        const btn = document.getElementById('runBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = "è¤‡æ•°æšã®ç”»åƒã‚’çµ±åˆè§£æä¸­...ï¼ˆã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ï¼‰";

        try {
            // å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Base64å¤‰æ›
            const b64Promises = selectedFiles.map(file => toBase64(file));
            const b64Images = await Promise.all(b64Promises);

            const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®å»ºç¯‰ç©ç®—å£«ã§ã™ã€‚é€ã‚‰ã‚ŒãŸå…¨ã¦ã®å›³é¢ï¼ˆç«‹é¢å›³ã€å„éšå¹³é¢å›³ï¼‰ã‚’ç›¸äº’ã«ç…§ã‚‰ã—åˆã‚ã›ã¦è§£æã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ï¼šè§£æã®å„ªå…ˆé †ä½ã€‘
1. **å½¢çŠ¶**: ç«‹é¢å›³ã‚’å…¨æ–¹ä½ç¢ºèªã—ã€å¯„æ£Ÿï¼ˆ4é¢ï¼‰ã‹åˆ‡å¦»ï¼ˆ2é¢ï¼‰ã‹ç­‰ã‚’æ­£ã—ãåˆ¤å®šã€‚
2. **éšå±¤ã¨å¯¸æ³•**: 
   - 1Få¹³é¢å›³ã¨2Få¹³é¢å›³ã‚’æ¯”è¼ƒã—ã€å±‹æ ¹ãŒè¼‰ã£ã¦ã„ã‚‹éšã®å¤–å£ãƒ©ã‚¤ãƒ³ã‚’ç‰¹å®šã€‚
   - ãƒãƒ«ã‚³ãƒ‹ãƒ¼ã‚„ãƒãƒ¼ãƒã®å‡ºã£å¼µã‚Šã¯ã€Œå±‹æ ¹ã®åŸºæº–ã€ã‹ã‚‰é™¤å¤–ã—ã€æœ¬ä½“ã®å¤–å£ï¼ˆå¤–é¢ã‹ã‚‰å¤–é¢ã¾ã§ï¼‰ã®å¯¸æ³•ã‚’æ¡ç”¨ã€‚
3. **æ•°å€¤ã®æŠ½å‡º**: ç«‹é¢å›³ã«ã‚ã‚‹ã€Œè»’ã®å‡ºï¼ˆ275mmç­‰ï¼‰ã€ã¨ã€å¹³é¢å›³ã«ã‚ã‚‹ã€Œ2éšå¤–å£ã®æ¨ªå¹…ï¼ˆ11475mmç­‰ï¼‰ã€ã‚’çµ„ã¿åˆã‚ã›ã¦å±‹æ ¹ã‚µã‚¤ã‚ºã‚’è¨ˆç®—ã€‚

ã€å‡ºåŠ›å½¢å¼ã€‘
1. è§£æã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ï¼ˆæ—¥æœ¬èªï¼‰
2. å±‹æ ¹ä¼å›³ï¼ˆSVGå½¢å¼ã€å¯„æ£Ÿãªã‚‰4é¢æç”»ã€èƒŒæ™¯é€æ˜ãƒ»ç·šã¯ç™½ï¼‰
3. ç©ç®—ãƒ‡ãƒ¼ã‚¿JSONï¼ˆ%%%JSON_START%%% ã¨ %%%JSON_END%%% ã§å›²ã‚€ï¼‰`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            ...b64Images.map(data => ({ inline_data: { mime_type: "image/jpeg", data } }))
                        ]
                    }]
                })
            });

            const result = await response.json();
            const text = result.candidates[0].content.parts[0].text;
            
            displayResults(text);
            status.innerText = "âœ… è§£æå®Œäº†";

        } catch (e) {
            status.innerText = "âŒ è§£æã‚¨ãƒ©ãƒ¼: " + e.message;
            console.error(e);
        } finally {
            btn.disabled = false;
        }
    }

    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => {
                // è§£åƒåº¦ã‚’ç¶­æŒã—ã¤ã¤ãƒ‡ãƒ¼ã‚¿é‡ã‚’èª¿æ•´
                const img = new Image();
                img.src = reader.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 1600; 
                    const scale = Math.min(1, max / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.85).split(',')[1]);
                };
            };
            reader.onerror = error => reject(error);
        });
    }

    function displayResults(text) {
        document.getElementById('result-area').style.display = 'block';
        document.getElementById('logic-output').innerText = text.split('%%%')[0];
        
        const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/);
        if(svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];

        const jsonMatch = text.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);
        if(jsonMatch) {
            const items = JSON.parse(jsonMatch[1]).items;
            document.getElementById('table-body').innerHTML = items.map(it => 
                `<tr><td><b>${it.name || it.type}</b></td><td>${it.value || it.length_mm}</td><td>${it.note || ''}</td></tr>`
            ).join('');
        }
    }
</script>
</body>
</html>
