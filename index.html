<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v2.5 - çµ±åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç‰ˆ</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: var(--primary); }
        .upload-label { display: block; border: 2px dashed var(--primary); color: var(--primary); padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #masterCanvas { width: 100%; background: #fff; border: 1px solid #ddd; border-radius: 8px; }
        #logArea { background: #202124; color: #34a853; font-family: monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; margin-top: 10px; }
        .summary-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .summary-table th, .summary-table td { border: 1px solid #eee; padding: 8px; text-align: left; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" style="width:100%; padding:12px; border:1px solid #dadce0; border-radius:8px; box-sizing:border-box;" placeholder="Gemini API Key">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢è§£æãƒ»çµ±åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h1>
    <label class="upload-label">
        ğŸ“„ å›³é¢ã‚’è¿½åŠ  (å¹³é¢/ç«‹é¢)
        <input type="file" id="fileInput" accept="image/*,application/pdf" style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">çµ±åˆæ§‹é€ è§£æã‚’å®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ  çµ±åˆå¹³é¢æŠ•å½±å›³ (Master Plan)</h1>
    <canvas id="masterCanvas"></canvas>
    <div id="summaryArea"></div>
</div>

<div class="card">
    <h1>ğŸ§  è§£æãƒ­ã‚°</h1>
    <div id="logArea">å¾…æ©Ÿä¸­...</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');

    fileInput.onchange = (e) => {
        if (e.target.files[0]) selectedFiles.push(e.target.files[0]);
    };

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ãŒå¿…è¦ã§ã™");

        const logArea = document.getElementById('logArea');
        logArea.innerText = "--- çµ±åˆè§£æé–‹å§‹ ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-1.5-flash",
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å±‹æ ¹æ§‹é€ çµ±åˆè§£æãƒ—ãƒ­ãƒˆã‚³ãƒ«
å›³é¢ã‹ã‚‰ã™ã¹ã¦ã®å±‹æ ¹è¦ç´ ã‚’æŠ½å‡ºã—ã€ä¸€ã¤ã®åº§æ¨™ç³»ã«çµ±åˆã›ã‚ˆã€‚

## å³æ ¼ãƒ«ãƒ¼ãƒ«
1. ã€å±…å®¤åˆ¤å®šã€‘: LDK/æ´‹å®¤/å’Œå®¤/ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ/ã‚µãƒƒã‚·ç­‰ã®è¡¨è¨˜ãŒã‚ã‚‹å£ã¯ã€Œå±‹å†…ã€ã¨ã—ã€ãã®ä¸Šéƒ¨ã«ã¯å¿…ãšå±‹æ ¹ã‚’é…ç½®ã›ã‚ˆã€‚
2. ã€å‹¾é…è‡ªå‹•å–å¾—ã€‘: å›³é¢å†…ã®ã€Œå¯¸ã€ã¾ãŸã¯ã€Œ/10ã€è¡¨è¨˜ã‹ã‚‰å‹¾é…ã‚’èª­ã¿å–ã‚Œã€‚
3. ã€ç©ºé–“åº§æ¨™ã€‘: å»ºç‰©å…¨ä½“ã®å·¦ä¸Šã‚’(x:0, y:0)ã¨ã—ã€å„ãƒ‘ãƒ¼ãƒ„ã®é–‹å§‹åº§æ¨™(pos_x, pos_y)ã‚’ç®—å‡ºã›ã‚ˆã€‚

## å‡ºåŠ›JSONå½¢å¼
{
  "detected_slope": 3.5,
  "total_width_mm": å»ºç‰©å…¨ä½“ã®æœ€å¤§å¹…,
  "total_depth_mm": å»ºç‰©å…¨ä½“ã®æœ€å¤§å¥¥è¡Œ,
  "planes": [
    {
      "name": "ä¸»å±‹æ ¹",
      "pos_x": 0,
      "pos_y": 0,
      "width_mm": 11475,
      "depth_mm": 7280,
      "shape": "å¯„æ£Ÿ/åˆ‡å¦»/ç‰‡æµã‚Œ",
      "flow_length_mm": å‹¾é…ã‚’åŠ å‘³ã—ãŸæµã‚Œæ–¹å‘ã®é•·ã•,
      "ridge_mm": å¤§æ£Ÿé•·ã•
    },
    {
      "name": "ç„é–¢ãƒãƒ¼ãƒ",
      "pos_x": 4550,
      "pos_y": 7280,
      "width_mm": 1820,
      "depth_mm": 910,
      "shape": "ç‰‡æµã‚Œ",
      "flow_length_mm": 950,
      "ridge_mm": 0
    }
  ],
  "log": "è§£æã®æ ¹æ‹ ï¼ˆLDKç¢ºèªã€åº§æ¨™è¨ˆç®—ç­‰ï¼‰"
}`;

            const parts = await Promise.all(selectedFiles.map(async f => {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(f);
                });
                return { inlineData: { data: base64, mimeType: f.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text());

            drawMasterPlan(data);
            logArea.innerText = data.log;
            document.getElementById('resultCard').style.display = 'block';

        } catch (e) { logArea.innerText += "\nâŒ ã‚¨ãƒ©ãƒ¼: " + e.message; }
    };

    function drawMasterPlan(data) {
        const canvas = document.getElementById('masterCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 500;
        
        const padding = 50;
        const scale = Math.min((canvas.width - padding*2) / data.total_width_mm, (canvas.height - padding*2) / data.total_depth_mm);

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        data.planes.forEach((p, i) => {
            const x = padding + p.pos_x * scale;
            const y = padding + p.pos_y * scale;
            const w = p.width_mm * scale;
            const h = p.depth_mm * scale;

            // å±‹æ ¹ã®é¢ã‚’æç”»
            ctx.strokeStyle = "#1a73e8";
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, w, h);
            ctx.fillStyle = "rgba(26, 115, 232, 0.1)";
            ctx.fillRect(x, y, w, h);

            // ç°¡æ˜“çš„ãªæ§‹é€ ç·šï¼ˆå¯„æ£Ÿã®å ´åˆï¼‰
            if(p.shape === "å¯„æ£Ÿ") {
                const offset = (w - (p.ridge_mm * scale)) / 2;
                ctx.beginPath();
                ctx.moveTo(x, y); ctx.lineTo(x + offset, y + h/2);
                ctx.lineTo(x, y + h);
                ctx.moveTo(x + w, y); ctx.lineTo(x + w - offset, y + h/2);
                ctx.lineTo(x + w, y + h);
                ctx.moveTo(x + offset, y + h/2); ctx.lineTo(x + w - offset, y + h/2);
                ctx.stroke();
            }

            // ãƒ©ãƒ™ãƒ«
            ctx.fillStyle = "#1a73e8";
            ctx.font = "12px sans-serif";
            ctx.fillText(`${p.name}: ${p.width_mm}Ã—${p.depth_mm}`, x, y - 5);
        });

        // é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        let html = `<table class="summary-table"><tr><th>éƒ¨ä½</th><th>æ±è¥¿(X)</th><th>å—åŒ—(Y)</th><th>æµã‚Œ(å‚ç›´)</th><th>å½¢çŠ¶</th></tr>`;
        data.planes.forEach(p => {
            html += `<tr><td>${p.name}</td><td>${p.width_mm}</td><td>${p.depth_mm}</td><td>${p.flow_length_mm}</td><td>${p.shape}</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('summaryArea').innerHTML = html;
    }
</script>
</body>
</html>
