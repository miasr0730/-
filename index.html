<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI Vision Ultimate</title>
    <style>
        :root { --primary: #2563eb; --dark: #0f172a; --accent: #f59e0b; --bg: #f8fafc; --success: #22c55e; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; padding: 20px; background: var(--bg); margin: 0; color: #333; }
        .container { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); max-width: 800px; margin: auto; }
        
        h1 { text-align: center; color: var(--dark); margin-bottom: 20px; font-size: 1.4rem; }
        
        /* APIã‚­ãƒ¼è¨­å®š */
        .api-box { background: #eff6ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bfdbfe; }
        .api-row { display: flex; gap: 10px; margin-top: 8px; }
        input[type="password"] { flex: 1; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; }
        .btn-small { padding: 8px 24px; background: var(--dark); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; border-radius: 16px; margin-bottom: 20px; background: #fff; cursor: pointer; transition: 0.2s; display: block; }
        .upload-area:hover { border-color: var(--primary); background: #f0f9ff; }
        .file-label { font-weight: bold; color: var(--primary); font-size: 1.1rem; display: block; }
        .file-desc { font-size: 0.85rem; color: #64748b; margin-top: 5px; }

        /* ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º */
        #thumb-list { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 15px; padding-bottom: 5px; }
        .thumb { height: 70px; border-radius: 6px; border: 1px solid #ddd; object-fit: cover; }

        /* è§£æã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
        #status { display: none; padding: 15px; background: #fff7ed; border-radius: 8px; color: #c2410c; margin-bottom: 20px; font-weight: bold; border: 1px solid #ffedd5; text-align: center; }
        .loading::after { content: " â³"; animation: spin 1s infinite linear; }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-area { display: none; margin-top: 20px; border-top: 2px solid #f1f5f9; padding-top: 20px; }
        .svg-container { background: #1e293b; border-radius: 12px; padding: 20px; text-align: center; overflow-x: auto; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; }
        svg { max-width: 100%; height: auto; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }
        
        /* é›†è¨ˆãƒ†ãƒ¼ãƒ–ãƒ« */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f1f5f9; color: #475569; font-weight: 600; }
        .total-row { font-weight: bold; background: #f8fafc; color: var(--primary); border-top: 2px solid #e2e8f0; }
        
        .action-btn { width: 100%; margin-top: 10px; padding: 15px; border: none; border-radius: 10px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .primary-btn { background: var(--primary); color: white; }
        .success-btn { background: var(--success); color: white; margin-top: 20px; }
        .action-btn:active { transform: scale(0.98); }

    </style>
</head>
<body>

<div class="container">
    <h1>å±‹æ ¹ç©ç®— AI Vision Ultimate</h1>
    
    <div class="api-box">
        <label style="font-size:0.8rem; font-weight:bold; color:#1e40af;">ğŸ”‘ Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›</label>
        <div class="api-row">
            <input type="password" id="apiKey" placeholder="AI Studioã§å–å¾—ã—ãŸã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘">
            <button class="btn-small" onclick="saveSettings()">ä¿å­˜</button>
        </div>
    </div>

    <label class="upload-area">
        <span class="file-label">ğŸ“· å›³é¢ã‚’é¸æŠ (è¤‡æ•°é¸æŠå¯)</span>
        <span class="file-desc">å¹³é¢å›³ã¨ç«‹é¢å›³ã‚’ã‚»ãƒƒãƒˆã§é¸ã¶ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™</span>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="handleFiles(this)" style="display: none;">
    </label>

    <div id="thumb-list"></div>

    <button id="analyzeBtn" class="action-btn primary-btn" style="display:none;" onclick="runAI()">ğŸš€ AIç©ç®—ãƒ»å±‹æ ¹ä¼å›³ç”Ÿæˆã‚’é–‹å§‹</button>

    <div id="status"></div>

    <div id="result-area">
        <h3 style="margin-top:0;">ğŸ¤– ç”Ÿæˆã•ã‚ŒãŸå±‹æ ¹ä¼å›³</h3>
        <div class="svg-container" id="svg-output"></div>

        <h3>ğŸ“‹ ç©ç®—æ˜ç´°ãƒªã‚¹ãƒˆ</h3>
        <div style="overflow-x:auto;">
            <table id="calc-table">
                <thead>
                    <tr>
                        <th>éƒ¨ä½</th>
                        <th>åç§°ãƒ»å ´æ‰€</th>
                        <th>é•·ã• (mm)</th>
                        <th>è©³ç´°æƒ…å ±</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
        
        <button class="action-btn success-btn" onclick="copyTable()">ğŸ“‹ è¡¨ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Excelã«è²¼ã‚Šä»˜ã‘</button>
    </div>
</div>

<script>
    const FIXED_MODEL = "gemini-2.5-flash"; // ãƒ¢ãƒ‡ãƒ«ã‚’å›ºå®š

    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_api_key');
        if(savedKey) document.getElementById('apiKey').value = savedKey;
    };

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('apiKey').value);
        alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
    }

    let selectedFiles = [];

    function handleFiles(input) {
        selectedFiles = Array.from(input.files);
        const list = document.getElementById('thumb-list');
        list.innerHTML = '';
        
        if (selectedFiles.length > 0) {
            document.getElementById('analyzeBtn').style.display = 'block';
            selectedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'thumb';
                    list.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        }
    }

    async function runAI() {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.innerHTML = `æœ€æ–°ãƒ¢ãƒ‡ãƒ«(${FIXED_MODEL})ã§è§£æä¸­... <span class='loading'></span>`;
        document.getElementById('result-area').style.display = 'none';

        try {
            const imagePromises = selectedFiles.map(file => resizeImage(file, 1200));
            const base64Images = await Promise.all(imagePromises);
            
            const prompt = `
ã‚ãªãŸã¯å±‹æ ¹ç©ç®—ã®å°‚é–€å®¶ã§ã™ã€‚æä¾›ã•ã‚ŒãŸå…¨ã¦ã®å›³é¢ã‹ã‚‰å±‹æ ¹ã®å½¢çŠ¶ã‚’ç«‹ä½“çš„ã«æŠŠæ¡ã—ã€ä»¥ä¸‹ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

1. ã€å±‹æ ¹ä¼å›³ã®SVGã€‘
   - çœŸä¸Šã‹ã‚‰è¦‹ãŸå›³ã€‚èƒŒæ™¯é€æ˜ã€ç·šã¯ç™½(#ffffff)ã€‚
   - è»’å…ˆã€ã‚±ãƒ©ãƒã€æ£Ÿã€éš…æ£Ÿã€è°·ã‚’ç·šã§æãã€ãã‚Œãã‚Œã®è¾ºã®æ¨ªã«ç®—å‡ºã—ãŸãƒŸãƒªå˜ä½ã®æ•°å€¤ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚
   - SVGã‚¿ã‚°ã®ã¿å‡ºåŠ›ã€‚

2. ã€ç©ç®—ãƒ‡ãƒ¼ã‚¿JSONã€‘
   - ä»¥ä¸‹ã®å½¢å¼ã§ã€å…¨ã¦ã®è¾ºï¼ˆæ–œã‚ã€æ°´å¹³å•ã‚ãšï¼‰ã‚’ç¶²ç¾…ã—ã¦ãã ã•ã„ã€‚
   %%%JSON_START%%%
   {
     "items": [
       { "type": "è»’å…ˆ", "name": "å—é¢", "length_mm": 4550, "note": "æ°´å¹³" },
       { "type": "ã‚±ãƒ©ãƒ", "name": "æ±é¢", "length_mm": 3800, "note": "å‹¾é…ãªã‚Š" },
       { "type": "ç™»ã‚Š", "name": "å—é¢", "length_mm": 4900, "note": "å‹¾é…å®Ÿå¯¸" },
       { "type": "æ£Ÿ", "name": "å¤§æ£Ÿ", "length_mm": 9100, "note": "æ°´å¹³" }
     ],
     "summary": "å±‹æ ¹å½¢çŠ¶ã¨å‹¾é…ã®åˆ¤æ–­æ ¹æ‹ ã‚’çŸ­ã"
   }
   %%%JSON_END%%%
`;

            const contentParts = [{ text: prompt }];
            base64Images.forEach(b64 => {
                contentParts.push({ inline_data: { mime_type: "image/jpeg", data: b64.split(',')[1] } });
            });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${FIXED_MODEL}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: contentParts }] })
            });

            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const rawText = data.candidates[0].content.parts[0].text;
            
            // SVGã¨JSONã®æŠ½å‡º
            const svgMatch = rawText.match(/<svg[\s\S]*?<\/svg>/);
            const jsonMatch = rawText.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);

            if (svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];
            
            if (jsonMatch) {
                const jsonData = JSON.parse(jsonMatch[1].trim());
                const tbody = document.getElementById('table-body');
                tbody.innerHTML = "";
                let total = 0;
                
                jsonData.items.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><b style="color:var(--primary)">${item.type}</b></td>
                        <td>${item.name}</td>
                        <td style="font-weight:bold">${item.length_mm.toLocaleString()}</td>
                        <td style="font-size:0.8rem; color:#666">${item.note}</td>
                    `;
                    tbody.appendChild(tr);
                    total += item.length_mm;
                });
                
                const totalTr = document.createElement('tr');
                totalTr.className = "total-row";
                totalTr.innerHTML = `<td colspan="2">åˆè¨ˆå»¶é•·</td><td>${total.toLocaleString()} mm</td><td></td>`;
                tbody.appendChild(totalTr);

                status.innerHTML = `âœ… è§£æå®Œäº†: ${jsonData.summary}`;
                status.style.color = "var(--success)";
                document.getElementById('result-area').style.display = 'block';
            }

        } catch (e) {
            status.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
            status.style.color = "red";
        }
    }

    function resizeImage(file, maxWidth) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (ev) => {
                const img = new Image();
                img.src = ev.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const scale = maxWidth / img.width;
                    canvas.width = (scale < 1) ? maxWidth : img.width;
                    canvas.height = (scale < 1) ? img.height * scale : img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8));
                };
            };
        });
    }

    function copyTable() {
        const table = document.getElementById('calc-table');
        const range = document.createRange();
        range.selectNode(table);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        document.execCommand('copy');
        alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚Excelã§ã€Œè²¼ã‚Šä»˜ã‘ã€ã—ã¦ãã ã•ã„ã€‚");
    }
</script>

</body>
</html>
