<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v1.1 - Gemini 3 Flash</title>
    <style>
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin: 0 0 15px 0; color: #1a73e8; display: flex; align-items: center; }
        
        /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; min-height: 90px; }
        .thumb-wrapper { position: relative; min-width: 80px; height: 80px; }
        .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #dadce0; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: var(--error); color: white; border-radius: 50%; width: 24px; height: 24px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        input[type="password"] { width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; }
        .upload-label { display: block; background: #fff; border: 2px dashed #1a73e8; color: #1a73e8; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; font-weight: 500; margin-bottom: 10px; }
        
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        .analyze-btn:disabled { background: #ccc; cursor: not-allowed; }
        
        #resultCard { border-left: 5px solid var(--primary); }
        .result-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .result-item { background: #e8f0fe; padding: 10px; border-radius: 8px; text-align: center; }
        .result-label { font-size: 0.75rem; color: #5f6368; }
        .result-value { font-size: 1.2rem; font-weight: bold; color: var(--primary); }

        #logArea { background: #202124; color: #34a853; font-family: 'Courier New', Courier, monospace; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; line-height: 1.4; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; }
    </style>
</head>
<body>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" placeholder="Gemini API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    <p style="font-size:0.7rem; color:#70757a; margin:0;">â€»ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</p>
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢æ’®å½± (å¹³é¢å›³ + ç«‹é¢å›³)</h1>
    <div id="previewContainer"></div>
    <label class="upload-label">
        ğŸ“· å†™çœŸã‚’æ’®å½±ã¾ãŸã¯è¿½åŠ 
        <input type="file" id="fileInput" accept="image/*" style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">å³æ ¼è§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ</button>
    <button id="clearBtn" style="width:100%; background:none; border:none; color:var(--error); margin-top:15px; font-size:0.8rem; cursor:pointer;">å…¨ã¦ã®å†™çœŸã‚’å‰Šé™¤</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š è§£æçµæœ (èŠ¯èŠ¯å¯¸æ³• + è»’)</h1>
    <div class="result-grid">
        <div class="result-item">
            <div class="result-label">Xè»¸ (æ±è¥¿)</div>
            <div id="valX" class="result-value">--</div>
        </div>
        <div class="result-item">
            <div class="result-label">Yè»¸ (å—åŒ—)</div>
            <div id="valY" class="result-value">--</div>
        </div>
    </div>
    <div id="formulaText" style="font-size:0.85rem; margin-top:10px; color:#5f6368;"></div>
    <canvas id="roofCanvas"></canvas>
</div>

<div class="card">
    <h1>ğŸ§  AIã®æ€è€ƒãƒ»åˆ¤å®šæ ¹æ‹ </h1>
    <div id="logArea">å¾…æ©Ÿä¸­... å›³é¢ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€Œè§£æã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const logArea = document.getElementById('logArea');
    const apiKeyInput = document.getElementById('apiKey');

    // ã‚­ãƒ¼ã®æ°¸ç¶šåŒ–
    apiKeyInput.value = localStorage.getItem('gemini_key_v1') || '';
    apiKeyInput.onchange = () => localStorage.setItem('gemini_key_v1', apiKeyInput.value);

    // å†™çœŸè¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        selectedFiles.push(file);
        renderPreviews();
        fileInput.value = ""; 
    };

    function renderPreviews() {
        previewContainer.innerHTML = "";
        selectedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const div = document.createElement('div');
                div.className = 'thumb-wrapper';
                div.innerHTML = `<img src="${e.target.result}" class="thumb"><button class="remove-btn" onclick="removePhoto(${index})">Ã—</button>`;
                previewContainer.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    window.removePhoto = (index) => {
        selectedFiles.splice(index, 1);
        renderPreviews();
    };

    document.getElementById('clearBtn').onclick = () => {
        if(confirm("å…¨ã¦ã®å†™çœŸã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            selectedFiles = [];
            renderPreviews();
            document.getElementById('resultCard').style.display = 'none';
            logArea.innerText = "å¾…æ©Ÿä¸­...";
        }
    };

    function log(msg) {
        logArea.innerText += `\n> ${msg}`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        if (!apiKeyInput.value) return alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (selectedFiles.length === 0) return alert("å›³é¢ã‚’æ’®å½±ã—ã¦ãã ã•ã„");

        const btn = document.getElementById('analyzeBtn');
        btn.disabled = true;
        btn.innerText = "ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œä¸­...";
        logArea.innerText = "--- è§£æé–‹å§‹ (Gemini 3 Flash) ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKeyInput.value);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3-flash-preview",
                generationConfig: { responseMimeType: "application/json" }
            });

            const prompt = `
# å»ºç¯‰å›³é¢è§£æãƒ»å±‹æ ¹å¯¸æ³•æŠ½å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (v1.1)
ã‚ãªãŸã¯å±‹æ ¹å¯¸æ³•è§£æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å³æ ¼ã«å®Ÿè¡Œã—ã€æ­£ç¢ºãªå¯¸æ³•ã‚’ç®—å‡ºã—ã¦ãã ã•ã„ã€‚

#### Step 0: ç·šç¨®ãƒ»æ§‹é€ ã®è§£æï¼ˆè¦–è¦šçš„ä»®èª¬ï¼‰
1. å¹³é¢å›³ï¼ˆ2éšï¼‰ã«ãŠã„ã¦ã€æœ€ã‚‚å¤ªã„å®Ÿç·šã§å›²ã¾ã‚ŒãŸé–‰é–é ˜åŸŸã‚’ã€Œå±‹å†…æœ¬ä½“ï¼ˆå±‹æ ¹ã®åœŸå°ï¼‰ã€ã¨ã—ã€ãã®å¤–å´ã«ã‚ã‚‹ç´°ã„å®Ÿç·šã‚„äºŒé‡ç·šï¼ˆãƒ™ãƒ©ãƒ³ãƒ€ãƒ»ãƒãƒ«ã‚³ãƒ‹ãƒ¼ç­‰ï¼‰ã‚’ã€Œå¤–éƒ¨è¨­å‚™ã€ã¨ã—ã¦åˆ†é›¢ã›ã‚ˆã€‚
2. å—åŒ—è»¸ï¼ˆYè»¸ï¼‰ã¨æ±è¥¿è»¸ï¼ˆXè»¸ï¼‰ã®ã€Œå±‹æ ¹ãŒè¼‰ã‚‹ã¹ãä¸»è»¸ã€ã¨ãªã‚‹å¤ªã„å®Ÿç·šã‚’ç‰¹å®šã›ã‚ˆã€‚

#### Step 1: ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã«ã‚ˆã‚‹ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯
1. å¤ªç·šãƒ©ã‚¤ãƒ³ä¸Šã«ã€ŒLDK/æ´‹å®¤/å’Œå®¤/ã‚¯ãƒ­ãƒ¼ã‚¼ãƒƒãƒˆ/ã‚µãƒƒã‚·/é–‹å£éƒ¨ã€ç­‰ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€Œå±‹æ ¹ãŒå¿…è¦ãªå£ã€ã¨ç¢ºå®šã›ã‚ˆã€‚
2. ç´°ç·šå´ã«ã€Œãƒ™ãƒ©ãƒ³ãƒ€/ãƒãƒ«ã‚³ãƒ‹ãƒ¼/å¹æŠœã€ç­‰ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€Œå±‹æ ¹ãŒãªã„ç©ºä¸­éƒ¨åˆ†ã€ã¨ä»®å®šã›ã‚ˆã€‚

#### Step 2: ç«‹é¢å›³ã«ã‚ˆã‚‹ã€Œå±‹æ ¹ã®æœ‰ç„¡ã€æœ€çµ‚å¯©åˆ¤
1. å¹³é¢å›³ã®ã€Œå¤–éƒ¨è¨­å‚™ï¼ˆãƒ™ãƒ©ãƒ³ãƒ€ç­‰ï¼‰ã€ã«ã¤ã„ã¦ã€å¿…ãšç«‹é¢å›³ï¼ˆæ±ãƒ»è¥¿ãƒ»å—ãƒ»åŒ—ï¼‰ã¨ç…§åˆã›ã‚ˆã€‚
2. ç«‹é¢å›³ã®å‚ç›´æ–­é¢ã§ã€ãƒ™ãƒ©ãƒ³ãƒ€ã®ä¸Šã«ã€Œä¸»å±‹æ ¹ã€ãŒè¢«ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã›ã‚ˆã€‚
   - ç©ºãŒè¦‹ãˆã‚‹å ´åˆ: ãã®å¯¸æ³•ã¯åˆç®—ã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã™ã‚‹ã€‚
   - ç«‹é¢å›³ã®å»ºç‰©ç«¯ã‹ã‚‰ç«¯ã¾ã§ã®æ°´å¹³è·é›¢ã¨ã€å¹³é¢å›³ã®ãƒ”ãƒƒãƒåˆè¨ˆãŒä¸€è‡´ã™ã‚‹ã‹ç…§åˆã›ã‚ˆã€‚

#### Step 3: å³é¸ã•ã‚ŒãŸæ•°å€¤ã®æŠ½å‡ºï¼ˆãƒ”ãƒƒãƒåˆç®—ï¼‰
1. ã‚¹ãƒ†ãƒƒãƒ—2ã§ã€Œå±‹æ ¹ãŒã‚ã‚‹ã€ã¨ç¢ºå®šã—ãŸå£èŠ¯ãƒ©ã‚¤ãƒ³ã®å€‹åˆ¥ãƒ”ãƒƒãƒå¯¸æ³•ã®ã¿ã‚’åˆ—æŒ™ã›ã‚ˆã€‚
2. ã€ç¦æ­¢äº‹é …ã€‘å»ºç‰©å…¨ä½“ã®åˆè¨ˆå¯¸æ³•ç·šã«ãƒ™ãƒ©ãƒ³ãƒ€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½¿ç”¨ã›ãšã€å¿…ãšå†…å´ã®ãƒ”ãƒƒãƒå¯¸æ³•ã‚’åˆç®—ã™ã‚‹ã“ã¨ã€‚

#### Step 4: æœ€çµ‚è¨ˆç®—ï¼ˆå¤–å¯¸ç®—å‡ºï¼‰
1. [èŠ¯èŠ¯å¯¸æ³•]: æŠ½å‡ºã—ãŸãƒ”ãƒƒãƒå¯¸æ³•ã®åˆè¨ˆå¼ã‚’è¡¨ç¤ºã›ã‚ˆã€‚
2. [å…¥åŠ›å¤–å¯¸]: èŠ¯èŠ¯å¯¸æ³•ã«ã€ç«‹é¢å›³è¨˜è¼‰ã®ã€Œè»’ã®å‡ºã€ã‚’ä¸¡ç«¯ï¼ˆx2ï¼‰åŠ ç®—ã›ã‚ˆã€‚

å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§ã®ã¿å›ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "step_logs": "Step0-3ã¾ã§ã®å…·ä½“çš„ãªåˆ¤æ–­ç†ç”±",
  "width_mm": æ•°å€¤,
  "height_mm": æ•°å€¤,
  "pitch_formula_x": "æ±è¥¿ã®è¨ˆç®—å¼",
  "pitch_formula_y": "å—åŒ—ã®è¨ˆç®—å¼",
  "eaves_mm": "è»’ã®å‡ºæ•°å€¤",
  "reason": "ãƒ™ãƒ©ãƒ³ãƒ€é™¤å¤–ã®æ ¹æ‹ "
}`;

            const imageParts = await Promise.all(selectedFiles.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: file.type } });
                    reader.readAsDataURL(file);
                });
            }));

            const result = await model.generateContent([prompt, ...imageParts]);
            const data = JSON.parse(result.response.text());

            // UIåæ˜ 
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('valX').innerText = `${data.width_mm}mm`;
            document.getElementById('valY').innerText = `${data.height_mm}mm`;
            document.getElementById('formulaText').innerHTML = `
                <strong>æ±è¥¿å¼:</strong> ${data.pitch_formula_x}<br>
                <strong>å—åŒ—å¼:</strong> ${data.pitch_formula_y}<br>
                <strong>è»’ã®å‡º:</strong> ${data.eaves_mm}mm
            `;

            log(`[æ€è€ƒãƒ­ã‚°]\n${data.step_logs}`);
            log(`[åˆ¤å®šæ ¹æ‹ ]\n${data.reason}`);

            drawRoof(data.width_mm, data.height_mm);

        } catch (e) {
            log(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        } finally {
            btn.disabled = false;
            btn.innerText = "å³æ ¼è§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ";
        }
    };

    function drawRoof(w, h) {
        const canvas = document.getElementById('roofCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; canvas.height = 400;
        ctx.clearRect(0,0,600,400);
        
        const scale = Math.min(500/w, 300/h);
        const dw = w * scale; const dh = h * scale;
        const ox = (600-dw)/2; const oy = (400-dh)/2;

        ctx.strokeStyle = "#1a73e8"; ctx.lineWidth = 3;
        ctx.strokeRect(ox, oy, dw, dh);
        ctx.fillStyle = "#1a73e8"; ctx.font = "bold 16px sans-serif";
        ctx.fillText(`X: ${w}mm`, ox + dw/2 - 30, oy - 10);
        ctx.save();
        ctx.translate(ox - 10, oy + dh/2 + 30);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(`Y: ${h}mm`, 0, 0);
        ctx.restore();
    }
</script>
</body>
</html>
