<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro - Gemini 3 Flash</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f1f3f4; --text: #202124; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.12); margin-bottom: 15px; }
        h1 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; }
        .status-dot { width: 10px; height: 10px; background: #ccc; border-radius: 50%; margin-right: 8px; }
        .active { background: #34a853; }
        input, button { width: 100%; box-sizing: border-box; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #dadce0; }
        button { background: var(--primary); color: white; font-weight: bold; border: none; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        #logArea { background: #000; color: #00ff00; font-family: monospace; font-size: 0.75rem; padding: 10px; border-radius: 8px; height: 120px; overflow-y: auto; margin-top: 10px; }
        canvas { width: 100%; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        .result-val { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-align: center; margin: 10px 0; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1><span id="dot" class="status-dot"></span> 1. API設定</h1>
        <input type="password" id="apiKey" placeholder="Gemini API Keyを入力">
    </div>

    

    <div class="card">
        <h1>2. 図面アップロード</h1>
        <input type="file" id="fileInput" multiple accept="image/*">
        <button id="analyzeBtn">屋根解析を実行</button>
    </div>

    <div class="card" id="resultCard" style="display:none;">
        <h1>3. 解析結果</h1>
        <div id="resultText" class="result-val">---</div>
        <canvas id="roofCanvas"></canvas>
    </div>

    <div class="card">
        <h1>4. AI思考プロセス (Debug)</h1>
        <div id="logArea">待機中...</div>
    </div>
</div>

<script type="module">
    // Google AI SDK の読み込み
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const logArea = document.getElementById('logArea');
    const dot = document.getElementById('dot');
    
    // APIキーの保存
    const keyInput = document.getElementById('apiKey');
    keyInput.value = localStorage.getItem('gemini_key') || '';
    keyInput.onchange = () => {
        localStorage.setItem('gemini_key', keyInput.value);
        dot.classList.add('active');
    };
    if(keyInput.value) dot.classList.add('active');

    function log(msg) {
        logArea.innerHTML += `> ${msg}<br>`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    // 画像をAIが読める形式に変換
    async function fileToGenerativePart(file) {
        const base64EncodedDataPromise = new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(file);
        });
        return {
            inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
        };
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const files = document.getElementById('fileInput').files;
        if (!files.length) return alert("図面を選択してください");

        log("Gemini 3 Flash 起動中...");
        const genAI = new GoogleGenerativeAI(keyInput.value);
        const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

        // 指示書（プロンプト）の作成
        const prompt = `
        あなたは屋根寸法解析のエキスパートです。添付された平面図と立面図を照合し、以下の手順で屋根の芯芯寸法を算出してください。
        
        Step 0: 平面図の太線（壁芯）と細線（ベランダ等）を分離して認識せよ。
        Step 1: 「開口部」「サッシ」等のテキストに基づき、屋根が載る本体ラインを特定せよ。
        Step 2: 立面図を確認し、ベランダの上に屋根がない場合はその寸法を徹底的に除外せよ。
        Step 3: 特定したラインのピッチ寸法を合算せよ。
        
        【出力形式】
        必ず以下のJSON形式のみで回答してください。余計な挨拶は不要です。
        {
          "width_mm": 数値,
          "height_mm": 数値,
          "reason": "除外した理由の短い説明",
          "formula": "計算式（例: 2025+910+4050）"
        }`;

        try {
            const imageParts = await Promise.all([...files].map(fileToGenerativePart));
            const result = await model.generateContent([prompt, ...imageParts]);
            const response = await result.response;
            const text = response.text();
            
            log("AI応答を受信。解析中...");
            const data = JSON.parse(text.replace(/```json|```/g, ''));
            
            displayResult(data);
        } catch (e) {
            log("Error: " + e.message);
        }
    };

    function displayResult(data) {
        document.getElementById('resultCard').style.display = 'block';
        document.getElementById('resultText').innerText = `X: ${data.width_mm}mm / Y: ${data.height_mm}mm`;
        log(`理由: ${data.reason}`);
        log(`計算式: ${data.formula}`);

        const canvas = document.getElementById('roofCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400; canvas.height = 400;
        ctx.clearRect(0, 0, 400, 400);
        
        // 簡易描画（アスペクト比を維持して中央に）
        const ratio = data.width_mm / data.height_mm;
        const h = 300; const w = 300 * ratio;
        ctx.strokeStyle = '#1a73e8'; ctx.lineWidth = 4;
        ctx.strokeRect((400-w)/2, (400-h)/2, w, h);
        ctx.fillStyle = "#1a73e8"; ctx.font = "16px Arial";
        ctx.fillText(`${data.width_mm}mm`, 170, (400-h)/2 - 10);
        ctx.fillText(`${data.height_mm}mm`, (400+w)/2 + 5, 200);
    }
</script>
</body>
</html>
