<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI - å„è¾ºå¯¸æ³•ç‰¹å®šãƒ¢ãƒ‡ãƒ«</title>
    <style>
        :root { --primary: #0284c7; --bg: #f1f5f9; }
        body { font-family: sans-serif; background: var(--bg); padding: 10px; color: #334155; }
        .container { background: white; padding: 20px; border-radius: 16px; max-width: 600px; margin: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .api-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px; font-size: 0.8rem; box-sizing: border-box; }
        .upload-area { border: 2px dashed #0284c7; padding: 15px; text-align: center; border-radius: 10px; background: #fff; cursor: pointer; margin-bottom: 10px; }
        #thumb-list { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 10px; }
        .thumb-wrapper { position: relative; flex: 0 0 60px; height: 60px; border: 1px solid #ccc; border-radius: 4px; }
        .thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; border: none; font-size: 12px; }
        .btn { width: 100%; padding: 15px; background: #0284c7; color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        #result-area { margin-top: 20px; display: none; }
        
        .svg-viewer { 
            background: #1e293b; 
            border-radius: 12px; 
            padding: 10px; 
            text-align: center; 
            margin-bottom: 15px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
        .svg-viewer svg { 
            max-width: 100%; 
            height: auto; 
            max-height: 500px;
        }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #e2e8f0; padding: 8px; text-align: left; font-size: 0.8rem; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem; font-weight: bold; }
        .debug-info { font-size: 0.75rem; color: #64748b; border: 1px solid #eee; padding: 10px; border-radius: 8px; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <input type="password" id="apiKey" class="api-input" placeholder="Gemini API Key">

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“· å›³é¢ã‚’è¿½åŠ ï¼ˆç«‹é¢å›³ãƒ»å¹³é¢å›³ï¼‰</strong>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="addFiles(this)">
    </div>

    <div id="thumb-list"></div>

    <button id="runBtn" class="btn" onclick="startAnalysis()">è§£æå®Ÿè¡Œï¼ˆå„è¾ºå€‹åˆ¥ç‰¹å®šï¼‰</button>
    
    <div id="status" style="display:none; text-align:center; padding:10px;"></div>

    <div id="result-area">
        <div class="svg-viewer" id="svg-output"></div>
        
        <table>
            <thead><tr><th>ç‰¹å®šã•ã‚ŒãŸè¾ºãƒ»é …ç›®</th><th>é•·ã• / æ•°å€¤</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>

        <div class="debug-info">
            <details>
                <summary>ğŸ” å¯¸æ³•å°å‡ºã®ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆå„è¾ºã®è¨ˆç®—æ ¹æ‹ ï¼‰</summary>
                <div id="logic-output" style="white-space: pre-wrap; margin-top:10px;"></div>
            </details>
        </div>
    </div>
</div>

<script>
    let fileStack = [];

    function addFiles(input) {
        Array.from(input.files).forEach(file => {
            fileStack.push(file);
            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div');
                div.className = 'thumb-wrapper';
                div.innerHTML = `<img src="${e.target.result}" class="thumb"><button class="del-btn" onclick="removeFile(this)">Ã—</button>`;
                document.getElementById('thumb-list').appendChild(div);
            };
            reader.readAsDataURL(file);
        });
        updateUI();
        input.value = "";
    }

    function removeFile(btn) {
        const wrapper = btn.parentElement;
        const index = Array.from(document.getElementById('thumb-list').children).indexOf(wrapper);
        fileStack.splice(index, 1);
        wrapper.remove();
        updateUI();
    }

    function updateUI() {
        document.getElementById('runBtn').innerText = `è§£æå®Ÿè¡Œï¼ˆ${fileStack.length}æšï¼‰`;
    }

    async function startAnalysis() {
        const key = document.getElementById('apiKey').value;
        if(!key || fileStack.length === 0) return alert("ç”»åƒã¨ã‚­ãƒ¼ãŒå¿…è¦ã§ã™");

        const status = document.getElementById('status');
        status.style.display = "block";
        status.innerText = "â³ å›³é¢ã‹ã‚‰å„è¾ºã‚’æŠ½å‡ºä¸­...";

        try {
            const b64Images = await Promise.all(fileStack.map(file => toBase64(file)));

            const prompt = `ã‚ãªãŸã¯è¶…ç²¾å¯†ãªå»ºç¯‰ç©ç®—å£«ã§ã™ã€‚
å±‹æ ¹ã®åˆè¨ˆã‚µã‚¤ã‚ºã§ã¯ãªãã€å±‹æ ¹å¹³é¢ã‚’æ§‹æˆã™ã‚‹ã€å…¨ã¦ã®è¾ºã®é•·ã•ã€‘ã‚’å€‹åˆ¥ã«ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

### 1. è§£æã®å„ªå…ˆé †ä½
- **è¾ºã®å€‹åˆ¥æŠ½å‡º**: å±‹æ ¹ä¼å›³ã«ãŠã‘ã‚‹ã€Œå…¨ã¦ã®æŠ˜ã‚Œæ›²ãŒã‚Šã€ã‚’èªè­˜ã—ã€1æœ¬1æœ¬ã®è¾ºï¼ˆè»’å…ˆã€ã‚±ãƒ©ãƒç­‰ï¼‰ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã›ã‚ˆã€‚
- **å‡ºï¼ˆã§ï¼‰ã®å€‹åˆ¥ç‰¹å®š**: å„æ–¹ä½ï¼ˆæ±è¥¿å—åŒ—ï¼‰ã®è»’ã®å‡ºãƒ»ã‚±ãƒ©ãƒã®å‡ºã‚’ã€ç«‹é¢å›³ã®ã€Œå£å¤–é¢ã‹ã‚‰å±‹æ ¹ç«¯ã¾ã§ã€ã®ç›®ç››ã‚Šã‹ã‚‰ç›´æ¥èª­ã¿å–ã‚Œã€‚
- **å»ºç‰©å¤–å¯¸ã®ç‰¹å®š**: å¹³é¢å›³ã®æœ€å¤§å¤–éƒ­ãƒ©ã‚¤ãƒ³ã‚’ç‰¹å®šã›ã‚ˆã€‚

### 2. å„è¾ºã®ç®—å‡ºãƒ«ãƒ¼ãƒ«
- **è»’å…ˆè¾ºã®é•·ã•** = è©²å½“ã™ã‚‹å»ºç‰©é¢ã®å¹… ï¼‹ (éš£æ¥ã™ã‚‹ã‚±ãƒ©ãƒã®å‡º Ã— 2 â€»åˆ‡å¦»ã®å ´åˆãªã©)
- **ã‚±ãƒ©ãƒè¾ºã®é•·ã•ï¼ˆå¹³é¢æŠ•å½±ï¼‰** = è©²å½“ã™ã‚‹å»ºç‰©é¢ã®å¥¥è¡Œ ï¼‹ (éš£æ¥ã™ã‚‹è»’ã®å‡º Ã— 2)
- **æ³¨æ„**: ãƒãƒ«ã‚³ãƒ‹ãƒ¼ã‚„ãƒãƒ¼ãƒä¸Šç©ºã«å±‹æ ¹ãŒæ¶ã‹ã£ã¦ã„ã‚‹å ´åˆã€ãã®ã€Œå‡ºã€ãŒã©ã®å£é¢ã‚’èµ·ç‚¹ã¨ã—ã¦ã„ã‚‹ã‹ç«‹é¢å›³ã§å³å¯†ã«ç¢ºèªã›ã‚ˆã€‚

### 3. å‡ºåŠ›æŒ‡ç¤º
- **å±‹æ ¹ä¼å›³ï¼ˆSVGï¼‰**: èƒŒæ™¯é€æ˜ãƒ»ç·šã¯ç™½ã€‚å»ºç‰©å¤–éƒ­ã‚’ç ´ç·šã€å±‹æ ¹å¤–éƒ­ã‚’å®Ÿç·šã§æãã€å…¨ã¦ã®è¾ºã®æ¨ªã«ã€ŒL=ã€‡ã€‡ã€ã¨å¯¸æ³•ãƒ†ã‚­ã‚¹ãƒˆã‚’é…ç½®ã›ã‚ˆã€‚
- **ç©ç®—ãƒ†ãƒ¼ãƒ–ãƒ«**: ã€Œå—å´è»’å…ˆè¾ºã€ã€Œæ±å´ã‚±ãƒ©ãƒè¾ºã€ãªã©ã€å ´æ‰€ãŒç‰¹å®šã§ãã‚‹åç§°ã§é•·ã•ã‚’å‡ºåŠ›ã›ã‚ˆã€‚
- **è§£æãƒ­ã‚°**: å„è¾ºã®é•·ã•ã‚’å°ãå‡ºã—ãŸéš›ã®ç®—å¼ï¼ˆå»ºç‰©å¯¸ï¼‹å‡ºï¼‰ã‚’ã™ã¹ã¦è¨˜è¿°ã›ã‚ˆã€‚

æœ€å¾Œã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§ç· ã‚ã¦ãã ã•ã„ã€‚
%%%JSON_START%%% {"items": [{"name": "è¾ºã®åç§°", "value": "ã€‡ã€‡mm"}]} %%%JSON_END%%%`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }, ...b64Images.map(data => ({ inline_data: { mime_type: "image/jpeg", data } }))] }]
                })
            });

            const data = await response.json();
            const text = data.candidates[0].content.parts[0].text;
            
            document.getElementById('result-area').style.display = 'block';
            document.getElementById('logic-output').innerText = text.split('%%%')[0];
            const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/);
            if(svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];
            const jsonMatch = text.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);
            if(jsonMatch) {
                const json = JSON.parse(jsonMatch[1]);
                document.getElementById('table-body').innerHTML = json.items.map(it => `<tr><td>${it.name}</td><td>${it.value}</td></tr>`).join('');
            }
            status.style.display = "none";
        } catch (e) {
            status.innerText = "âŒ è§£æã‚¨ãƒ©ãƒ¼";
        }
    }

    function toBase64(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = Math.min(1, 1600 / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
            };
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>
