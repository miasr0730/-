<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roof Scan Pro v1.2</title>
    <style>
        /* ã‚¹ã‚¿ã‚¤ãƒ«ã¯å‰å›ã‚’ç¶™æ‰¿ã—ã€ä¸€éƒ¨è¿½åŠ  */
        :root { --primary: #1a73e8; --error: #d93025; --bg: #f8f9fa; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; color: #3c4043; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); margin-bottom: 15px; }
        #previewContainer { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
        .thumb-wrapper { position: relative; min-width: 80px; }
        .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #dadce0; }
        .analyze-btn { width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .analyze-btn:disabled { background: #ccc; }
        #logArea { background: #202124; color: #34a853; font-size: 0.8rem; padding: 15px; border-radius: 8px; height: 150px; overflow-y: auto; white-space: pre-wrap; margin-top: 10px; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; }
        .alert { background: #fce8e6; color: var(--error); padding: 15px; border-radius: 8px; border: 1px solid #f9d2ce; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

<div id="errorAlert" class="alert"></div>

<div class="card">
    <h1>ğŸ”‘ APIè¨­å®š</h1>
    <input type="password" id="apiKey" placeholder="Gemini API Key">
</div>

<div class="card">
    <h1>ğŸ“¸ å›³é¢è§£æ (ç”»åƒãƒ»PDFå¯¾å¿œ)</h1>
    <div id="previewContainer"></div>
    <label style="display:block; border:2px dashed var(--primary); padding:20px; text-align:center; cursor:pointer;">
        ğŸ“„ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (ç”»åƒ/PDF)
        <input type="file" id="fileInput" accept="image/*,application/pdf" style="display:none">
    </label>
    <button id="analyzeBtn" class="analyze-btn">å³æ ¼è§£æå®Ÿè¡Œ</button>
</div>

<div class="card" id="resultCard" style="display:none;">
    <h1>ğŸ“Š å„è¾ºã®ç®—å‡ºå¯¸æ³•</h1>
    <div id="formulaText" style="font-size:0.9rem; line-height:1.6;"></div>
    <canvas id="roofCanvas"></canvas>
</div>

<div class="card">
    <h1>ğŸ§  è§£æãƒ­ã‚°</h1>
    <div id="logArea">å¾…æ©Ÿä¸­...</div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    let selectedFiles = [];
    const logArea = document.getElementById('logArea');

    // --- ãƒ—ãƒªãƒ—ãƒ­ã‚»ã‚¹é–¢æ•° (Canvasã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆèª¿æ•´) ---
    async function preprocessImage(file) {
        if (file.type === 'application/pdf') return file; // PDFã¯ãã®ã¾ã¾

        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                
                // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆå¼·åŒ–
                ctx.filter = 'grayscale(1) contrast(1.2)';
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob((blob) => {
                    resolve(new File([blob], file.name, { type: 'image/jpeg' }));
                }, 'image/jpeg', 0.8);
            };
            img.src = URL.createObjectURL(file);
        });
    }

    document.getElementById('fileInput').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        logArea.innerText = "ç”»åƒã‚’æœ€é©åŒ–ä¸­...";
        const processedFile = await preprocessImage(file);
        selectedFiles.push(processedFile);
        renderPreviews();
    };

    function renderPreviews() {
        const container = document.getElementById('previewContainer');
        container.innerHTML = "";
        selectedFiles.forEach((file, i) => {
            const div = document.createElement('div');
            div.className = 'thumb-wrapper';
            const label = file.type === 'application/pdf' ? 'ğŸ“„ PDF' : 'ğŸ–¼ IMG';
            div.innerHTML = `<div class="thumb" style="display:flex;align-items:center;justify-content:center;background:#eee;font-size:10px">${label}</div>`;
            container.appendChild(div);
        });
    }

    document.getElementById('analyzeBtn').onclick = async () => {
        const apiKey = document.getElementById('apiKey').value;
        if (!apiKey || selectedFiles.length === 0) return alert("è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");

        const btn = document.getElementById('analyzeBtn');
        const alertBox = document.getElementById('errorAlert');
        btn.disabled = true;
        alertBox.style.display = 'none';
        logArea.innerText = "--- è§£æä¸­ ---";

        try {
            const genAI = new GoogleGenerativeAI(apiKey);
            const model = genAI.getGenerativeModel({ model: "gemini-3-flash-preview" });

            const prompt = `
ã‚ãªãŸã¯å»ºç¯‰å›³é¢è§£æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚
1. å›³é¢å†…ã®ã‚¹ã‚±ãƒ¼ãƒ«è¡¨è¨˜ï¼ˆS=1/100, 1/50ç­‰ï¼‰ã‚’å¿…ãšæ¢ã—ã€èª­ã¿å–ã£ãŸmmå˜ä½ã®æ•°å€¤ã¨çŸ›ç›¾ãŒãªã„ã‹ç…§åˆã—ã¦ãã ã•ã„ã€‚
2. ã‚‚ã—ç”»åƒãŒä¸é®®æ˜ã§æ•°å€¤ãŒç¢ºå®Ÿã§ãªã„å ´åˆã¯ã€è§£æã‚’ä¸­æ­¢ã—ã€error_codeã«"BLURRY"ã¨å…¥ã‚Œã¦ãã ã•ã„ã€‚
3. å¯„æ£Ÿå±‹æ ¹ã®å ´åˆã€å¤–å¯¸ï¼ˆè»’ã‚’å«ã‚€ï¼‰ã ã‘ã§ãªãã€å¤§æ£Ÿï¼ˆæ°´å¹³éƒ¨ï¼‰ã¨éš…æ£Ÿï¼ˆæ–œã‚éƒ¨ï¼‰ã®ã€Œå¹³é¢å›³ä¸Šã®æ°´å¹³é•·ã•ã€ã‚’ç®—å‡ºã—ã¦ä¸‹ã•ã„ã€‚

è¿”å´å½¢å¼ (JSONã®ã¿):
{
  "error_code": null,
  "scale_detected": "1/100",
  "width_mm": æ•°å€¤,
  "height_mm": æ•°å€¤,
  "ridge_mm": å¤§æ£Ÿã®é•·ã•,
  "hip_horizontal_mm": éš…æ£Ÿã®æ°´å¹³æŠ•å½±é•·ã•,
  "eaves_mm": è»’ã®å‡º,
  "reason": "åˆ¤æ–­æ ¹æ‹ ã¨ã‚¹ã‚±ãƒ¼ãƒ«ç…§åˆçµæœ"
}`;

            const parts = await Promise.all(selectedFiles.map(async file => {
                const base64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onloadend = () => r(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });
                return { inlineData: { data: base64, mimeType: file.type } };
            }));

            const result = await model.generateContent([prompt, ...parts]);
            const data = JSON.parse(result.response.text().replace(/```json|```/g, ""));

            if (data.error_code === "BLURRY") {
                alertBox.innerText = "âš ï¸ å›³é¢ãŒä¸é®®æ˜ã§ã™ã€‚ã‚ˆã‚Šæ˜ã‚‹ã„å ´æ‰€ã§ã€æ•°å­—ãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹ã‚ˆã†ã«æ’®ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚";
                alertBox.style.display = 'block';
                return;
            }

            // çµæœè¡¨ç¤º
            document.getElementById('resultCard').style.display = 'block';
            document.getElementById('formulaText').innerHTML = `
                <b>ã‚¹ã‚±ãƒ¼ãƒ«:</b> ${data.scale_detected}<br>
                <b>å¤–å¯¸ (æ±è¥¿Ã—å—åŒ—):</b> ${data.width_mm}mm Ã— ${data.height_mm}mm<br>
                <b>å¤§æ£Ÿã®é•·ã•:</b> ${data.ridge_mm}mm<br>
                <b>éš…æ£Ÿã®æ°´å¹³é•·ã•:</b> ${data.hip_horizontal_mm}mm<br>
                <b>æ ¹æ‹ :</b> ${data.reason}
            `;

            drawRoof(data.width_mm, data.height_mm, data.ridge_mm);

        } catch (e) {
            logArea.innerText += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`;
        } finally {
            btn.disabled = false;
        }
    };

    function drawRoof(w, h, ridge) {
        const canvas = document.getElementById('roofCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 600; canvas.height = 400;
        const scale = Math.min(500/w, 300/h);
        const dw = w * scale; const dh = h * scale;
        const dridge = ridge * scale;
        const ox = (600-dw)/2; const oy = (400-dh)/2;

        ctx.clearRect(0,0,600,400);
        ctx.strokeStyle = "#1a73e8"; ctx.lineWidth = 3;
        ctx.strokeRect(ox, oy, dw, dh); // å¤–å¯¸

        // æ§‹é€ ç·š
        ctx.beginPath();
        ctx.strokeStyle = "#d93025";
        const offset = (dw - dridge) / 2;
        ctx.moveTo(ox, oy); ctx.lineTo(ox + offset, oy + dh/2);
        ctx.moveTo(ox, oy + dh); ctx.lineTo(ox + offset, oy + dh/2);
        ctx.moveTo(ox + dw, oy); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.moveTo(ox + dw, oy + dh); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.moveTo(ox + offset, oy + dh/2); ctx.lineTo(ox + dw - offset, oy + dh/2);
        ctx.stroke();
    }
</script>
</body>
</html>
