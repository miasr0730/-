<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Roof Scan Pro v4.7 - Gemini 3 Preview</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #1a73e8; border-left: 5px solid #1a73e8; padding-left: 15px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .input-style { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        .flex-row { display: flex; gap: 15px; }
        .btn-primary { background: #1a73e8; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; transition: 0.3s; }
        .btn-primary:hover { background: #1557b0; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        #previewContainer { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding: 15px; border: 2px dashed #1a73e8; border-radius: 8px; background: #f8fbff; min-height: 100px; }
        .thumb-wrapper { position: relative; width: 120px; height: 120px; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: #d93025; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 22px; cursor: pointer; font-weight: bold; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        .log-box { background: #202124; color: #34a853; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 13px; white-space: pre-wrap; margin-top: 10px; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ  Roof Scan Pro v4.7 (Gemini 3 Flash)</h2>
        <div class="input-group">
            <label>ğŸ”‘ Gemini API Key:</label>
            <input type="password" id="apiKey" placeholder="AIã‚­ãƒ¼ã‚’å…¥åŠ›" class="input-style">
        </div>
        <div class="flex-row">
            <div style="flex: 2;">
                <label>å±‹æ ¹å½¢çŠ¶ã®åŸºæœ¬æ–¹é‡:</label>
                <select id="roofType" class="input-style">
                    <option value="å¯„æ£Ÿ">å¯„æ£Ÿ (Hip)</option>
                    <option value="è¤‡åˆå±‹æ ¹">è¤‡åˆå±‹æ ¹ (è¤‡é›‘ãªå½¢çŠ¶)</option>
                    <option value="åˆ‡å¦»">åˆ‡å¦» (Gable)</option>
                    <option value="ç‰‡æµã‚Œ">ç‰‡æµã‚Œ (Shed)</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>æƒ³å®šé¢æ•°:</label>
                <input type="number" id="planeCount" value="4" class="input-style">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (PDFéå¯¾å¿œãƒ»ç”»åƒå°‚ç”¨)</h3>
        <input type="file" id="fileInput" accept="image/*" multiple class="input-style">
        <div id="previewContainer"></div>
    </div>

    <button id="analyzeBtn" class="btn-primary">Gemini 3 ç²¾å¯†è§£æã‚’å®Ÿè¡Œ</button>

    <div id="resultArea" style="display:none; margin-top: 20px;">
        <div class="card">
            <h3 style="border-color: #1a73e8;">ğŸ”µ æ°´å¹³æŠ•å½±å›³ (Plan View)</h3>
            <canvas id="planCanvas"></canvas>
        </div>
        <div class="card">
            <h3 style="border-color: #d93025;">ğŸ”´ å‹¾é…å®Ÿå¯¸å›³ (Actual View)</h3>
            <canvas id="slopeCanvas"></canvas>
        </div>
        <div class="card">
            <h3>ğŸ“ è§£æãƒ—ãƒ­ã‚»ã‚¹ãƒ»è¨ˆç®—ãƒ­ã‚°</h3>
            <div id="logArea" class="log-box"></div>
        </div>
    </div>
</div>

<script>
let imageList = [];

document.getElementById('fileInput').onchange = (e) => {
    const files = Array.from(e.target.files);
    const container = document.getElementById('previewContainer');
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (f) => {
            const dataUrl = f.target.result;
            imageList.push(dataUrl);
            const wrapper = document.createElement('div');
            wrapper.className = 'thumb-wrapper';
            wrapper.innerHTML = `<img src="${dataUrl}"><div class="remove-btn">Ã—</div>`;
            wrapper.querySelector('.remove-btn').onclick = () => {
                imageList = imageList.filter(img => img !== dataUrl);
                wrapper.remove();
            };
            container.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
    });
};

function drawRoof(data, canvasId, isActual) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    canvas.width = 1200; canvas.height = 800;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!data.planes || data.planes.length === 0) return;

    let allX = [], allY = [];
    data.planes.forEach(p => p.vertices.forEach(v => { allX.push(v.x); allY.push(v.y); }));
    const minX = Math.min(...allX), maxX = Math.max(...allX);
    const minY = Math.min(...allY), maxY = Math.max(...allY);
    const margin = 100;
    const scale = Math.min((canvas.width - margin*2) / (maxX - minX || 1), (canvas.height - margin*2) / (maxY - minY || 1));
    const offX = (canvas.width - (maxX - minX) * scale) / 2 - minX * scale;
    const offY = (canvas.height - (maxY - minY) * scale) / 2 - minY * scale;

    data.planes.forEach(plane => {
        const pts = plane.vertices.map(v => ({ x: v.x * scale + offX, y: v.y * scale + offY }));
        ctx.beginPath();
        ctx.lineWidth = 4;
        ctx.strokeStyle = isActual ? "#d93025" : "#1a73e8";
        ctx.fillStyle = isActual ? "rgba(217,48,37,0.05)" : "rgba(26,115,232,0.05)";
        pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
        ctx.closePath(); ctx.fill(); ctx.stroke();

        ctx.font = "bold 16px Arial";
        plane.edges.forEach(edge => {
            const p1 = pts[edge.from], p2 = pts[edge.to];
            if(!p1 || !p2) return;
            const mx = (p1.x + p2.x) / 2; const my = (p1.y + p2.y) / 2;
            const val = Math.round(isActual ? edge.len_actual : edge.len_plan);
            const txt = val.toString();
            const tw = ctx.measureText(txt).width + 8;
            ctx.fillStyle = "white"; ctx.fillRect(mx - tw/2, my - 12, tw, 22);
            ctx.fillStyle = isActual ? "#d93025" : "#1a73e8"; ctx.textAlign = "center";
            ctx.fillText(txt, mx, my + 5);
        });

        if (plane.center_label) {
            const cx = pts.reduce((sum, p) => sum + p.x, 0) / pts.length;
            const cy = pts.reduce((sum, p) => sum + p.y, 0) / pts.length;
            ctx.font = "bold 20px Arial";
            const labelTxt = `æµã‚Œ: ${plane.center_label}`;
            const lw = ctx.measureText(labelTxt).width + 10;
            ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillRect(cx - lw/2, cy - 15, lw, 30);
            ctx.fillStyle = "#333"; ctx.fillText(labelTxt, cx, cy + 8);
        }
    });
}

document.getElementById('analyzeBtn').onclick = async () => {
    const key = document.getElementById('apiKey').value;
    const type = document.getElementById('roofType').value;
    const count = document.getElementById('planeCount').value;
    if (!key || imageList.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ç”»åƒãŒå¿…è¦ã§ã™ã€‚");

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true; btn.innerText = "Gemini 3 ç²¾å¯†è§£æä¸­...";

    // ä»¥å‰ã®æŒ‡ç¤ºï¼ˆStep 0-4ï¼‰ã‚’å¿ å®Ÿã«ç››ã‚Šè¾¼ã‚“ã ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    const prompt = `
# å±‹æ ¹ç©ç®—ç²¾å¯†è§£æã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  (v1.1 å³æ ¼ãƒ¢ãƒ¼ãƒ‰)
ã‚ãªãŸã¯å»ºç¯‰å›³é¢è§£æã®ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã€Œä¸€æ–‡å­—ã‚‚é€ƒã•ãšã€å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚

#### Step 0: æ§‹é€ è§£æï¼ˆè¦–è¦šçš„ä»®èª¬ï¼‰
- å¹³é¢å›³ã«ãŠã„ã¦ã€æœ€ã‚‚å¤ªã„å®Ÿç·šã§å›²ã¾ã‚ŒãŸé–‰é–é ˜åŸŸã‚’ã€Œå±‹å†…æœ¬ä½“ã€ã¨ã›ã‚ˆã€‚
- ãã®å¤–å´ã«ã‚ã‚‹ç´°ç·šï¼ˆãƒ™ãƒ©ãƒ³ãƒ€ç­‰ï¼‰ã‚’åˆ†é›¢ã—ã€ç«‹é¢å›³ã¨ç…§åˆã—ã¦å±‹æ ¹ãŒè¢«ã£ã¦ã„ã‚‹ã‹åˆ¤å®šã›ã‚ˆã€‚
- ã€é‡è¦ã€‘Xè»¸ãƒ»Yè»¸ã®ã€Œæœ€ã‚‚é•·ã„å…¨ä½“å¯¸æ³•ç·šã€ã¨ã€Œå€‹åˆ¥ãƒ”ãƒƒãƒå¯¸æ³•ã€ã®åˆè¨ˆãŒä¸€è‡´ã™ã‚‹ã‹ç…§åˆã›ã‚ˆã€‚

#### Step 1: ãƒ†ã‚­ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚»ãƒ«ãƒ•ãƒã‚§ãƒƒã‚¯
- å¤ªç·šãƒ©ã‚¤ãƒ³ä¸Šã«ã€ŒLDK/æ´‹å®¤/ã‚µãƒƒã‚·ã€ç­‰ã®å±…å®¤è¡¨è¨˜ãŒã‚ã‚‹ã‹ç¢ºèªã—ã€ãã“ã‚’ã€Œå±‹æ ¹ãŒå¿…è¦ãªå£ã€ã¨ç¢ºå®šã›ã‚ˆã€‚

#### Step 2: å³é¸ã•ã‚ŒãŸæ•°å€¤ã®æŠ½å‡ºï¼ˆãƒ”ãƒƒãƒåˆç®—ï¼‰
- X=12025mm ã®ã‚ˆã†ãªå…¨ä½“å¯¸æ³•ã‚’è¦‹é€ƒã™ãªã€‚
- å»ºç‰©å…¨ä½“ã®åˆè¨ˆå¯¸æ³•ç·šã«ãƒ™ãƒ©ãƒ³ãƒ€ãŒå«ã¾ã‚Œã‚‹å ´åˆã¯ä½¿ç”¨ã›ãšã€å¿…ãšå†…å´ã®ãƒ”ãƒƒãƒå¯¸æ³•ã‚’ç²¾æŸ»åˆç®—ã™ã‚‹ã“ã¨ã€‚

#### Step 3: å¹¾ä½•å­¦çš„åº§æ¨™ã®ç®—å‡º
- å±‹æ ¹å½¢çŠ¶: ${type}ã€é¢æ•°: ${count}
- è»’ã®å‡ºã‚’ 275mm ã¨ä»®å®šã—ã€å£èŠ¯ã‹ã‚‰å¤–å´ã«æ‹¡å¼µã—ãŸå±‹æ ¹å¤–å¯¸ã‚’ç®—å‡ºã›ã‚ˆã€‚
- å„é¢ã®é ‚ç‚¹ã‚’(x, y)åº§æ¨™ã§å‡ºåŠ›ã›ã‚ˆï¼ˆå˜ä½: mmï¼‰ã€‚

## å‡ºåŠ›å½¢å¼ (JSON)
{
  "planes": [
    {
      "name": "é¢A",
      "vertices": [{"x": 0, "y": 0}, ...],
      "edges": [{"from": 0, "to": 1, "len_plan": æ•°å€¤, "len_actual": æ•°å€¤}],
      "center_label": "å®Ÿå¯¸æµã‚Œæ•°å€¤"
    }
  ],
  "logs": "è§£æã®è©³ç´°ï¼šæ¤œå‡ºã—ãŸå…¨ã¦ã®æ•°å€¤ã€åŠ ç®—å¼(ä¾‹: 2025+900+4050...)ã€ãƒ™ãƒ©ãƒ³ãƒ€åˆ¤å®šã®æ ¹æ‹ "
}`;

    try {
        // gemini-3-flash-preview ã‚’ä½¿ç”¨
        const modelId = "gemini-3-flash-preview";
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelId}:generateContent?key=${key}`;

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        ...imageList.map(img => ({
                            inline_data: { mime_type: "image/jpeg", data: img.split(',')[1] }
                        }))
                    ]
                }],
                generationConfig: {
                    response_mime_type: "application/json"
                }
            })
        });

        const resJson = await response.json();
        if (resJson.error) throw new Error(resJson.error.message);

        const result = JSON.parse(resJson.candidates[0].content.parts[0].text);
        
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('logArea').innerText = `ã€ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«: ${modelId}ã€‘\n` + (result.logs || "è§£æå®Œäº†");
        
        drawRoof(result, 'planCanvas', false);
        drawRoof(result, 'slopeCanvas', true);

    } catch (e) {
        console.error(e);
        alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
    } finally {
        btn.disabled = false; btn.innerText = "Gemini 3 ç²¾å¯†è§£æã‚’å®Ÿè¡Œ";
    }
};
</script>
</body>
</html>
