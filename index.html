<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Roof Scan Pro v4.6 - Full Integration</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f4f8; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); margin-bottom: 20px; }
        h2, h3 { margin-top: 0; color: #1a73e8; border-left: 5px solid #1a73e8; padding-left: 15px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        .input-style { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        .flex-row { display: flex; gap: 15px; }
        .btn-primary { background: #1a73e8; color: white; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 18px; font-weight: bold; transition: 0.3s; }
        .btn-primary:hover { background: #1557b0; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        #previewContainer { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding: 15px; border: 2px dashed #1a73e8; border-radius: 8px; background: #f8fbff; min-height: 100px; }
        .thumb-wrapper { position: relative; width: 120px; height: 120px; }
        .thumb-wrapper img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid #ddd; }
        .remove-btn { position: absolute; top: -8px; right: -8px; background: #d93025; color: white; border-radius: 50%; width: 24px; height: 24px; text-align: center; line-height: 22px; cursor: pointer; font-weight: bold; }
        canvas { width: 100%; height: auto; background: #fff; border: 1px solid #ddd; border-radius: 8px; margin-top: 10px; }
        .log-box { background: #202124; color: #f1f3f4; padding: 15px; border-radius: 8px; font-family: 'Courier New', Courier, monospace; font-size: 13px; white-space: pre-wrap; margin-top: 10px; overflow-x: auto; }
        .dimension-label { font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>ğŸ  Roof Scan Pro v4.6</h2>
        <div class="input-group">
            <label>ğŸ”‘ Gemini API Key:</label>
            <input type="password" id="apiKey" placeholder="AIã‚­ãƒ¼ã‚’å…¥åŠ›" class="input-style">
        </div>
        <div class="flex-row">
            <div style="flex: 2;">
                <label>å±‹æ ¹å½¢çŠ¶ã®åŸºæœ¬æ–¹é‡:</label>
                <select id="roofType" class="input-style">
                    <option value="è¤‡åˆå±‹æ ¹">è¤‡åˆå±‹æ ¹ (è¤‡é›‘ãªå½¢çŠ¶)</option>
                    <option value="å¯„æ£Ÿ">å¯„æ£Ÿ (Hip)</option>
                    <option value="åˆ‡å¦»">åˆ‡å¦» (Gable)</option>
                    <option value="ç‰‡æµã‚Œ">ç‰‡æµã‚Œ (Shed)</option>
                    <option value="æ–¹å½¢">æ–¹å½¢ (Pyramid)</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>æƒ³å®šé¢æ•°:</label>
                <input type="number" id="planeCount" value="4" class="input-style">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>ğŸ“ å›³é¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°ä¿æŒï¼‰</h3>
        <p style="font-size: 12px; color: #666;">å¹³é¢å›³ã€ç«‹é¢å›³ã€çŸ©è¨ˆå›³ãªã©ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚ç”»åƒã¯ä¸Šæ›¸ãã•ã‚Œã¾ã›ã‚“ã€‚</p>
        <input type="file" id="fileInput" accept="image/*" multiple class="input-style">
        <div id="previewContainer"></div>
    </div>

    <button id="analyzeBtn" class="btn-primary">ç²¾å¯†è§£æã‚’å®Ÿè¡Œ</button>

    <div id="resultArea" style="display:none; margin-top: 20px;">
        <div class="card">
            <h3 style="border-color: #1a73e8;">ğŸ”µ æ°´å¹³æŠ•å½±å›³ (Plan View) - é’æ•°å€¤</h3>
            <canvas id="planCanvas"></canvas>
        </div>
        <div class="card">
            <h3 style="border-color: #d93025;">ğŸ”´ å‹¾é…å®Ÿå¯¸å›³ (Actual View) - èµ¤æ•°å€¤</h3>
            <canvas id="slopeCanvas"></canvas>
        </div>
        <div class="card">
            <h3>ğŸ“ è§£æãƒ—ãƒ­ã‚»ã‚¹ãƒ»ãƒ­ã‚°</h3>
            <div id="logArea" class="log-box"></div>
        </div>
    </div>
</div>

<script>
let imageList = []; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ã™ã‚‹é…åˆ—

// ç”»åƒã®èª­ã¿è¾¼ã¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆï¼ˆä¸Šæ›¸ãé˜²æ­¢ï¼‰
document.getElementById('fileInput').onchange = (e) => {
    const files = Array.from(e.target.files);
    const container = document.getElementById('previewContainer');

    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (f) => {
            const dataUrl = f.target.result;
            imageList.push(dataUrl);

            const wrapper = document.createElement('div');
            wrapper.className = 'thumb-wrapper';
            wrapper.innerHTML = `
                <img src="${dataUrl}">
                <div class="remove-btn">Ã—</div>
            `;
            wrapper.querySelector('.remove-btn').onclick = () => {
                imageList = imageList.filter(img => img !== dataUrl);
                wrapper.remove();
            };
            container.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
    });
};

// æç”»ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆå…¨è¾ºã®å¯¸æ³• ï¼‹ ä¸­å¤®ã®æµã‚Œå¯¸æ³•ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰
function drawRoof(data, canvasId, isActual) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    canvas.width = 1200;
    canvas.height = 800;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (!data.planes || data.planes.length === 0) return;

    // ã‚ªãƒ¼ãƒˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨ˆç®—
    let allX = [], allY = [];
    data.planes.forEach(p => p.vertices.forEach(v => { allX.push(v.x); allY.push(v.y); }));
    const minX = Math.min(...allX), maxX = Math.max(...allX);
    const minY = Math.min(...allY), maxY = Math.max(...allY);
    
    const margin = 100;
    const scale = Math.min((canvas.width - margin*2) / (maxX - minX || 1), (canvas.height - margin*2) / (maxY - minY || 1));
    const offX = (canvas.width - (maxX - minX) * scale) / 2 - minX * scale;
    const offY = (canvas.height - (maxY - minY) * scale) / 2 - minY * scale;

    data.planes.forEach(plane => {
        const pts = plane.vertices.map(v => ({ x: v.x * scale + offX, y: v.y * scale + offY }));

        // 1. å¤–å½¢æç”»
        ctx.beginPath();
        ctx.lineWidth = 4;
        ctx.strokeStyle = isActual ? "#d93025" : "#1a73e8";
        ctx.fillStyle = isActual ? "rgba(217,48,37,0.05)" : "rgba(26,115,232,0.05)";
        pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // 2. å„è¾ºã®å¯¸æ³•è¡¨ç¤º (Edges)
        ctx.font = "bold 16px Arial";
        plane.edges.forEach(edge => {
            const p1 = pts[edge.from], p2 = pts[edge.to];
            if(!p1 || !p2) return;
            const mx = (p1.x + p2.x) / 2;
            const my = (p1.y + p2.y) / 2;
            const val = Math.round(isActual ? edge.len_actual : edge.len_plan);

            // èƒŒæ™¯ãƒœãƒƒã‚¯ã‚¹
            const txt = val.toString();
            const tw = ctx.measureText(txt).width + 8;
            ctx.fillStyle = "white";
            ctx.fillRect(mx - tw/2, my - 12, tw, 22);
            // æ•°å€¤æç”»
            ctx.fillStyle = isActual ? "#d93025" : "#1a73e8";
            ctx.textAlign = "center";
            ctx.fillText(txt, mx, my + 5);
        });

        // 3. å‚ç›´æµã‚Œå¯¸æ³•ã®è¡¨ç¤º (NAGARE)
        if (plane.center_label) {
            const cx = pts.reduce((sum, p) => sum + p.x, 0) / pts.length;
            const cy = pts.reduce((sum, p) => sum + p.y, 0) / pts.length;
            ctx.font = "bold 20px Arial";
            ctx.fillStyle = "#000";
            const labelTxt = `æµã‚Œ: ${plane.center_label}`;
            // ãƒ©ãƒ™ãƒ«ç”¨èƒŒæ™¯
            const lw = ctx.measureText(labelTxt).width + 10;
            ctx.fillStyle = "rgba(255,255,255,0.8)";
            ctx.fillRect(cx - lw/2, cy - 15, lw, 30);
            ctx.fillStyle = "#333";
            ctx.fillText(labelTxt, cx, cy + 8);
        }
    });
}

document.getElementById('analyzeBtn').onclick = async () => {
    const key = document.getElementById('apiKey').value;
    const type = document.getElementById('roofType').value;
    const count = document.getElementById('planeCount').value;

    if (!key || imageList.length === 0) {
        alert("APIã‚­ãƒ¼ã¨å›³é¢ç”»åƒãŒå¿…è¦ã§ã™ã€‚");
        return;
    }

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    btn.innerText = "ç²¾å¯†è§£æä¸­... (æ•°åç§’ã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™)";

    const prompt = `
# å±‹æ ¹ç©ç®—ç²¾å¯†è§£ææŒ‡ä»¤ v4.6
å±‹æ ¹ä¼å›³ãŠã‚ˆã³ç«‹é¢å›³ã‚’è§£æã—ã€ä»¥ä¸‹ã®æ‰‹é †ã«å¾“ã£ã¦å¹¾ä½•å­¦çš„åº§æ¨™ã‚’å‡ºåŠ›ã›ã‚ˆã€‚

## Step 0: å£èŠ¯ã¨å±‹æ ¹ç¯„å›²ã®ç‰¹å®š
- å›³é¢å†…ã®æ³¨è¨˜ï¼ˆLDKã€æ´‹å®¤ã€å’Œå®¤ã€åç´ç­‰ï¼‰ã‚’ç¢ºèªã—ã€ãã“ã‚’ã€Œå±‹å†…ã€ã¨åˆ¤å®šã›ã‚ˆã€‚
- åˆ¤å®šã•ã‚ŒãŸã€Œå±‹å†…ã€ã‚’å›²ã‚€ä¸€ç•ªå†…å´ã®å¯¸æ³•ç·šã‚’ã€Œå£èŠ¯ã€ã¨ã—ã¦æ¡ç”¨ã›ã‚ˆã€‚
- ã‚µãƒƒã‚·ã‚„é–‹å£éƒ¨ã®ä½ç½®ã‹ã‚‰ã€ãƒ™ãƒ©ãƒ³ãƒ€ç­‰ã«å±‹æ ¹ãŒã‹ã‹ã£ã¦ã„ãªã„å ´åˆã¯ãã“ã‚’é™¤å¤–ã›ã‚ˆã€‚

## Step 1: å¹¾ä½•è¨ˆç®—
- å±‹æ ¹å½¢çŠ¶: ${type}ã€æŒ‡å®šé¢æ•°: ${count}
- å„é¢ã”ã¨ã«ã€é ‚ç‚¹ã®ç›¸å¯¾åº§æ¨™(x, y)ã‚’ç®—å‡ºã›ã‚ˆã€‚
- å„è¾ºã«ã¤ã„ã¦ã€æ°´å¹³æŠ•å½±é•·ã•(len_plan)ã¨å‹¾é…å®Ÿå¯¸é•·ã•(len_actual)ã‚’mmå˜ä½ã§ç®—å‡ºã›ã‚ˆã€‚
- é¢ã®å‚ç›´æµã‚Œæ–¹å‘ï¼ˆè»’ã‹ã‚‰æ£Ÿã¸ã®æœ€çŸ­è·é›¢ã®å®Ÿå¯¸ï¼‰ã‚’ç®—å‡ºã›ã‚ˆã€‚

## å‡ºåŠ›å½¢å¼ (JSONã®ã¿)
{
  "planes": [
    {
      "name": "é¢A",
      "vertices": [{"x": 0, "y": 0}, {"x": 3640, "y": 0}, ...],
      "edges": [{"from": 0, "to": 1, "len_plan": 3640, "len_actual": 3845}, ...],
      "center_label": "3845"
    }
  ],
  "logs": "è§£æã®è©³ç´°ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆã‚µãƒƒã‚·åˆ¤å®šçµæœã€æ¡ç”¨ã—ãŸå¯¸æ³•ã€å‹¾é…è¨ˆç®—å¼ãªã©ï¼‰"
}`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{
                    parts: [
                        { text: prompt },
                        ...imageList.map(img => ({
                            inline_data: { mime_type: "image/jpeg", data: img.split(',')[1] }
                        }))
                    ]
                }]
            })
        });

        const resJson = await response.json();
        const responseText = resJson.candidates[0].content.parts[0].text;
        
        // JSONã®æŠ½å‡º
        const jsonMatch = responseText.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
            const result = JSON.parse(jsonMatch[0]);
            document.getElementById('resultArea').style.display = 'block';
            document.getElementById('logArea').innerText = result.logs || "è§£æå®Œäº†";
            
            // æç”»å®Ÿè¡Œ
            drawRoof(result, 'planCanvas', false);
            drawRoof(result, 'slopeCanvas', true);
        } else {
            throw new Error("AIã‹ã‚‰æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ã‚°: " + responseText);
        }

    } catch (e) {
        console.error(e);
        alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
    } finally {
        btn.disabled = false;
        btn.innerText = "ç²¾å¯†è§£æã‚’å®Ÿè¡Œ";
    }
};
</script>

</body>
</html>
