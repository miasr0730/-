<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI 2.5 ç²¾å¯†è§£æç‰ˆ</title>
    <style>
        :root { --primary: #2563eb; --accent: #ef4444; --bg: #f8fafc; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 15px; margin: 0; color: #1e293b; }
        .container { background: white; padding: 20px; border-radius: 20px; max-width: 800px; margin: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .api-box { background: #eff6ff; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #bfdbfe; }
        .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; display: block; margin-bottom: 15px; background: #fff; }
        #thumb-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .thumb { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .btn { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }
        #status-area { margin-top: 15px; padding: 15px; border-radius: 10px; text-align: center; display: none; }
        #timer { font-family: monospace; font-size: 1.2rem; text-align: center; margin: 10px 0; color: var(--primary); }
        .reason-box { background: #f1f5f9; border-left: 4px solid var(--primary); padding: 15px; margin-top: 20px; display: none; font-size: 0.95rem; line-height: 1.6; }
        .result-section { display: none; margin-top: 25px; border-top: 2px solid #eee; padding-top: 20px; }
        .svg-box { background: #0f172a; border-radius: 12px; padding: 20px; text-align: center; overflow-x: auto; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        th { background: #f8fafc; color: #64748b; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; font-size:1.4rem;">å±‹æ ¹ç©ç®— AI Vision <span style="color:var(--primary);">2.5 Flash</span></h1>
    
    <div class="api-box">
        <label style="font-size:0.8rem; font-weight:bold;">Gemini 2.5 API Key</label>
        <input type="password" id="apiKey" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:8px; margin-top:5px;" placeholder="ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
    </div>

    <label class="upload-area">
        <strong>ğŸ“¸ ç«‹é¢å›³ãƒ»å¹³é¢å›³ã‚’å…¨ã¦æ’®å½±/è¿½åŠ </strong>
        <p style="font-size:0.8rem; color:#64748b;">â€»è¤‡æ•°æšé¸æŠãƒ»é€£ç¶šè¿½åŠ ãŒå¯èƒ½ã§ã™</p>
        <input type="file" id="fileInput" multiple accept="image/*" onchange="addFiles(this)" style="display: none;">
    </label>

    <div id="thumb-list"></div>
    <div id="timer">0.0s</div>

    <button id="runBtn" class="btn" onclick="runAI()">ğŸš€ å›³é¢ã‚’çµ±åˆè§£æã™ã‚‹</button>

    <div id="status-area"></div>

    <div id="reason-box" class="reason-box">
        <strong>ğŸ§ AIã®è§£æãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ¤œè¨¼ç”¨ï¼‰:</strong><br>
        <div id="ai-reasoning"></div>
    </div>

    <div id="result-area" class="result-section">
        <h3>ğŸ“ ç”Ÿæˆã•ã‚ŒãŸå±‹æ ¹ä¼å›³</h3>
        <div class="svg-box" id="svg-output"></div>
        
        <h3>ğŸ“‹ ç©ç®—ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆ</h3>
        <table id="result-table">
            <thead><tr><th>éƒ¨ä½</th><th>é …ç›®å</th><th>é•·ã•(mm)</th><th>AIã®åˆ¤æ–­æ ¹æ‹ </th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    let files = [];
    let timer;

    window.onload = () => {
        const key = localStorage.getItem('gemini_25_strict_key');
        if(key) document.getElementById('apiKey').value = key;
    };

    function addFiles(input) {
        const newFiles = Array.from(input.files);
        files = files.concat(newFiles);
        const list = document.getElementById('thumb-list');
        list.innerHTML = '';
        files.forEach(f => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = document.createElement('img');
                img.src = e.target.result; img.className = 'thumb';
                list.appendChild(img);
            };
            reader.readAsDataURL(f);
        });
    }

    async function runAI() {
        const key = document.getElementById('apiKey').value;
        if(!key || files.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ã‚’é¸æŠã—ã¦ãã ã•ã„");
        localStorage.setItem('gemini_25_strict_key', key);

        const status = document.getElementById('status-area');
        const runBtn = document.getElementById('runBtn');
        runBtn.disabled = true;
        status.style.display = 'block';
        status.style.background = '#fef3c7';
        status.innerText = "ç«‹é¢å›³ã¨å¹³é¢å›³ã‚’ç…§åˆä¸­... (ç´„40-60ç§’)";

        let sec = 0;
        clearInterval(timer);
        timer = setInterval(() => { sec += 0.1; document.getElementById('timer').innerText = `${sec.toFixed(1)}s`; }, 100);

        try {
            const b64s = await Promise.all(files.map(f => resize(f)));
            
            // æŒ‡ç¤ºï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼‰ã®å¼·åŒ–ï¼šç«‹é¢å›³å„ªå…ˆãƒ»ãƒãƒ«ã‚³ãƒ‹ãƒ¼é™¤å¤–
            const prompt = `ã‚ãªãŸã¯ãƒ—ãƒ­ã®å±‹æ ¹ç©ç®—å£«ã§ã™ã€‚æä¾›ã•ã‚ŒãŸè¤‡æ•°ã®å›³é¢ã‚’ç…§åˆã—ã€æ­£ç¢ºãªç©ç®—ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

ã€å³å®ˆäº‹é …ã€‘
1. è»’ã®å‡ºã®åˆ¤å®š: å¹³é¢å›³ã«ã‚ã‚‹ãƒãƒ«ã‚³ãƒ‹ãƒ¼ã®å‡ºå¹…ï¼ˆ900mmç­‰ï¼‰ã«æƒ‘ã‚ã•ã‚Œãªã„ã§ãã ã•ã„ã€‚ç«‹é¢å›³ã«ç¤ºã•ã‚Œã¦ã„ã‚‹ã€Œå£èŠ¯ã‹ã‚‰è»’å…ˆã¾ã§ã€ã®å¯¸æ³•ï¼ˆä¾‹: 275mmï¼‰ã‚’å±‹æ ¹ã®æ­£è§£ã¨ã—ã¦æ¡ç”¨ã—ã¦ãã ã•ã„ã€‚
2. å‹¾é…ã®åˆ¤å®š: ç«‹é¢å›³ã«è¨˜è¼‰ã•ã‚ŒãŸå‹¾é…ä¿‚æ•°ï¼ˆ3.5å¯¸ãªã©ï¼‰ã‚’åŸºæº–ã«ã—ã¦ãã ã•ã„ã€‚
3. è§£æãƒ—ãƒ­ã‚»ã‚¹: ã¾ãšç«‹é¢å›³ã§æ–­é¢å¯¸æ³•ã‚’ç¢ºå®šã•ã›ã€ãã‚Œã‚’å¹³é¢å›³ã®å±‹æ ¹ãƒ©ã‚¤ãƒ³ã«é©ç”¨ã—ã¦ãã ã•ã„ã€‚

ã€å‡ºåŠ›ã€‘
1. è§£æã®æ ¹æ‹ : ãªãœãã®æ•°å€¤ã‚’é¸ã‚“ã ã‹æ—¥æœ¬èªã§è§£èª¬ã€‚
2. å±‹æ ¹ä¼å›³(SVG): å¢ƒç•Œç·šã¨å¯¸æ³•ã€‚èƒŒæ™¯é€æ˜ã€ç™½ç·šã€‚
3. ç©ç®—JSON: %%%JSON_START%%% {"items": [{"type": "éƒ¨ä½", "name": "åç§°", "length_mm": 1000, "note": "æ ¹æ‹ "}]} %%%JSON_END%%%`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }, ...b64s.map(b => ({ inline_data: { mime_type: "image/jpeg", data: b } }))]
                    }]
                })
            });

            const data = await response.json();
            clearInterval(timer);
            if (data.error) throw new Error(data.error.message);

            const text = data.candidates[0].content.parts[0].text;
            
            // æ ¹æ‹ ã®æŠ½å‡º
            const reasonText = text.split('%%%')[0];
            document.getElementById('ai-reasoning').innerText = reasonText;
            document.getElementById('reason-box').style.display = 'block';

            // SVGã¨JSONã®æŠ½å‡º
            const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/);
            const jsonMatch = text.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);

            if(svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];
            if(jsonMatch) {
                const items = JSON.parse(jsonMatch[1]).items;
                document.getElementById('table-body').innerHTML = items.map(it => `<tr><td><b>${it.type}</b></td><td>${it.name}</td><td>${it.length_mm.toLocaleString()}</td><td>${it.note}</td></tr>`).join('');
            }
            
            document.getElementById('result-area').style.display = 'block';
            status.style.background = '#dcfce7';
            status.innerText = "âœ… ç²¾å¯†è§£æå®Œäº†";
        } catch (e) {
            clearInterval(timer);
            status.style.background = '#fee2e2';
            status.innerText = "âŒ ã‚¨ãƒ©ãƒ¼: " + e.message;
        } finally { runBtn.disabled = false; }
    }

    function resize(f) {
        return new Promise(res => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = e => {
                const i = new Image(); i.src = e.target.result;
                i.onload = () => {
                    const c = document.createElement('canvas');
                    const m = 1400; const s = Math.min(1, m/Math.max(i.width, i.height));
                    c.width = i.width*s; c.height = i.height*s;
                    c.getContext('2d').drawImage(i,0,0,c.width,c.height);
                    res(c.toDataURL('image/jpeg', 0.85).split(',')[1]);
                };
            };
        });
    }
</script>
</body>
</html>
