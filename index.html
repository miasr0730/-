<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±‹æ ¹ç©ç®— AI - å„è¾ºå€‹åˆ¥ç‰¹å®šã‚¨ãƒ‡ã‚£ã‚·ãƒ§ãƒ³</title>
    <style>
        :root { --primary: #0284c7; --bg: #f8fafc; }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg); padding: 20px; color: #1e293b; line-height: 1.6; }
        .container { background: white; padding: 24px; border-radius: 12px; max-width: 800px; margin: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .api-input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; margin-bottom: 16px; box-sizing: border-box; }
        .upload-area { border: 2px dashed var(--primary); padding: 30px; text-align: center; border-radius: 12px; background: #f0f9ff; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { background: #e0f2fe; }
        #thumb-list { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .thumb-wrapper { position: relative; width: 80px; height: 80px; border: 1px solid #e2e8f0; border-radius: 6px; overflow: hidden; }
        .thumb { width: 100%; height: 100%; object-fit: cover; }
        .del-btn { position: absolute; top: 2px; right: 2px; background: rgba(239, 68, 68, 0.9); color: white; border-radius: 50%; width: 20px; height: 20px; border: none; font-size: 12px; cursor: pointer; }
        .btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #0369a1; }
        #result-area { margin-top: 30px; display: none; }
        .svg-container { background: #0f172a; padding: 20px; border-radius: 12px; display: flex; justify-content: center; margin-bottom: 20px; }
        svg { max-width: 100%; height: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f1f5f9; padding: 12px; text-align: left; font-size: 0.85rem; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .logic-box { background: #f8fafc; border-left: 4px solid var(--primary); padding: 15px; font-size: 0.9rem; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="margin-top:0;">ğŸ  å±‹æ ¹å„è¾ºå¯¸æ³•ãƒ»ç©ç®—AI</h2>
    <input type="password" id="apiKey" class="api-input" placeholder="Gemini API Key ã‚’å…¥åŠ›">

    <div class="upload-area" onclick="document.getElementById('fileInput').click()">
        <strong>ğŸ“ å›³é¢ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong>
        <p style="font-size:0.8rem; color:#64748b;">å¹³é¢å›³ãƒ»ç«‹é¢å›³ï¼ˆå…¨æ–¹ä½ï¼‰ã‚’è¤‡æ•°é¸æŠã—ã¦ãã ã•ã„</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none;" onchange="handleFiles(this)">
    </div>

    <div id="thumb-list"></div>
    <button id="runBtn" class="btn" onclick="analyze()">å›³é¢ã‚’è§£æã—ã¦å„è¾ºã‚’ç‰¹å®š</button>
    <div id="status" style="display:none; text-align:center; margin-top:15px; font-weight:bold; color:var(--primary);"></div>

    <div id="result-area">
        <div class="svg-container" id="svg-output"></div>
        <div class="logic-box" id="logic-output"></div>
        <table>
            <thead><tr><th>ç‰¹å®šã•ã‚ŒãŸè¾ºã®åç§°</th><th>ç®—å‡ºå¯¸æ³• (mm)</th></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    let files = [];

    function handleFiles(input) {
        Array.from(input.files).forEach(file => {
            files.push(file);
            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div');
                div.className = 'thumb-wrapper';
                div.innerHTML = `<img src="${e.target.result}" class="thumb"><button class="del-btn" onclick="removeFile(this)">Ã—</button>`;
                document.getElementById('thumb-list').appendChild(div);
            };
            reader.readAsDataURL(file);
        });
        document.getElementById('runBtn').innerText = `è§£æå®Ÿè¡Œï¼ˆ${files.length}æšã®å›³é¢ï¼‰`;
    }

    function removeFile(btn) {
        const index = Array.from(btn.parentElement.parentElement.children).indexOf(btn.parentElement);
        files.splice(index, 1);
        btn.parentElement.remove();
        document.getElementById('runBtn').innerText = `è§£æå®Ÿè¡Œï¼ˆ${files.length}æšã®å›³é¢ï¼‰`;
    }

    async function analyze() {
        const key = document.getElementById('apiKey').value;
        if(!key || files.length === 0) return alert("APIã‚­ãƒ¼ã¨å›³é¢ãŒå¿…è¦ã§ã™");

        const status = document.getElementById('status');
        status.style.display = "block";
        status.innerText = "ğŸ” å…¨æ–¹ä½ã®å›³é¢ã‚’ç…§åˆã—ã€å„è¾ºã®é•·ã•ã‚’ç®—å‡ºä¸­...";

        try {
            const images = await Promise.all(files.map(f => toBase64(f)));
            const prompt = `ã‚ãªãŸã¯ç²¾å¯†ç©ç®—å£«ã§ã™ã€‚å±‹æ ¹ã®åˆè¨ˆé¢ç©ã‚„å¤–å¯¸åˆè¨ˆã§ã¯ãªãã€å±‹æ ¹å¹³é¢å›³ã«ãŠã‘ã‚‹ã€Œå„è¾ºã®é•·ã•ã€ã‚’1æœ¬ãšã¤ãƒŸãƒªå˜ä½ã§ç‰¹å®šã—ã¦ãã ã•ã„ã€‚

### ã€è§£æãƒ»ç…§åˆã®å³æ ¼ãƒ«ãƒ¼ãƒ«ã€‘
1. **å¤–å£ãƒ©ã‚¤ãƒ³ã®ç‰¹å®š**: å¹³é¢å›³ã‹ã‚‰å»ºç‰©å¤–éƒ­ï¼ˆå¤–å£å¤–é¢ï¼‰ã®å¯¸æ³•ã‚’èª­ã¿å–ã‚Œã€‚
2. **ã€Œå‡ºï¼ˆã§ï¼‰ã€ã®å€‹åˆ¥åˆ¤å®š**: 
   - ç«‹é¢å›³ï¼ˆæ±ãƒ»è¥¿ãƒ»å—ãƒ»åŒ—ï¼‰ã‹ã‚‰ã€å¤–å£å¤–é¢ã‹ã‚‰å±‹æ ¹ç«¯ã¾ã§ã®ã€Œè»’ã®å‡ºã€ã€Œã‚±ãƒ©ãƒã®å‡ºã€ã‚’å€‹åˆ¥ã«ç‰¹å®šã›ã‚ˆã€‚
   - ãƒãƒ«ã‚³ãƒ‹ãƒ¼ä¸Šç©ºã«å±‹æ ¹ãŒã‹ã‹ã£ã¦ã„ã‚‹å ´åˆã€ç«‹é¢å›³ã®å‚ç›´ãƒ©ã‚¤ãƒ³ã‚’åŸºæº–ã«ã€å±‹æ ¹ãŒã©ã“ã¾ã§çªãå‡ºã—ã¦ã„ã‚‹ã‹æ­£ç¢ºã«æ¸¬ã‚Œã€‚
3. **è¾ºã®ç®—å‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
   - è»’å…ˆè¾ºï¼ˆæ±è¥¿æ–¹å‘ã®ãƒ©ã‚¤ãƒ³ï¼‰ = å»ºç‰©å¹… ï¼‹ï¼ˆå·¦å´ã®ã‚±ãƒ©ãƒã®å‡º ï¼‹ å³å´ã®ã‚±ãƒ©ãƒã®å‡ºï¼‰
   - ã‚±ãƒ©ãƒè¾ºï¼ˆå—åŒ—æ–¹å‘ã®ãƒ©ã‚¤ãƒ³ â€»å¹³é¢æŠ•å½±ï¼‰ = å»ºç‰©å¥¥è¡Œ ï¼‹ï¼ˆä¸Šå´ã®è»’ã®å‡º ï¼‹ ä¸‹å´ã®è»’ã®å‡ºï¼‰
   - æŠ˜ã‚Œæ›²ãŒã‚ŠãŒã‚ã‚‹å ´åˆã¯ã€ã™ã¹ã¦ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å€‹åˆ¥ã«ç®—å‡ºã›ã‚ˆã€‚

### ã€å‡ºåŠ›å†…å®¹ã€‘
- **è§£æãƒ­ã‚°**: ã€Œå—å´ã®è»’å…ˆè¾ºï¼šå»ºç‰©å¹…11475mm ï¼‹ æ±ã‚±ãƒ©ãƒ275mm ï¼‹ è¥¿ã‚±ãƒ©ãƒ275mm ï¼ 12025mmã€ã®ã‚ˆã†ã«ã€ã™ã¹ã¦ã®è¾ºã«å¯¾ã—ã¦è¨ˆç®—æ ¹æ‹ ã‚’æ˜è¨˜ã›ã‚ˆã€‚
- **å±‹æ ¹ä¼å›³(SVG)**: èƒŒæ™¯é€æ˜ã€ç·šã¯ç™½ã€‚å»ºç‰©ãƒ©ã‚¤ãƒ³ï¼ˆç ´ç·šï¼‰ã¨å±‹æ ¹ãƒ©ã‚¤ãƒ³ï¼ˆå®Ÿç·šï¼‰ã‚’æãã€å„è¾ºã®æ¨ªã«ã€ŒL=ã€‡ã€‡mmã€ã¨å¯¸æ³•ã‚’æ›¸ãè¾¼ã‚ã€‚
- **ãƒ‡ãƒ¼ã‚¿å½¢å¼**: æœ€å¾Œã«å¿…ãšä»¥ä¸‹ã®JSONã‚’ä»˜ã‘ã‚ã€‚
%%%JSON_START%%% {"items": [{"name": "å—å´è»’å…ˆè¾º", "value": "12025mm"}, ...]} %%%JSON_END%%%`;

            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, ...images.map(img => ({ inline_data: { mime_type: "image/jpeg", data: img } }))] }] })
            });

            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text;

            document.getElementById('result-area').style.display = 'block';
            document.getElementById('logic-output').innerText = text.split('%%%')[0];
            
            const svgMatch = text.match(/<svg[\s\S]*?<\/svg>/);
            if(svgMatch) document.getElementById('svg-output').innerHTML = svgMatch[0];

            const jsonMatch = text.match(/%%%JSON_START%%%([\s\S]*?)%%%JSON_END%%%/);
            if(jsonMatch) {
                const items = JSON.parse(jsonMatch[1]).items;
                document.getElementById('table-body').innerHTML = items.map(i => `<tr><td>${i.name}</td><td>${i.value}</td></tr>`).join('');
            }
            status.style.display = "none";
        } catch (e) {
            status.innerText = "âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å›³é¢ã®é®®æ˜åº¦ã‚„APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        }
    }

    function toBase64(file) {
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const max = 1600;
                    const scale = Math.min(1, max / Math.max(img.width, img.height));
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                };
            };
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>
